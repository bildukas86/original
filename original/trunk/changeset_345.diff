Index: /trunk/aCis_datapack/data/html/admin/manor.htm
===================================================================
--- /trunk/aCis_datapack/data/html/admin/manor.htm	(revision 345)
+++ /trunk/aCis_datapack/data/html/admin/manor.htm	(revision 345)
@@ -0,0 +1,19 @@
+<html><body><center>
+	<font color="LEVEL">[Manor System]</font><br>
+	<table width="100%">
+		<tr><td>Disabled: %disabled%</td><td>Under Maintenance: %maintenance%</td></tr>
+		<tr><td>Time to refresh: %refresh%</td><td>Time to approve: %approve%</td></tr>
+	</table>
+	
+	<table>
+		<tr><td><button value="Set Next" action="bypass -h admin_manor_setnext" width=110 height=15 back="sek.cbui94" fore="sek.cbui92"></td><td><button value="Approve Next" action="bypass -h admin_manor_approve" width=110 height=15 back="sek.cbui94" fore="sek.cbui92"></td></tr>
+		<tr><td><button value="%value1%" action="bypass -h admin_manor_setmaintenance" width=110 height=15 back="sek.cbui94" fore="sek.cbui92"></td><td><button value="%value2%" action="bypass -h admin_manor_disable" width=110 height=15 back="sek.cbui94" fore="sek.cbui92"></td></tr>
+		<tr><td><button value="Refresh" action="bypass -h admin_manor" width=110 height=15 back="sek.cbui94" fore="sek.cbui92"></td><td><button value="Back" action="bypass -h admin_admin" width=110 height=15 back="sek.cbui94" fore="sek.cbui92"></td></tr>
+	</table><br>
+	
+	Castle Information:
+	<table width="100%">
+		<tr><td></td><td>Current Period</td><td>Next Period</td></tr>
+		%castles%
+	</table>
+</center></body></html>
Index: unk/aCis_datapack/data/html/admin/mobgrouphelp.htm
===================================================================
--- /trunk/aCis_datapack/data/html/admin/mobgrouphelp.htm	(revision 344)
+++ 	(revision )
@@ -1,36 +1,0 @@
-<html><body>
-<center>
-<table width=260>
-<tr>
-<td width=40><button value="Main" action="bypass -h admin_admin" width=45 height=15 back="sek.cbui94" fore="sek.cbui92"></td>
-<td width=180>Mob Group Control Instructions</td>
-<td width=40><button value="Back" action="bypass -h admin_mobmenu" width=45 height=15 back="sek.cbui94" fore="sek.cbui92"></td>
-</tr>
-</table><br>
-</center>
-<font color="LEVEL">//mobgroup_create</font> [groupId] [npcId] [number]<br>
-Creates a group with [number] mobs of type [npcId], in the group [groupId].<br>
-There is no visual effect using this command, and the members of this group need to be spawned to become active.<br><br>
-<font color="LEVEL">//mobgroup_remove</font> [groupId]<br>
-Removes/deletes the group [groupId], subsequently unspawning any group members still alive.<br><br>
-<font color="LEVEL">//mobgroup_spawn</font> [groupId] [locx] [locy] [locz]<br>
-Spawns the members of group [groupId]. If a location isn't specified, the group will be spawned around the GM.<br>
-By default, mobs are in an idle state, and await further commands.<br>
-<font color="LEVEL">//mobgroup_unspawn</font> [groupId]<br>
-Unspawns the members of group [groupId]. The group is not deleted and can be invoked by the use of //mobgroup_spawn once more.<br>
-<font color="LEVEL">//mobgroup_list</font> ([groupId])<br>
-Lists all created monster groups. If [groupId] is specified, then a list of the members of that group is displayed.<br>
-<img src="L2UI.SquareGray" width="200" height="1"><br>
-<font color="999999">Other Commands</font><br>
-<font color="LEVEL">//mobgroup_follow</font> [groupId] - The group [groupId] will follow the GM.<br>
-<font color="LEVEL">//mobgroup_return</font> [groupId] - The group [groupId] will return to the GM.<br>
-<font color="LEVEL">//mobgroup_teleport</font> [groupId] ([playerName]) - The group [groupId] will be teleport to and follow the specified player (or the GM if none specified).<br>
-<font color="LEVEL">//mobgroup_attack</font> [groupId] - The group [groupId] will attack the GM's current target (if any).<br>
-<font color="LEVEL">//mobgroup_rnd</font> [groupId] - The group [groupId] will attack a randomly selected targets.<br>
-<font color="LEVEL">//mobgroup_attackgrp</font> [groupId1] [groupId2] - The group [groupId1] will attack the members in [groupId2].<br>
-<font color="LEVEL">//mobgroup_casting</font> [groupId] - The group [groupId] mobs will only use their skills to attack.<br>
-<font color="LEVEL">//mobgroup_nomove</font> [groupId] [on/off] - Toggle the mobs of group [groupId] to no longer move. Interesting when used with casting-only mode.<br>
-<font color="LEVEL">//mobgroup_invul</font> [groupId] [on/off] - Toggle the mobs of group [groupId] to be invulnerable.<br>
-<font color="LEVEL">//mobgroup_idle</font> [groupId] - Return the mobs in group [groupId] to an idle (waiting) state.<br>
-<font color="LEVEL">//mobgroup_kill</font> [groupId] - Kills all alive mobs in group [groupId].<br>
-</body></html>
Index: unk/aCis_datapack/data/html/admin/mobgroup.htm
===================================================================
--- /trunk/aCis_datapack/data/html/admin/mobgroup.htm	(revision 344)
+++ 	(revision )
@@ -1,41 +1,0 @@
-<html><title>Mob Groups</title><body>
-<center>
-<table width=260>
-<tr>
-<td width=40><button value="Main" action="bypass -h admin_admin" width=45 height=15 back="sek.cbui94" fore="sek.cbui92"></td>
-<td width=180>Mob Group Control Menu</td>
-<td width=40><button value="Main" action="bypass -h admin_admin" width=45 height=15 back="sek.cbui94" fore="sek.cbui92"></td>
-</tr>
-</table><br>
-<table width=200>
-<tr>
-<td>
-<button value="Create" action="bypass -h admin_mobgroup_create $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Spawn" action="bypass -h admin_mobgroup_spawn $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92"> 
-<button value="Unspawn" action="bypass -h admin_mobgroup_unspawn $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Remove/Delete" action="bypass -h admin_mobgroup_remove $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="List All" action="bypass -h admin_list_groups $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<br>
-<button value="Attack Target" action="bypass -h admin_mobgroup_attack $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Attack Group" action="bypass -h admin_mobgroup_attackgrp" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Attack Random" action="bypass -h admin_mobgroup_rnd" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-</td>
-<td>
-<button value="Return" action="bypass -h admin_mobgroup_return $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Follow" action="bypass -h admin_mobgroup_follow $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Teleport" action="bypass -h admin_mobgroup_teleport $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Kill" action="bypass -h admin_mobgroup_kill $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Set Invul" action="bypass -h admin_mobgroup_invul" width=90 height=15 back="sek.cbui94" fore="sek.cbui92"> 
-<br>
-<button value="Set Idle" action="bypass -h admin_mobgroup_idle $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Set No Move" action="bypass -h admin_mobgroup_nomove $menu_command" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<button value="Set Cast Only" action="bypass -h admin_mobgroup_casting" width=90 height=15 back="sek.cbui94" fore="sek.cbui92">
-<br>
-</td>
-</tr>
-</table><br>
-<table>
-<tr><td><button value="Instructions" action="bypass -h admin_mobinst" width=90 height=15 back="sek.cbui94" fore="sek.cbui92"></td></tr>
-</table><br>
-Mob Control Parameters:<edit var="menu_command" width=100 height=15><br>
-</body></html>
Index: /trunk/aCis_datapack/data/scripts/custom/VarkaSilenosSupport/VarkaSilenosSupport.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/custom/VarkaSilenosSupport/VarkaSilenosSupport.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/custom/VarkaSilenosSupport/VarkaSilenosSupport.java	(revision 345)
@@ -15,4 +15,5 @@
 package custom.VarkaSilenosSupport;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.SkillTable;
 import net.sf.l2j.gameserver.datatables.SkillTable.FrequentSkill;
@@ -30,5 +31,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.ActionFailed;
 import net.sf.l2j.gameserver.network.serverpackets.WarehouseWithdrawList;
-import net.sf.l2j.gameserver.util.Util;
 
 /**
@@ -151,5 +151,5 @@
 			return htmltext;
 		
-		if (Util.isDigit(event))
+		if (StringUtil.isDigit(event))
 		{
 			final int[] buffInfo = BUFF[Integer.parseInt(event)];
Index: /trunk/aCis_datapack/data/scripts/custom/RaidbossInfo/RaidbossInfo.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/custom/RaidbossInfo/RaidbossInfo.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/custom/RaidbossInfo/RaidbossInfo.java	(revision 345)
@@ -18,4 +18,5 @@
 import java.util.Map;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.NpcTable;
 import net.sf.l2j.gameserver.datatables.SpawnTable;
@@ -27,5 +28,4 @@
 import net.sf.l2j.gameserver.model.quest.Quest;
 import net.sf.l2j.gameserver.model.quest.QuestState;
-import net.sf.l2j.gameserver.util.Util;
 
 /**
@@ -50,40 +50,4 @@
 		31737,
 		31738,
-		31739,
-		31740,
-		31741,
-		31742,
-		31743,
-		31744,
-		31745,
-		31746,
-		31747,
-		31748,
-		31749,
-		31750,
-		31751,
-		31752,
-		31753,
-		31754,
-		31755,
-		31756,
-		31757,
-		31758,
-		31759,
-		31760,
-		31761,
-		31762,
-		31763,
-		31764,
-		31765,
-		31766,
-		31767,
-		31768,
-		31769,
-		31770,
-		31771,
-		31772,
-		31773,
-		31774,
 		31775,
 		31776,
@@ -186,5 +150,5 @@
 			return event;
 		
-		if (Util.isDigit(event))
+		if (StringUtil.isDigit(event))
 		{
 			int rbid = Integer.parseInt(event);
Index: /trunk/aCis_datapack/data/scripts/custom/EchoCrystals/EchoCrystals.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/custom/EchoCrystals/EchoCrystals.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/custom/EchoCrystals/EchoCrystals.java	(revision 345)
@@ -18,9 +18,9 @@
 import java.util.Map;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.quest.Quest;
 import net.sf.l2j.gameserver.model.quest.QuestState;
-import net.sf.l2j.gameserver.util.Util;
 
 /**
@@ -60,5 +60,5 @@
 		QuestState st = player.getQuestState(qn);
 		
-		if (st != null && Util.isDigit(event))
+		if (st != null && StringUtil.isDigit(event))
 		{
 			int score = Integer.parseInt(event);
Index: /trunk/aCis_datapack/data/scripts/custom/NpcLocationInfo/NpcLocationInfo.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/custom/NpcLocationInfo/NpcLocationInfo.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/custom/NpcLocationInfo/NpcLocationInfo.java	(revision 345)
@@ -15,4 +15,5 @@
 package custom.NpcLocationInfo;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.SpawnTable;
 import net.sf.l2j.gameserver.model.L2Spawn;
@@ -221,5 +222,5 @@
 			return htmltext;
 		
-		if (Util.isDigit(event))
+		if (StringUtil.isDigit(event))
 		{
 			htmltext = null;
Index: /trunk/aCis_datapack/data/scripts/custom/KetraOrcSupport/KetraOrcSupport.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/custom/KetraOrcSupport/KetraOrcSupport.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/custom/KetraOrcSupport/KetraOrcSupport.java	(revision 345)
@@ -15,4 +15,5 @@
 package custom.KetraOrcSupport;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.SkillTable;
 import net.sf.l2j.gameserver.datatables.SkillTable.FrequentSkill;
@@ -30,5 +31,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.ActionFailed;
 import net.sf.l2j.gameserver.network.serverpackets.WarehouseWithdrawList;
-import net.sf.l2j.gameserver.util.Util;
 
 /**
@@ -152,5 +152,5 @@
 			return htmltext;
 		
-		if (Util.isDigit(event))
+		if (StringUtil.isDigit(event))
 		{
 			final int[] buffInfo = BUFF[Integer.parseInt(event)];
Index: /trunk/aCis_datapack/data/scripts/quests/Q631_DeliciousTopChoiceMeat/Q631_DeliciousTopChoiceMeat.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q631_DeliciousTopChoiceMeat/Q631_DeliciousTopChoiceMeat.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q631_DeliciousTopChoiceMeat/Q631_DeliciousTopChoiceMeat.java	(revision 345)
@@ -16,9 +16,9 @@
 import java.util.Map;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.quest.Quest;
 import net.sf.l2j.gameserver.model.quest.QuestState;
-import net.sf.l2j.gameserver.util.Util;
 
 public class Q631_DeliciousTopChoiceMeat extends Quest
@@ -125,5 +125,5 @@
 			}
 		}
-		else if (Util.isDigit(event))
+		else if (StringUtil.isDigit(event))
 		{
 			if (st.getQuestItemsCount(TOP_QUALITY_MEAT) >= 120)
Index: /trunk/aCis_datapack/data/scripts/quests/Q220_TestimonyOfGlory/Q220_TestimonyOfGlory.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q220_TestimonyOfGlory/Q220_TestimonyOfGlory.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q220_TestimonyOfGlory/Q220_TestimonyOfGlory.java	(revision 345)
@@ -654,5 +654,5 @@
 				}
 				break;
-				
+			
 			case REVENANT_OF_TANTOS_CHIEF:
 				if (cond == 9)
@@ -690,20 +690,20 @@
 					st.set("cond", "2");
 				break;
-				
+			
 			case GUARDIAN_BASILISK:
 				if (cond == 1 && st.dropItems(GUARDIAN_BASILISK_FANG, 1, 10, 500000) && st.getQuestItemsCount(TYRANT_TALON) + st.getQuestItemsCount(MANASHEN_SHARD) == 20)
 					st.set("cond", "2");
 				break;
-				
+			
 			case MANASHEN_GARGOYLE:
 				if (cond == 1 && st.dropItems(MANASHEN_SHARD, 1, 10, 750000) && st.getQuestItemsCount(TYRANT_TALON) + st.getQuestItemsCount(GUARDIAN_BASILISK_FANG) == 20)
 					st.set("cond", "2");
 				break;
-				
+			
 			case MARSH_STAKATO_DRONE:
 				if (st.hasQuestItems(DRIKO_CONTRACT))
 					st.dropItems(STAKATO_DRONE_HUSK, 1, 30, 750000);
 				break;
-				
+			
 			case PASHIKA_SON_OF_VOLTAR:
 				if (st.hasQuestItems(GLOVE_OF_VOLTAR) && !st.hasQuestItems(PASHIKA_HEAD))
@@ -719,5 +719,5 @@
 				}
 				break;
-				
+			
 			case VULTUS_SON_OF_VOLTAR:
 				if (st.hasQuestItems(GLOVE_OF_VOLTAR) && !st.hasQuestItems(VULTUS_HEAD))
@@ -733,15 +733,15 @@
 				}
 				break;
-				
+			
 			case ENKU_ORC_OVERLORD:
 				if (st.hasQuestItems(GLOVE_OF_KEPRA) && st.dropItemsAlways(ENKU_OVERLORD_HEAD, 1, 4))
 					st.takeItems(GLOVE_OF_KEPRA, 1);
 				break;
-				
+			
 			case MAKUM_BUGBEAR_THUG:
 				if (st.hasQuestItems(GLOVE_OF_BURAI) && st.dropItemsAlways(MAKUM_BUGBEAR_HEAD, 1, 2))
 					st.takeItems(GLOVE_OF_BURAI, 1);
 				break;
-				
+			
 			case TIMAK_ORC:
 			case TIMAK_ORC_ARCHER:
@@ -753,15 +753,15 @@
 					st.set("cond", "7");
 				break;
-				
+			
 			case TAMLIN_ORC:
 				if (cond == 6 && st.dropItems(TAMLIN_ORC_SKULL, 1, 20, 500000) && st.getQuestItemsCount(TIMAK_ORC_HEAD) == 20)
 					st.set("cond", "7");
 				break;
-				
+			
 			case TAMLIN_ORC_ARCHER:
 				if (cond == 6 && st.dropItems(TAMLIN_ORC_SKULL, 1, 20, 600000) && st.getQuestItemsCount(TIMAK_ORC_HEAD) == 20)
 					st.set("cond", "7");
 				break;
-				
+			
 			case RAGNA_ORC_OVERLORD:
 			case RAGNA_ORC_SEER:
@@ -772,5 +772,5 @@
 				}
 				break;
-				
+			
 			case REVENANT_OF_TANTOS_CHIEF:
 				if (cond == 9 && st.dropItemsAlways(SCEPTER_OF_TANTOS, 1, 1))
Index: /trunk/aCis_datapack/data/scripts/quests/Q419_GetAPet/Q419_GetAPet.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q419_GetAPet/Q419_GetAPet.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q419_GetAPet/Q419_GetAPet.java	(revision 345)
@@ -15,8 +15,6 @@
 package quests.Q419_GetAPet;
 
-import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.HashMap;
-import java.util.List;
 import java.util.Map;
 
@@ -279,17 +277,4 @@
 	}
 	
-	private static String join(List<String> list)
-	{
-		StringBuilder sb = new StringBuilder();
-		String loopDelim = "";
-		for (String s : list)
-		{
-			sb.append(loopDelim);
-			sb.append(s);
-			loopDelim = " ";
-		}
-		return sb.toString();
-	}
-	
 	private static String checkQuestions(QuestState st)
 	{
@@ -304,8 +289,6 @@
 			{
 				questions[index] = questions[questions.length - 1];
-				List<String> list = new ArrayList<>(Arrays.asList(questions));
-				list.remove(questions.length - 1);
-				questions = list.toArray(questions);
-				st.set("quiz", join(list));
+				
+				st.set("quiz", String.join(" ", Arrays.copyOf(questions, questions.length - 1)));
 			}
 			return "30731-" + question + ".htm";
Index: /trunk/aCis_datapack/data/scripts/quests/Q384_WarehouseKeepersPastime/Q384_WarehouseKeepersPastime.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q384_WarehouseKeepersPastime/Q384_WarehouseKeepersPastime.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q384_WarehouseKeepersPastime/Q384_WarehouseKeepersPastime.java	(revision 345)
@@ -16,4 +16,5 @@
 import java.util.Map;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
@@ -244,5 +245,5 @@
 			{
 				st.set("bet", "10");
-				st.set("board", Util.scrambleString("123456789"));
+				st.set("board", StringUtil.scrambleString("123456789"));
 				st.takeItems(MEDAL, 10);
 			}
@@ -255,5 +256,5 @@
 			{
 				st.set("bet", "100");
-				st.set("board", Util.scrambleString("123456789"));
+				st.set("board", StringUtil.scrambleString("123456789"));
 				st.takeItems(MEDAL, 100);
 			}
Index: /trunk/aCis_datapack/data/scripts/quests/Q645_GhostsOfBatur/Q645_GhostsOfBatur.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q645_GhostsOfBatur/Q645_GhostsOfBatur.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q645_GhostsOfBatur/Q645_GhostsOfBatur.java	(revision 345)
@@ -13,9 +13,9 @@
 package quests.Q645_GhostsOfBatur;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.quest.Quest;
 import net.sf.l2j.gameserver.model.quest.QuestState;
-import net.sf.l2j.gameserver.util.Util;
 
 public class Q645_GhostsOfBatur extends Quest
@@ -82,5 +82,5 @@
 			st.playSound(QuestState.SOUND_ACCEPT);
 		}
-		else if (Util.isDigit(event))
+		else if (StringUtil.isDigit(event))
 		{
 			htmltext = "32017-07.htm";
Index: /trunk/aCis_datapack/data/scripts/quests/Q508_AClansReputation/Q508_AClansReputation.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q508_AClansReputation/Q508_AClansReputation.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q508_AClansReputation/Q508_AClansReputation.java	(revision 345)
@@ -13,4 +13,5 @@
 package quests.Q508_AClansReputation;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.L2Clan;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
@@ -21,5 +22,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.PledgeShowInfoUpdate;
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
-import net.sf.l2j.gameserver.util.Util;
 import net.sf.l2j.util.Rnd;
 
@@ -143,5 +143,5 @@
 			return htmltext;
 		
-		if (Util.isDigit(event))
+		if (StringUtil.isDigit(event))
 		{
 			htmltext = "30868-" + event + ".htm";
Index: /trunk/aCis_datapack/data/scripts/quests/Q644_GraveRobberAnnihilation/Q644_GraveRobberAnnihilation.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q644_GraveRobberAnnihilation/Q644_GraveRobberAnnihilation.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q644_GraveRobberAnnihilation/Q644_GraveRobberAnnihilation.java	(revision 345)
@@ -13,9 +13,9 @@
 package quests.Q644_GraveRobberAnnihilation;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.quest.Quest;
 import net.sf.l2j.gameserver.model.quest.QuestState;
-import net.sf.l2j.gameserver.util.Util;
 
 public class Q644_GraveRobberAnnihilation extends Quest
@@ -84,5 +84,5 @@
 			st.playSound(QuestState.SOUND_ACCEPT);
 		}
-		else if (Util.isDigit(event))
+		else if (StringUtil.isDigit(event))
 		{
 			htmltext = "32017-04.htm";
Index: /trunk/aCis_datapack/data/scripts/quests/Q617_GatherTheFlames/Q617_GatherTheFlames.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q617_GatherTheFlames/Q617_GatherTheFlames.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q617_GatherTheFlames/Q617_GatherTheFlames.java	(revision 345)
@@ -16,9 +16,9 @@
 import java.util.Map;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.quest.Quest;
 import net.sf.l2j.gameserver.model.quest.QuestState;
-import net.sf.l2j.gameserver.util.Util;
 import net.sf.l2j.util.Rnd;
 
@@ -122,5 +122,5 @@
 			st.exitQuest(true);
 		}
-		else if (Util.isDigit(event))
+		else if (StringUtil.isDigit(event))
 		{
 			if (st.getQuestItemsCount(TORCH) >= 1200)
Index: /trunk/aCis_datapack/data/scripts/quests/Q509_TheClansPrestige/Q509_TheClansPrestige.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q509_TheClansPrestige/Q509_TheClansPrestige.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q509_TheClansPrestige/Q509_TheClansPrestige.java	(revision 345)
@@ -13,4 +13,5 @@
 package quests.Q509_TheClansPrestige;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.L2Clan;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
@@ -21,5 +22,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.PledgeShowInfoUpdate;
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
-import net.sf.l2j.gameserver.util.Util;
 import net.sf.l2j.util.Rnd;
 
@@ -130,5 +130,5 @@
 			return htmltext;
 		
-		if (Util.isDigit(event))
+		if (StringUtil.isDigit(event))
 		{
 			htmltext = "31331-" + event + ".htm";
Index: /trunk/aCis_datapack/data/scripts/quests/Q646_SignsOfRevolt/Q646_SignsOfRevolt.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q646_SignsOfRevolt/Q646_SignsOfRevolt.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q646_SignsOfRevolt/Q646_SignsOfRevolt.java	(revision 345)
@@ -13,9 +13,9 @@
 package quests.Q646_SignsOfRevolt;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.quest.Quest;
 import net.sf.l2j.gameserver.model.quest.QuestState;
-import net.sf.l2j.gameserver.util.Util;
 
 public class Q646_SignsOfRevolt extends Quest
@@ -76,5 +76,5 @@
 			st.playSound(QuestState.SOUND_ACCEPT);
 		}
-		else if (Util.isDigit(event))
+		else if (StringUtil.isDigit(event))
 		{
 			htmltext = "32016-07.htm";
Index: /trunk/aCis_datapack/data/scripts/quests/Q640_TheZeroHour/Q640_TheZeroHour.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q640_TheZeroHour/Q640_TheZeroHour.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q640_TheZeroHour/Q640_TheZeroHour.java	(revision 345)
@@ -13,9 +13,9 @@
 package quests.Q640_TheZeroHour;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.quest.Quest;
 import net.sf.l2j.gameserver.model.quest.QuestState;
-import net.sf.l2j.gameserver.util.Util;
 
 public class Q640_TheZeroHour extends Quest
@@ -115,5 +115,5 @@
 			st.exitQuest(true);
 		}
-		else if (Util.isDigit(event))
+		else if (StringUtil.isDigit(event))
 		{
 			int reward[] = REWARDS[Integer.parseInt(event)];
Index: /trunk/aCis_datapack/data/scripts/quests/Q620_FourGoblets/Q620_FourGoblets.java
===================================================================
--- /trunk/aCis_datapack/data/scripts/quests/Q620_FourGoblets/Q620_FourGoblets.java	(revision 344)
+++ /trunk/aCis_datapack/data/scripts/quests/Q620_FourGoblets/Q620_FourGoblets.java	(revision 345)
@@ -13,4 +13,5 @@
 package quests.Q620_FourGoblets;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.instancemanager.FourSepulchersManager;
 import net.sf.l2j.gameserver.model.actor.L2Npc;
@@ -185,5 +186,5 @@
 		}
 		// If event is a simple digit, parse it to get an integer form, then test the reward list
-		else if (Util.isDigit(event))
+		else if (StringUtil.isDigit(event))
 		{
 			final int id = Integer.parseInt(event);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/L2DatabaseFactory.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/L2DatabaseFactory.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/L2DatabaseFactory.java	(revision 345)
@@ -119,18 +119,15 @@
 	public final static String safetyString(String... whatToCheck)
 	{
-		final char brace = '`';
-		
-		final StringBuilder sbResult = new StringBuilder();
-		
+		final StringBuilder sb = new StringBuilder();
 		for (String word : whatToCheck)
 		{
-			if (sbResult.length() > 0)
-				sbResult.append(", ");
+			if (sb.length() > 0)
+				sb.append(", ");
 			
-			sbResult.append(brace);
-			sbResult.append(word);
-			sbResult.append(brace);
+			sb.append('`');
+			sb.append(word);
+			sb.append('`');
 		}
-		return sbResult.toString();
+		return sb.toString();
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/commons/lang/StringUtil.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/commons/lang/StringUtil.java	(revision 345)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/commons/lang/StringUtil.java	(revision 345)
@@ -0,0 +1,155 @@
+/*
+ * This program is free software: you can redistribute it and/or modify it under
+ * the terms of the GNU General Public License as published by the Free Software
+ * Foundation, either version 3 of the License, or (at your option) any later
+ * version.
+ * 
+ * This program is distributed in the hope that it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+ * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
+ * details.
+ * 
+ * You should have received a copy of the GNU General Public License along with
+ * this program. If not, see <http://www.gnu.org/licenses/>.
+ */
+package net.sf.l2j.commons.lang;
+
+import java.text.DateFormat;
+import java.text.NumberFormat;
+import java.text.SimpleDateFormat;
+import java.util.Arrays;
+import java.util.Collections;
+import java.util.List;
+import java.util.Locale;
+import java.util.logging.Logger;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
+import java.util.regex.PatternSyntaxException;
+
+public final class StringUtil
+{
+	public static final DateFormat DATE = new SimpleDateFormat("dd-MM-yyyy");
+	public static final DateFormat DATE_HH = new SimpleDateFormat("dd-MM-yyyy HH");
+	public static final DateFormat DATE_MM = new SimpleDateFormat("dd-MM-yyyy HH:mm");
+	public static final DateFormat DATE_SS = new SimpleDateFormat("dd-MM-yyyy HH:mm:ss");
+	
+	public static final DateFormat REVERSED_DATE = new SimpleDateFormat("yyyy-MM-dd");
+	public static final DateFormat REVERSED_DATE_HH = new SimpleDateFormat("yyyy-MM-dd HH");
+	public static final DateFormat REVERSED_DATE_MM = new SimpleDateFormat("yyyy-MM-dd HH:mm");
+	public static final DateFormat REVERSED_DATE_SS = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
+	
+	private static final Logger LOG = Logger.getLogger(StringUtil.class.getName());
+	
+	/**
+	 * Appends objects to an existing StringBuilder.
+	 * @param sb : the StringBuilder to edit.
+	 * @param content : parameters to append.
+	 */
+	public static void append(StringBuilder sb, Object... content)
+	{
+		for (Object obj : content)
+			sb.append((obj == null) ? null : obj.toString());
+	}
+	
+	/**
+	 * @param text : the String to check.
+	 * @return true if the String contains only numbers, false otherwise.
+	 */
+	public static boolean isDigit(String text)
+	{
+		if (text == null)
+			return false;
+		
+		return text.matches("[0-9]+");
+	}
+	
+	/**
+	 * @param text : the String to check.
+	 * @return true if the String contains only numbers and letters, false otherwise.
+	 */
+	public static boolean isAlphaNumeric(String text)
+	{
+		if (text == null)
+			return false;
+		
+		for (char chars : text.toCharArray())
+		{
+			if (!Character.isLetterOrDigit(chars))
+				return false;
+		}
+		return true;
+	}
+	
+	/**
+	 * @param value : the number to format.
+	 * @return a number formatted with "," delimiter.
+	 */
+	public static String formatNumber(long value)
+	{
+		return NumberFormat.getInstance(Locale.ENGLISH).format(value);
+	}
+	
+	/**
+	 * @param string : the initial word to scramble.
+	 * @return an anagram of the given string.
+	 */
+	public static String scrambleString(String string)
+	{
+		final List<String> letters = Arrays.asList(string.split(""));
+		Collections.shuffle(letters);
+		
+		final StringBuilder sb = new StringBuilder(string.length());
+		for (String c : letters)
+			sb.append(c);
+		
+		return sb.toString();
+	}
+	
+	/**
+	 * Verify if the given text matches with the regex pattern.
+	 * @param text : the text to test.
+	 * @param regex : the regex pattern to make test with.
+	 * @return true if matching.
+	 */
+	public static boolean isValidName(String text, String regex)
+	{
+		Pattern pattern;
+		try
+		{
+			pattern = Pattern.compile(regex);
+		}
+		catch (PatternSyntaxException e) // case of illegal pattern
+		{
+			pattern = Pattern.compile(".*");
+		}
+		
+		Matcher regexp = pattern.matcher(text);
+		
+		return regexp.matches();
+	}
+	
+	/**
+	 * Child of isValidName, with regular pattern for players' name.
+	 * @param text : the text to test.
+	 * @return true if matching.
+	 */
+	public static boolean isValidPlayerName(String text)
+	{
+		return isValidName(text, "^[A-Za-z0-9]{1,16}$");
+	}
+	
+	/**
+	 * Format a given text to fit with logging "title" criterias, and send it.
+	 * @param text : the String to format.
+	 */
+	public static void printSection(String text)
+	{
+		final StringBuilder sb = new StringBuilder(80);
+		for (int i = 0; i < (73 - text.length()); i++)
+			sb.append("-");
+		
+		StringUtil.append(sb, "=[ ", text, " ]");
+		
+		LOG.info(sb.toString());
+	}
+}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/util/Util.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/util/Util.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/util/Util.java	(revision 345)
@@ -15,26 +15,6 @@
 package net.sf.l2j.util;
 
-import java.net.UnknownHostException;
-import java.util.logging.Logger;
-
 public class Util
 {
-	private static final Logger _log = Logger.getLogger(Util.class.getName());
-	
-	public static boolean isInternalIP(String ipAddress)
-	{
-		java.net.InetAddress addr = null;
-		try
-		{
-			addr = java.net.InetAddress.getByName(ipAddress);
-			return addr.isSiteLocalAddress() || addr.isLoopbackAddress();
-		}
-		catch (UnknownHostException e)
-		{
-			e.printStackTrace();
-		}
-		return false;
-	}
-	
 	public static String printData(byte[] data, int len)
 	{
@@ -108,11 +88,3 @@
 		return printData(raw, raw.length);
 	}
-	
-	public static void printSection(String s)
-	{
-		s = "=[ " + s + " ]";
-		while (s.length() < 78)
-			s = "-" + s;
-		_log.info(s);
-	}
 }
Index: unk/aCis_gameserver/java/net/sf/l2j/util/Point3D.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/util/Point3D.java	(revision 344)
+++ 	(revision )
@@ -1,99 +1,0 @@
-/*
- * This program is free software: you can redistribute it and/or modify it under
- * the terms of the GNU General Public License as published by the Free Software
- * Foundation, either version 3 of the License, or (at your option) any later
- * version.
- * 
- * This program is distributed in the hope that it will be useful, but WITHOUT
- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
- * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
- * details.
- * 
- * You should have received a copy of the GNU General Public License along with
- * this program. If not, see <http://www.gnu.org/licenses/>.
- */
-package net.sf.l2j.util;
-
-import java.io.Serializable;
-
-/**
- * Deedlit: we are using volatile variable types here. We dont need to additionally use synchronized, cause volatile vars are synced vars.
- */
-public class Point3D implements Serializable
-{
-	private static final long serialVersionUID = 4638345252031872576L;
-	
-	private volatile int _x, _y, _z;
-	
-	public Point3D(int pX, int pY, int pZ)
-	{
-		_x = pX;
-		_y = pY;
-		_z = pZ;
-	}
-	
-	@Override
-	public String toString()
-	{
-		return "(" + _x + ", " + _y + ", " + _z + ")";
-	}
-	
-	@Override
-	public int hashCode()
-	{
-		return _x ^ _y ^ _z;
-	}
-	
-	@Override
-	public boolean equals(Object o)
-	{
-		if (o instanceof Point3D)
-		{
-			Point3D point3D = (Point3D) o;
-			return (point3D._x == _x && point3D._y == _y && point3D._z == _z);
-		}
-		return false;
-	}
-	
-	public boolean equals(int pX, int pY, int pZ)
-	{
-		return _x == pX && _y == pY && _z == pZ;
-	}
-	
-	public int getX()
-	{
-		return _x;
-	}
-	
-	public void setX(int pX)
-	{
-		_x = pX;
-	}
-	
-	public int getY()
-	{
-		return _y;
-	}
-	
-	public void setY(int pY)
-	{
-		_y = pY;
-	}
-	
-	public int getZ()
-	{
-		return _z;
-	}
-	
-	public void setZ(int pZ)
-	{
-		_z = pZ;
-	}
-	
-	public void setXYZ(int pX, int pY, int pZ)
-	{
-		_x = pX;
-		_y = pY;
-		_z = pZ;
-	}
-}
Index: unk/aCis_gameserver/java/net/sf/l2j/util/StringUtil.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/util/StringUtil.java	(revision 344)
+++ 	(revision )
@@ -1,199 +1,0 @@
-/*
- * $Header$
- * 
- * $Author: fordfrog $ $Date$ $Revision$ $Log$
- * 
- * 
- * This program is free software: you can redistribute it and/or modify it under
- * the terms of the GNU General Public License as published by the Free Software
- * Foundation, either version 3 of the License, or (at your option) any later
- * version.
- * 
- * This program is distributed in the hope that it will be useful, but WITHOUT
- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
- * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
- * details.
- * 
- * You should have received a copy of the GNU General Public License along with
- * this program. If not, see <http://www.gnu.org/licenses/>.
- */
-package net.sf.l2j.util;
-
-/**
- * String utilities optimized for the best performance. <h1>How to Use It</h1> <h2>concat() or append()</h2> If concatenating strings in single call, use StringUtil.concat(), otherwise use StringUtil.append() and its variants. <h2>Minimum Calls</h2> Bad:
- * 
- * <pre>
- * final StringBuilder sbString = new StringBuilder();
- * StringUtil.append(sbString, &quot;text 1&quot;, String.valueOf(npcId));
- * StringUtil.append(&quot;text 2&quot;);
- * </pre>
- * 
- * Good:
- * 
- * <pre>
- * final StringBuilder sbString = new StringBuilder();
- * StringUtil.append(sbString, &quot;text 1&quot;, String.valueOf(npcId), &quot;text 2&quot;);
- * </pre>
- * 
- * Why?<br/>
- * Because the less calls you do, the less memory re-allocations have to be done so the whole text fits into the memory and less array copy tasks has to be performed. So if using less calls, less memory is used and string concatenation is faster. <h2>Size Hints for Loops</h2> Bad:
- * 
- * <pre>
- * final StringBuilder sbString = new StringBuilder();
- * StringUtil.append(sbString, &quot;header start&quot;, someText, &quot;header end&quot;);
- * for (int i = 0; i &lt; 50; i++)
- * {
- * 	StringUtil.append(sbString, &quot;text 1&quot;, stringArray[i], &quot;text 2&quot;);
- * }
- * </pre>
- * 
- * Good:
- * 
- * <pre>
- * final StringBuilder sbString = StringUtil.startAppend(1300, &quot;header start&quot;, someText, &quot;header end&quot;);
- * for (int i = 0; i &lt; 50; i++)
- * {
- * 	StringUtil.append(sbString, &quot;text 1&quot;, stringArray[i], &quot;text 2&quot;);
- * }
- * </pre>
- * 
- * Why?<br/>
- * When using StringUtil.append(), memory is only allocated to fit in the strings in method argument. So on each loop new memory for the string has to be allocated and old string has to be copied to the new string. With size hint, even if the size hint is above the needed memory, memory is saved
- * because new memory has not to be allocated on each cycle. Also it is much faster if no string copy tasks has to be performed. So if concatenating strings in a loop, count approximately the size and set it as the hint for the string builder size. It's better to make the size hint little bit larger
- * rather than smaller.<br/>
- * In case there is no text appended before the cycle, just use <code>new StringBuilder(1300)</code>. <h2>Concatenation and Constants</h2> Bad:
- * 
- * <pre>
- * StringUtil.concat(&quot;text 1 &quot;, &quot;text 2&quot;, String.valueOf(npcId));
- * </pre>
- * 
- * Good:
- * 
- * <pre>
- * StringUtil.concat(&quot;text 1 &quot; + &quot;text 2&quot;, String.valueOf(npcId));
- * </pre>
- * 
- * or
- * 
- * <pre>
- * StringUtil.concat(&quot;text 1 text 2&quot;, String.valueOf(npcId));
- * </pre>
- * 
- * Why?<br/>
- * It saves some cycles when determining size of memory that needs to be allocated because less strings are passed to concat() method. But do not use + for concatenation of non-constant strings, that degrades performance and makes extra memory allocations needed. <h2>Concatenation and Constant
- * Variables</h2> Bad:
- * 
- * <pre>
- * String glue = &quot;some glue&quot;;
- * StringUtil.concat(&quot;text 1&quot;, glue, &quot;text 2&quot;, glue, String.valueOf(npcId));
- * </pre>
- * 
- * Good:
- * 
- * <pre>
- * final String glue = &quot;some glue&quot;;
- * StringUtil.concat(&quot;text 1&quot; + glue + &quot;text2&quot; + glue, String.valueOf(npcId));
- * </pre>
- * 
- * Why? Because when using <code>final</code> keyword, the <code>glue</code> is marked as constant string and compiler treats it as a constant string so it is able to create string "text1some gluetext2some glue" during the compilation. But this only works in case the value is known at compilation
- * time, so this cannot be used for cases like <code>final String objectIdString = String.valueOf(getObjectId)</code>. <h2>StringBuilder Reuse</h2> Bad:
- * 
- * <pre>
- * final StringBuilder sbString1 = new StringBuilder(); StringUtil.append(sbString1, &quot;text 1&quot;, String.valueOf(npcId), &quot;text 2&quot;); ... // output of sbString1, it is no more needed final StringBuilder sbString2 = new StringBuilder(); StringUtil.append(sbString2, &quot;text
- * 3&quot;, String.valueOf(npcId), &quot;text 4&quot;);
- * </pre>
- * 
- * Good:
- * 
- * <pre>
- * final StringBuilder sbString = new StringBuilder(); StringUtil.append(sbString, &quot;text 1&quot;, String.valueOf(npcId), &quot;text 2&quot;); ... // output of sbString, it is no more needed sbString.setLength(0);
- * StringUtil.append(sbString, &quot;text 3&quot;, String.valueOf(npcId), &quot;text 4&quot;);
- * </pre>
- * 
- * Why?</br> In first case, new memory has to be allocated for the second string. In second case already allocated memory is reused, but only in case the new string is not longer than the previously allocated string. Anyway, the second way is better because the string either fits in the memory and
- * some memory is saved, or it does not fit in the memory, and in that case it works as in the first case. <h2>Primitives to Strings</h2> To convert primitives to string, use String.valueOf(). <h2>How much faster is it?</h2> Here are some results of my tests. Count is number of strings concatenated.
- * Don't take the numbers as 100% true as the numbers are affected by other programs running on my computer at the same time. Anyway, from the results it is obvious that using StringBuilder with predefined size is the fastest (and also most memory efficient) solution. It is about 5 times faster when
- * concatenating 7 strings, compared to TextBuilder. Also, with more strings concatenated, the difference between StringBuilder and TextBuilder gets larger. In code, there are many cases, where there are concatenated 50+ strings so the time saving is even greater.
- * 
- * <pre>
- * Count: 2 TextBuilder: 1893 TextBuilder with size: 1703 String: 1033 StringBuilder: 993 StringBuilder with size: 1024
- * Count: 3 TextBuilder: 1973 TextBuilder with size: 1872 String: 2583 StringBuilder: 1633 StringBuilder with size: 1156
- * Count: 4 TextBuilder: 2188 TextBuilder with size: 2229 String: 4207 StringBuilder: 1816 StringBuilder with size: 1444
- * Count: 5 TextBuilder: 9185 TextBuilder with size: 9464 String: 6937 StringBuilder: 2745 StringBuilder with size: 1882
- * Count: 6 TextBuilder: 9785 TextBuilder with size: 10082 String: 9471 StringBuilder: 2889 StringBuilder with size: 1857
- * Count: 7 TextBuilder: 10169 TextBuilder with size: 10528 String: 12746 StringBuilder: 3081 StringBuilder with size: 2139
- * </pre>
- * @author fordfrog
- */
-public final class StringUtil
-{
-	
-	private StringUtil()
-	{
-	}
-	
-	/**
-	 * Concatenates strings.
-	 * @param strings strings to be concatenated
-	 * @return concatenated string
-	 * @see StringUtil
-	 */
-	public static String concat(final String... strings)
-	{
-		final StringBuilder sbString = new StringBuilder();
-		for (final String string : strings)
-			sbString.append(string);
-		
-		return sbString.toString();
-	}
-	
-	/**
-	 * Creates new string builder with size initializated to <code>sizeHint</code>, unless total length of strings is greater than <code>sizeHint</code>.
-	 * @param sizeHint hint for string builder size allocation
-	 * @param strings strings to be appended
-	 * @return created string builder
-	 * @see StringUtil
-	 */
-	public static StringBuilder startAppend(final int sizeHint, final String... strings)
-	{
-		final int length = getLength(strings);
-		final StringBuilder sbString = new StringBuilder(sizeHint > length ? sizeHint : length);
-		
-		for (final String string : strings)
-			sbString.append(string);
-		
-		return sbString;
-	}
-	
-	/**
-	 * Appends strings to existing string builder.
-	 * @param sbString string builder
-	 * @param strings strings to be appended
-	 * @see StringUtil
-	 */
-	public static void append(final StringBuilder sbString, final String... strings)
-	{
-		sbString.ensureCapacity(sbString.length() + getLength(strings));
-		
-		for (final String string : strings)
-			sbString.append(string);
-	}
-	
-	/**
-	 * Counts total length of all the strings.
-	 * @param strings array of strings
-	 * @return total length of all the strings
-	 */
-	private static int getLength(final String[] strings)
-	{
-		int length = 0;
-		for (final String string : strings)
-		{
-			if (string == null)
-				length += 4;
-			else
-				length += string.length();
-		}
-		return length;
-	}
-}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/loginserver/L2LoginServer.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/loginserver/L2LoginServer.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/loginserver/L2LoginServer.java	(revision 345)
@@ -29,7 +29,7 @@
 import net.sf.l2j.L2DatabaseFactory;
 import net.sf.l2j.Server;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.commons.mmocore.SelectorConfig;
 import net.sf.l2j.commons.mmocore.SelectorThread;
-import net.sf.l2j.util.Util;
 
 /**
@@ -73,5 +73,5 @@
 		is.close();
 		
-		Util.printSection("aCis");
+		StringUtil.printSection("aCis");
 		
 		// Initialize config
@@ -81,12 +81,12 @@
 		L2DatabaseFactory.getInstance();
 		
-		Util.printSection("LoginController");
+		StringUtil.printSection("LoginController");
 		LoginController.load();
 		GameServerTable.getInstance();
 		
-		Util.printSection("Ban List");
+		StringUtil.printSection("Ban List");
 		loadBanFile();
 		
-		Util.printSection("IP, Ports & Socket infos");
+		StringUtil.printSection("IP, Ports & Socket infos");
 		InetAddress bindAddress = null;
 		if (!Config.LOGIN_BIND_ADDRESS.equals("*"))
@@ -155,5 +155,5 @@
 		_log.info("Loginserver ready on " + (bindAddress == null ? "*" : bindAddress.getHostAddress()) + ":" + Config.PORT_LOGIN);
 		
-		Util.printSection("Waiting for gameserver answer");
+		StringUtil.printSection("Waiting for gameserver answer");
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/ThreadPoolManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/ThreadPoolManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/ThreadPoolManager.java	(revision 345)
@@ -28,5 +28,5 @@
 
 import net.sf.l2j.Config;
-import net.sf.l2j.util.StringUtil;
+import net.sf.l2j.commons.lang.StringUtil;
 
 /**
@@ -318,5 +318,5 @@
 			Thread[] threads = new Thread[count + 2];
 			ptf.getGroup().enumerate(threads);
-			StringUtil.append(sb, "General Packet Thread Pool:\r\n" + "Tasks in the queue: ", String.valueOf(_generalPacketsThreadPool.getQueue().size()), "\r\n" + "Showing threads stack trace:\r\n" + "There should be ", String.valueOf(count), " Threads\r\n");
+			StringUtil.append(sb, "General Packet Thread Pool:\r\nTasks in the queue: ", _generalPacketsThreadPool.getQueue().size(), "\r\nShowing threads stack trace:\r\nThere should be ", count, " Threads\r\n");
 			for (Thread t : threads)
 			{
@@ -348,5 +348,5 @@
 			Thread[] threads = new Thread[count + 2];
 			ptf.getGroup().enumerate(threads);
-			StringUtil.append(sb, "I/O Packet Thread Pool:\r\n" + "Tasks in the queue: ", String.valueOf(_ioPacketsThreadPool.getQueue().size()), "\r\n" + "Showing threads stack trace:\r\n" + "There should be ", String.valueOf(count), " Threads\r\n");
+			StringUtil.append(sb, "I/O Packet Thread Pool:\r\nTasks in the queue: ", _ioPacketsThreadPool.getQueue().size(), "\r\nShowing threads stack trace:\r\nThere should be ", count, " Threads\r\n");
 			
 			for (Thread t : threads)
@@ -380,5 +380,5 @@
 			Thread[] threads = new Thread[count + 2];
 			ptf.getGroup().enumerate(threads);
-			StringUtil.append(sb, "General Thread Pool:\r\n" + "Tasks in the queue: ", String.valueOf(_generalThreadPool.getQueue().size()), "\r\n" + "Showing threads stack trace:\r\n" + "There should be ", String.valueOf(count), " Threads\r\n");
+			StringUtil.append(sb, "General Thread Pool:\r\nTasks in the queue: ", _generalThreadPool.getQueue().size(), "\r\nShowing threads stack trace:\r\nThere should be ", count, " Threads\r\n");
 			
 			for (Thread t : threads)
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/util/GMAudit.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/util/GMAudit.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/util/GMAudit.java	(revision 345)
@@ -21,4 +21,6 @@
 import java.util.logging.Level;
 import java.util.logging.Logger;
+
+import net.sf.l2j.commons.lang.StringUtil;
 
 public class GMAudit
@@ -45,5 +47,5 @@
 		try (FileWriter save = new FileWriter(file, true))
 		{
-			save.write(Util.formatDate(new Date(), "dd/MM/yyyy H:mm:ss") + ">" + gmName + ">" + action + ">" + target + ">" + params + "\r\n");
+			save.write(StringUtil.DATE_SS.format(new Date()) + ">" + gmName + ">" + action + ">" + target + ">" + params + "\r\n");
 		}
 		catch (IOException e)
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/util/Util.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/util/Util.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/util/Util.java	(revision 345)
@@ -15,15 +15,4 @@
 package net.sf.l2j.gameserver.util;
 
-import java.text.DateFormat;
-import java.text.SimpleDateFormat;
-import java.util.Arrays;
-import java.util.Collection;
-import java.util.Collections;
-import java.util.Date;
-import java.util.List;
-import java.util.regex.Matcher;
-import java.util.regex.Pattern;
-import java.util.regex.PatternSyntaxException;
-
 import net.sf.l2j.gameserver.ThreadPoolManager;
 import net.sf.l2j.gameserver.model.L2Object;
@@ -131,69 +120,4 @@
 	
 	/**
-	 * Capitalizes the first letter of a string, and returns the result.<BR>
-	 * (Based on ucfirst() function of PHP)
-	 * @param str
-	 * @return String containing the modified string.
-	 */
-	public static String capitalizeFirst(String str)
-	{
-		str = str.trim();
-		
-		if (str.length() > 0 && Character.isLetter(str.charAt(0)))
-			return str.substring(0, 1).toUpperCase() + str.substring(1);
-		
-		return str;
-	}
-	
-	/**
-	 * Capitalizes the first letter of every "word" in a string.<BR>
-	 * (Based on ucwords() function of PHP)
-	 * @param str
-	 * @return String containing the modified string.
-	 */
-	public static String capitalizeWords(String str)
-	{
-		char[] charArray = str.toCharArray();
-		String result = "";
-		
-		// Capitalize the first letter in the given string!
-		charArray[0] = Character.toUpperCase(charArray[0]);
-		
-		for (int i = 0; i < charArray.length; i++)
-		{
-			if (Character.isWhitespace(charArray[i]))
-				charArray[i + 1] = Character.toUpperCase(charArray[i + 1]);
-			
-			result += Character.toString(charArray[i]);
-		}
-		
-		return result;
-	}
-	
-	/**
-	 * Format the given date on the given format
-	 * @param date : the date to format.
-	 * @param format : the format to correct by.
-	 * @return a string representation of the formatted date.
-	 */
-	public static String formatDate(Date date, String format)
-	{
-		final DateFormat dateFormat = new SimpleDateFormat(format);
-		if (date != null)
-			return dateFormat.format(date);
-		
-		return null;
-	}
-	
-	public static String formatDate(long date, String format)
-	{
-		final DateFormat dateFormat = new SimpleDateFormat(format);
-		if (date > 0)
-			return dateFormat.format(date);
-		
-		return null;
-	}
-	
-	/**
 	 * Faster calculation than checkIfInRange if distance is short and collisionRadius isn't needed. Not for long distance checks (potential teleports, far away castles, etc)
 	 * @param radius The radius to use as check.
@@ -263,76 +187,4 @@
 	
 	/**
-	 * Verify if the given text matches with the regex pattern.
-	 * @param text : the text to test.
-	 * @param regex : the regex pattern to make test with.
-	 * @return true if matching.
-	 */
-	public static boolean isValidName(String text, String regex)
-	{
-		Pattern pattern;
-		try
-		{
-			pattern = Pattern.compile(regex);
-		}
-		catch (PatternSyntaxException e) // case of illegal pattern
-		{
-			pattern = Pattern.compile(".*");
-		}
-		
-		Matcher regexp = pattern.matcher(text);
-		
-		return regexp.matches();
-	}
-	
-	/**
-	 * Child of isValidName, with regular pattern for players' name.
-	 * @param text : the text to test.
-	 * @return true if matching.
-	 */
-	public static boolean isValidPlayerName(String text)
-	{
-		return isValidName(text, "^[A-Za-z0-9]{1,16}$");
-	}
-	
-	/**
-	 * Returns the number of "words" in a given string.
-	 * @param str
-	 * @return int numWords
-	 */
-	public static int countWords(String str)
-	{
-		return str.trim().split(" ").length;
-	}
-	
-	/**
-	 * Returns a delimited string for an given array of string elements.<BR>
-	 * (Based on implode() in PHP)
-	 * @param strArray
-	 * @param strDelim
-	 * @return String implodedString
-	 */
-	public static String implodeString(String[] strArray, String strDelim)
-	{
-		String result = "";
-		
-		for (String strValue : strArray)
-			result += strValue + strDelim;
-		
-		return result;
-	}
-	
-	/**
-	 * Returns a delimited string for an given collection of string elements.<BR>
-	 * (Based on implode() in PHP)
-	 * @param strCollection
-	 * @param strDelim
-	 * @return String implodedString
-	 */
-	public static String implodeString(Collection<String> strCollection, String strDelim)
-	{
-		return implodeString(strCollection.toArray(new String[strCollection.size()]), strDelim);
-	}
-	
-	/**
 	 * Returns the rounded value of val to specified number of digits after the decimal point.<BR>
 	 * (Based on round() in PHP)
@@ -352,74 +204,4 @@
 	
 	/**
-	 * @param text - the text to check
-	 * @return {@code true} if {@code text} contains only numbers, {@code false} otherwise
-	 */
-	public static boolean isDigit(String text)
-	{
-		if (text == null)
-			return false;
-		
-		return text.matches("[0-9]+");
-	}
-	
-	public static boolean isAlphaNumeric(String text)
-	{
-		if (text == null)
-			return false;
-		
-		boolean result = true;
-		char[] chars = text.toCharArray();
-		for (int i = 0; i < chars.length; i++)
-		{
-			if (!Character.isLetterOrDigit(chars[i]))
-			{
-				result = false;
-				break;
-			}
-		}
-		return result;
-	}
-	
-	/**
-	 * Return amount of adena formatted with "," delimiter
-	 * @param amount
-	 * @return String formatted adena amount
-	 */
-	public static String formatAdena(long amount)
-	{
-		String s = "";
-		long rem = amount % 1000;
-		s = Long.toString(rem);
-		amount = (amount - rem) / 1000;
-		while (amount > 0)
-		{
-			if (rem < 99)
-				s = '0' + s;
-			if (rem < 9)
-				s = '0' + s;
-			rem = amount % 1000;
-			s = Long.toString(rem) + "," + s;
-			amount = (amount - rem) / 1000;
-		}
-		return s;
-	}
-	
-	/**
-	 * @param string the initial word to scramble.
-	 * @return an anagram of the given string.
-	 */
-	public static String scrambleString(String string)
-	{
-		List<String> letters = Arrays.asList(string.split(""));
-		Collections.shuffle(letters);
-		
-		StringBuilder sb = new StringBuilder(string.length());
-		for (String c : letters)
-			sb.append(c);
-		
-		return sb.toString();
-	}
-	
-	/**
 	 * @param <T> The Object type.
 	 * @param array - the array to look into.
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSiege.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSiege.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSiege.java	(revision 345)
@@ -17,4 +17,5 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.ClanTable;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
@@ -206,81 +207,85 @@
 	{
 		int i = 0;
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/castles.htm");
-		StringBuilder cList = new StringBuilder();
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/castles.htm");
+		
+		final StringBuilder sb = new StringBuilder();
 		for (Castle castle : CastleManager.getInstance().getCastles())
 		{
 			if (castle != null)
 			{
-				String name = castle.getName();
-				cList.append("<td fixwidth=90><a action=\"bypass -h admin_siege " + name + "\">" + name + "</a></td>");
+				sb.append("<td fixwidth=90><a action=\"bypass -h admin_siege " + castle.getName() + "\">" + castle.getName() + "</a></td>");
 				i++;
 			}
+			
 			if (i > 2)
 			{
-				cList.append("</tr><tr>");
+				sb.append("</tr><tr>");
 				i = 0;
 			}
 		}
-		adminReply.replace("%castles%", cList.toString());
-		cList.setLength(0);
-		
+		html.replace("%castles%", sb.toString());
+		
+		// Cleanup sb.
+		sb.setLength(0);
 		i = 0;
+		
 		for (ClanHall clanhall : ClanHallManager.getInstance().getClanHalls().values())
 		{
 			if (clanhall != null)
 			{
-				cList.append("<td fixwidth=134><a action=\"bypass -h admin_clanhall " + clanhall.getId() + "\">");
-				cList.append(clanhall.getName() + "</a></td>");
+				StringUtil.append(sb, "<td fixwidth=134><a action=\"bypass -h admin_clanhall ", clanhall.getId(), "\">", clanhall.getName(), "</a></td>");
 				i++;
 			}
+			
 			if (i > 1)
 			{
-				cList.append("</tr><tr>");
+				sb.append("</tr><tr>");
 				i = 0;
 			}
 		}
-		adminReply.replace("%clanhalls%", cList.toString());
-		cList.setLength(0);
-		
+		html.replace("%clanhalls%", sb.toString());
+		
+		// Cleanup sb.
+		sb.setLength(0);
 		i = 0;
+		
 		for (ClanHall clanhall : ClanHallManager.getInstance().getFreeClanHalls().values())
 		{
 			if (clanhall != null)
 			{
-				cList.append("<td fixwidth=134><a action=\"bypass -h admin_clanhall " + clanhall.getId() + "\">");
-				cList.append(clanhall.getName() + "</a></td>");
+				StringUtil.append(sb, "<td fixwidth=134><a action=\"bypass -h admin_clanhall ", clanhall.getId(), "\">", clanhall.getName(), "</a></td>");
 				i++;
 			}
+			
 			if (i > 1)
 			{
-				cList.append("</tr><tr>");
+				sb.append("</tr><tr>");
 				i = 0;
 			}
 		}
-		adminReply.replace("%freeclanhalls%", cList.toString());
-		activeChar.sendPacket(adminReply);
+		html.replace("%freeclanhalls%", sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
 	private static void showSiegePage(L2PcInstance activeChar, String castleName)
 	{
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/castle.htm");
-		adminReply.replace("%castleName%", castleName);
-		activeChar.sendPacket(adminReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/castle.htm");
+		html.replace("%castleName%", castleName);
+		activeChar.sendPacket(html);
 	}
 	
 	private static void showClanHallPage(L2PcInstance activeChar, ClanHall clanhall)
 	{
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/clanhall.htm");
-		adminReply.replace("%clanhallName%", clanhall.getName());
-		adminReply.replace("%clanhallId%", clanhall.getId());
-		L2Clan owner = ClanTable.getInstance().getClan(clanhall.getOwnerId());
-		if (owner == null)
-			adminReply.replace("%clanhallOwner%", "None");
-		else
-			adminReply.replace("%clanhallOwner%", owner.getName());
-		activeChar.sendPacket(adminReply);
+		final L2Clan owner = ClanTable.getInstance().getClan(clanhall.getOwnerId());
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/clanhall.htm");
+		html.replace("%clanhallName%", clanhall.getName());
+		html.replace("%clanhallId%", clanhall.getId());
+		html.replace("%clanhallOwner%", (owner == null) ? "None" : owner.getName());
+		activeChar.sendPacket(html);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminExpSp.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminExpSp.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminExpSp.java	(revision 345)
@@ -16,7 +16,5 @@
 
 import java.util.StringTokenizer;
-import java.util.logging.Logger;
 
-import net.sf.l2j.Config;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
 import net.sf.l2j.gameserver.model.L2Object;
@@ -31,5 +29,4 @@
 public class AdminExpSp implements IAdminCommandHandler
 {
-	private static Logger _log = Logger.getLogger(AdminExpSp.class.getName());
 	private static final String[] ADMIN_COMMANDS =
 	{
@@ -89,12 +86,12 @@
 			return;
 		}
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/expsp.htm");
-		adminReply.replace("%name%", player.getName());
-		adminReply.replace("%level%", player.getLevel());
-		adminReply.replace("%xp%", player.getExp());
-		adminReply.replace("%sp%", player.getSp());
-		adminReply.replace("%class%", player.getTemplate().getClassName());
-		activeChar.sendPacket(adminReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/expsp.htm");
+		html.replace("%name%", player.getName());
+		html.replace("%level%", player.getLevel());
+		html.replace("%xp%", player.getExp());
+		html.replace("%sp%", player.getSp());
+		html.replace("%class%", player.getTemplate().getClassName());
+		activeChar.sendPacket(html);
 	}
 	
@@ -132,11 +129,8 @@
 		if (expval != 0 || spval != 0)
 		{
-			// Common character information
 			player.sendMessage("Admin is adding you " + expval + " xp and " + spval + " sp.");
 			player.addExpAndSp(expval, spval);
-			// Admin information
+			
 			activeChar.sendMessage("Added " + expval + " xp and " + spval + " sp to " + player.getName() + ".");
-			if (Config.DEBUG)
-				_log.fine("GM: " + activeChar.getName() + "(" + activeChar.getObjectId() + ") added " + expval + " xp and " + spval + " sp to " + player.getObjectId() + ".");
 		}
 		return true;
@@ -176,11 +170,8 @@
 		if (expval != 0 || spval != 0)
 		{
-			// Common character information
 			player.sendMessage("Admin is removing you " + expval + " xp and " + spval + " sp.");
 			player.removeExpAndSp(expval, spval);
-			// Admin information
+			
 			activeChar.sendMessage("Removed " + expval + " xp and " + spval + " sp from " + player.getName() + ".");
-			if (Config.DEBUG)
-				_log.fine("GM: " + activeChar.getName() + "(" + activeChar.getObjectId() + ") removed " + expval + " xp and " + spval + " sp from " + player.getObjectId() + ".");
 		}
 		return true;
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBan.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBan.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBan.java	(revision 345)
@@ -27,5 +27,4 @@
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.network.SystemMessageId;
-import net.sf.l2j.gameserver.util.GMAudit;
 
 /**
@@ -119,5 +118,4 @@
 				LoginServerThread.getInstance().sendAccessLevel(player, -100);
 				activeChar.sendMessage("Ban request sent for account " + player + ".");
-				auditAction(command, activeChar, player);
 			}
 			else
@@ -125,5 +123,4 @@
 				targetPlayer.setPunishLevel(L2PcInstance.PunishLevel.ACC, 0);
 				activeChar.sendMessage(targetPlayer.getAccountName() + " account is now banned.");
-				auditAction(command, activeChar, targetPlayer.getAccountName());
 			}
 		}
@@ -136,5 +133,4 @@
 			}
 			
-			auditAction(command, activeChar, (targetPlayer == null ? player : targetPlayer.getName()));
 			return changeCharAccessLevel(targetPlayer, player, activeChar, -100);
 		}
@@ -162,11 +158,7 @@
 				
 				activeChar.sendMessage(targetPlayer.getName() + " is now chat banned" + banLengthStr + ".");
-				auditAction(command, activeChar, targetPlayer.getName());
-			}
-			else
-			{
+			}
+			else
 				banChatOfflinePlayer(activeChar, player, duration, true);
-				auditAction(command, activeChar, player);
-			}
 		}
 		else if (command.startsWith("admin_unban ") || command.equalsIgnoreCase("admin_unban"))
@@ -186,5 +178,4 @@
 				LoginServerThread.getInstance().sendAccessLevel(player, 0);
 				activeChar.sendMessage("Unban request sent for account " + player + ".");
-				auditAction(command, activeChar, player);
 			}
 			else
@@ -201,14 +192,12 @@
 				return false;
 			}
-			else if (targetPlayer != null)
+			
+			if (targetPlayer != null)
 			{
 				activeChar.sendMessage(targetPlayer.getName() + " is currently online so mustn't be banned.");
 				return false;
 			}
-			else
-			{
-				auditAction(command, activeChar, player);
-				return changeCharAccessLevel(null, player, activeChar, 0);
-			}
+			
+			return changeCharAccessLevel(null, player, activeChar, 0);
 		}
 		else if (command.startsWith("admin_unban_chat"))
@@ -226,5 +215,4 @@
 					targetPlayer.setPunishLevel(L2PcInstance.PunishLevel.NONE, 0);
 					activeChar.sendMessage(targetPlayer.getName() + "'s chat ban has been lifted.");
-					auditAction(command, activeChar, targetPlayer.getName());
 				}
 				else
@@ -232,8 +220,5 @@
 			}
 			else
-			{
 				banChatOfflinePlayer(activeChar, player, 0, false);
-				auditAction(command, activeChar, player);
-			}
 		}
 		else if (command.startsWith("admin_jail"))
@@ -249,11 +234,7 @@
 				targetPlayer.setPunishLevel(L2PcInstance.PunishLevel.JAIL, duration);
 				activeChar.sendMessage(targetPlayer.getName() + " have been jailed for " + (duration > 0 ? duration + " minutes." : "ever !"));
-				auditAction(command, activeChar, targetPlayer.getName());
-			}
-			else
-			{
+			}
+			else
 				jailOfflinePlayer(activeChar, player, duration);
-				auditAction(command, activeChar, player);
-			}
 		}
 		else if (command.startsWith("admin_unjail"))
@@ -268,23 +249,9 @@
 				targetPlayer.setPunishLevel(L2PcInstance.PunishLevel.NONE, 0);
 				activeChar.sendMessage(targetPlayer.getName() + " have been unjailed.");
-				auditAction(command, activeChar, targetPlayer.getName());
-			}
-			else
-			{
+			}
+			else
 				unjailOfflinePlayer(activeChar, player);
-				auditAction(command, activeChar, player);
-			}
 		}
 		return true;
-	}
-	
-	private static void auditAction(String fullCommand, L2PcInstance activeChar, String target)
-	{
-		if (!Config.GMAUDIT)
-			return;
-		
-		String[] command = fullCommand.split(" ");
-		
-		GMAudit.auditGMAction(activeChar.getName() + " [" + activeChar.getObjectId() + "]", command[0], (target.equals("") ? "no-target" : target), (command.length > 2 ? command[2] : ""));
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBookmark.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBookmark.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBookmark.java	(revision 345)
@@ -17,4 +17,5 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.BookmarkTable;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
@@ -22,5 +23,4 @@
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -118,11 +118,11 @@
 		
 		// Load static Htm.
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/bk.htm");
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/bk.htm");
 		
 		if (bookmarks == null)
 		{
-			adminReply.replace("%locs%", "<tr><td>No bookmarks are currently registered.</td></tr>");
-			activeChar.sendPacket(adminReply);
+			html.replace("%locs%", "<tr><td>No bookmarks are currently registered.</td></tr>");
+			activeChar.sendPacket(html);
 			return;
 		}
@@ -139,45 +139,34 @@
 		
 		// Generate data.
-		final StringBuilder replyMSG = new StringBuilder(500 + bookmarks.length * 200);
-		
-		String name, x, y, z;
+		final StringBuilder sb = new StringBuilder(2000);
 		
 		for (int i = start; i < end; i++)
 		{
-			L2Bookmark bk = bookmarks[i];
+			final L2Bookmark bk = bookmarks[i];
 			if (bk != null)
 			{
-				name = bk.getName();
-				x = String.valueOf(bk.getX());
-				y = String.valueOf(bk.getY());
-				z = String.valueOf(bk.getZ());
+				final String name = bk.getName();
+				final int x = bk.getX();
+				final int y = bk.getY();
+				final int z = bk.getZ();
 				
-				StringUtil.append(replyMSG, "<tr><td><a action=\"bypass -h admin_move_to ", x, " ", y, " ", z, "\">", name, " (", x, " ", y, " ", z, ")", "</a></td><td><a action=\"bypass -h admin_delbk ", name, "\">Remove</a></td></tr>");
+				StringUtil.append(sb, "<tr><td><a action=\"bypass -h admin_move_to ", x, " ", y, " ", z, "\">", name, " (", x, " ", y, " ", z, ")", "</a></td><td><a action=\"bypass -h admin_delbk ", name, "\">Remove</a></td></tr>");
 			}
 		}
 		
 		// End of table, open a new table for pages system.
-		replyMSG.append("</table><br><table width=270 bgcolor=444444><tr><td>Page: ");
+		sb.append("</table><br><table width=270 bgcolor=444444><tr><td>Page: ");
 		for (int x1 = 0; x1 < max; x1++)
 		{
 			int pagenr = x1 + 1;
 			if (page == pagenr)
-			{
-				replyMSG.append(pagenr);
-				replyMSG.append("|");
-			}
+				StringUtil.append(sb, pagenr, "|");
 			else
-			{
-				replyMSG.append("<a action=\"bypass -h admin_bkpage ");
-				replyMSG.append(x1 + 1);
-				replyMSG.append("\">");
-				replyMSG.append(pagenr);
-				replyMSG.append("</a>|");
-			}
+				StringUtil.append(sb, "<a action=\"bypass -h admin_bkpage ", x1 + 1, "\">", pagenr, "</a>|");
 		}
-		replyMSG.append("</td></tr>");
+		sb.append("</td></tr>");
 		
-		adminReply.replace("%locs%", replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+		html.replace("%locs%", sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBuffs.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBuffs.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminBuffs.java	(revision 345)
@@ -3,5 +3,5 @@
 import java.util.StringTokenizer;
 
-import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
 import net.sf.l2j.gameserver.model.L2Effect;
@@ -12,6 +12,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
 import net.sf.l2j.gameserver.network.serverpackets.SkillCoolTime;
-import net.sf.l2j.gameserver.util.GMAudit;
-import net.sf.l2j.util.StringUtil;
 
 public class AdminBuffs implements IAdminCommandHandler
@@ -191,5 +189,5 @@
 			max++;
 		
-		final StringBuilder html = StringUtil.startAppend(500 + effects.length * 200, "<html><table width=\"100%\"><tr><td width=45><button value=\"Main\" action=\"bypass -h admin_admin\" width=45 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td><td width=180><center><font color=\"LEVEL\">Effects of ", target.getName(), "</font></td><td width=45><button value=\"Back\" action=\"bypass -h admin_current_player\" width=45 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td></tr></table><br><table width=\"100%\"><tr><td width=160>Skill</td><td width=60>Time Left</td><td width=60>Action</td></tr>");
+		final StringBuilder sb = new StringBuilder("<html><table width=\"100%\"><tr><td width=45><button value=\"Main\" action=\"bypass -h admin_admin\" width=45 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td><td width=180><center><font color=\"LEVEL\">Effects of " + target.getName() + "</font></td><td width=45><button value=\"Back\" action=\"bypass -h admin_current_player\" width=45 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td></tr></table><br><table width=\"100%\"><tr><td width=160>Skill</td><td width=60>Time Left</td><td width=60>Action</td></tr>");
 		
 		int start = ((page - 1) * PAGE_LIMIT);
@@ -200,41 +198,22 @@
 			L2Effect e = effects[i];
 			if (e != null)
-			{
-				StringUtil.append(html, "<tr><td>", e.getSkill().getName(), "</td><td>", e.getSkill().isToggle() ? "toggle" : e.getPeriod() - e.getTime() + "s", "</td><td><a action=\"bypass -h admin_stopbuff ", Integer.toString(target.getObjectId()), " ", String.valueOf(e.getSkill().getId()), "\">Remove</a></td></tr>");
-			}
-		}
-		
-		html.append("</table><br><table width=\"100%\" bgcolor=444444><tr>");
+				StringUtil.append(sb, "<tr><td>", e.getSkill().getName(), "</td><td>", (e.getSkill().isToggle()) ? "toggle" : e.getPeriod() - e.getTime() + "s", "</td><td><a action=\"bypass -h admin_stopbuff ", target.getObjectId(), " ", e.getSkill().getId(), "\">Remove</a></td></tr>");
+		}
+		
+		sb.append("</table><br><table width=\"100%\" bgcolor=444444><tr>");
 		for (int x = 0; x < max; x++)
 		{
 			int pagenr = x + 1;
 			if (page == pagenr)
-			{
-				html.append("<td>Page ");
-				html.append(pagenr);
-				html.append("</td>");
-			}
+				StringUtil.append(sb, "<td>Page ", pagenr, "</td>");
 			else
-			{
-				html.append("<td><a action=\"bypass -h admin_getbuffs ");
-				html.append(target.getName());
-				html.append(" ");
-				html.append(x + 1);
-				html.append("\"> Page ");
-				html.append(pagenr);
-				html.append(" </a></td>");
-			}
-		}
-		
-		html.append("</tr></table>");
-		
-		StringUtil.append(html, "<br><center><button value=\"Remove All\" action=\"bypass -h admin_stopallbuffs ", Integer.toString(target.getObjectId()), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></html>");
-		
-		NpcHtmlMessage ms = new NpcHtmlMessage(0);
-		ms.setHtml(html.toString());
-		activeChar.sendPacket(ms);
-		
-		if (Config.GMAUDIT)
-			GMAudit.auditGMAction(activeChar.getName() + " [" + activeChar.getObjectId() + "]", "getbuffs", target.getName() + " (" + Integer.toString(target.getObjectId()) + ")", "");
+				StringUtil.append(sb, "<td><a action=\"bypass -h admin_getbuffs ", target.getName(), " ", x + 1, "\"> Page ", pagenr, "</a></td>");
+		}
+		
+		StringUtil.append(sb, "</tr></table><br><center><button value=\"Remove All\" action=\"bypass -h admin_stopallbuffs ", target.getObjectId(), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -263,6 +242,4 @@
 			}
 			showBuffs(activeChar, target, 1);
-			if (Config.GMAUDIT)
-				GMAudit.auditGMAction(activeChar.getName() + " [" + activeChar.getObjectId() + "]", "stopbuff", target.getName() + " (" + objId + ")", Integer.toString(skillId));
 		}
 	}
@@ -284,6 +261,4 @@
 			activeChar.sendMessage("Removed all effects from " + target.getName() + " (" + objId + ")");
 			showBuffs(activeChar, target, 1);
-			if (Config.GMAUDIT)
-				GMAudit.auditGMAction(activeChar.getName() + " [" + activeChar.getObjectId() + "]", "stopallbuffs", target.getName() + " (" + objId + ")", "");
 		}
 	}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminManor.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminManor.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminManor.java	(revision 345)
@@ -19,4 +19,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
 import net.sf.l2j.gameserver.instancemanager.CastleManager;
@@ -29,11 +30,19 @@
 
 /**
- * Admin comand handler for Manor System This class handles following admin commands: - manor_info = shows info about current manor state - manor_approve = approves settings for the next manor period - manor_setnext = changes manor settings to the next day's - manor_reset castle = resets all manor
- * data for specified castle (or all) - manor_setmaintenance = sets manor system under maintenance mode - manor_save = saves all manor data into database - manor_disable = disables manor system
+ * This class handles following admin commands:
+ * <ul>
+ * <li>manor_info = shows info about current manor state</li>
+ * <li>manor_approve = approves settings for the next manor period</li>
+ * <li>manor_setnext = changes manor settings to the next day's</li>
+ * <li>manor_reset castle = resets all manor data for specified castle (or all)</li>
+ * <li>manor_setmaintenance = sets manor system under maintenance mode</li>
+ * <li>manor_save = saves all manor data into database</li>
+ * <li>manor_disable = disables manor system</li>
+ * </ul>
  * @author l3x
  */
 public class AdminManor implements IAdminCommandHandler
 {
-	private static final String[] _adminCommands =
+	private static final String[] ADMIN_COMMANDS =
 	{
 		"admin_manor",
@@ -83,9 +92,11 @@
 			if (castleId > 0)
 			{
-				Castle castle = CastleManager.getInstance().getCastleById(castleId);
+				final Castle castle = CastleManager.getInstance().getCastleById(castleId);
+				
 				castle.setCropProcure(new ArrayList<CropProcure>(), CastleManorManager.PERIOD_CURRENT);
 				castle.setCropProcure(new ArrayList<CropProcure>(), CastleManorManager.PERIOD_NEXT);
 				castle.setSeedProduction(new ArrayList<SeedProduction>(), CastleManorManager.PERIOD_CURRENT);
 				castle.setSeedProduction(new ArrayList<SeedProduction>(), CastleManorManager.PERIOD_NEXT);
+				
 				if (Config.ALT_MANOR_SAVE_ALL_ACTIONS)
 				{
@@ -103,4 +114,5 @@
 					castle.setSeedProduction(new ArrayList<SeedProduction>(), CastleManorManager.PERIOD_CURRENT);
 					castle.setSeedProduction(new ArrayList<SeedProduction>(), CastleManorManager.PERIOD_NEXT);
+					
 					if (Config.ALT_MANOR_SAVE_ALL_ACTIONS)
 					{
@@ -115,10 +127,8 @@
 		else if (command.equals("admin_manor_setmaintenance"))
 		{
-			boolean mode = CastleManorManager.getInstance().isUnderMaintenance();
+			final boolean mode = CastleManorManager.getInstance().isUnderMaintenance();
+			
 			CastleManorManager.getInstance().setUnderMaintenance(!mode);
-			if (mode)
-				activeChar.sendMessage("Manor System: not under maintenance");
-			else
-				activeChar.sendMessage("Manor System: under maintenance");
+			activeChar.sendMessage((mode) ? "Manor System: not under maintenance" : "Manor System: under maintenance");
 			showMainPage(activeChar);
 		}
@@ -131,20 +141,12 @@
 		else if (command.equals("admin_manor_disable"))
 		{
-			boolean mode = CastleManorManager.getInstance().isDisabled();
+			final boolean mode = CastleManorManager.getInstance().isDisabled();
+			
 			CastleManorManager.getInstance().setDisabled(!mode);
-			if (mode)
-				activeChar.sendMessage("Manor System: enabled");
-			else
-				activeChar.sendMessage("Manor System: disabled");
+			activeChar.sendMessage((mode) ? "Manor System: enabled" : "Manor System: disabled");
 			showMainPage(activeChar);
 		}
 		
 		return true;
-	}
-	
-	@Override
-	public String[] getAdminCommandList()
-	{
-		return _adminCommands;
 	}
 	
@@ -167,38 +169,24 @@
 	private static void showMainPage(L2PcInstance activeChar)
 	{
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		StringBuilder replyMSG = new StringBuilder("<html><body>");
+		final StringBuilder sb = new StringBuilder(500);
+		for (Castle c : CastleManager.getInstance().getCastles())
+			StringUtil.append(sb, "<tr><td>", c.getName(), "</td><td>", c.getManorCost(CastleManorManager.PERIOD_CURRENT), "a</td><td>", c.getManorCost(CastleManorManager.PERIOD_NEXT), "a</td></tr>");
 		
-		replyMSG.append("<center><font color=\"LEVEL\"> [Manor System] </font></center><br>");
-		replyMSG.append("<table width=\"100%\"><tr><td>");
-		replyMSG.append("Disabled: " + (CastleManorManager.getInstance().isDisabled() ? "yes" : "no") + "</td><td>");
-		replyMSG.append("Under Maintenance: " + (CastleManorManager.getInstance().isUnderMaintenance() ? "yes" : "no") + "</td></tr><tr><td>");
-		replyMSG.append("Time to refresh: " + formatTime(CastleManorManager.getInstance().getMillisToManorRefresh()) + "</td><td>");
-		replyMSG.append("Time to approve: " + formatTime(CastleManorManager.getInstance().getMillisToNextPeriodApprove()) + "</td></tr>");
-		replyMSG.append("</table>");
-		
-		replyMSG.append("<center><table><tr><td>");
-		replyMSG.append("<button value=\"Set Next\" action=\"bypass -h admin_manor_setnext\" width=110 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td><td>");
-		replyMSG.append("<button value=\"Approve Next\" action=\"bypass -h admin_manor_approve\" width=110 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td></tr><tr><td>");
-		replyMSG.append("<button value=\"" + (CastleManorManager.getInstance().isUnderMaintenance() ? "Set normal" : "Set mainteance") + "\" action=\"bypass -h admin_manor_setmaintenance\" width=110 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td><td>");
-		replyMSG.append("<button value=\"" + (CastleManorManager.getInstance().isDisabled() ? "Enable" : "Disable") + "\" action=\"bypass -h admin_manor_disable\" width=110 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td></tr><tr><td>");
-		replyMSG.append("<button value=\"Refresh\" action=\"bypass -h admin_manor\" width=110 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td><td>");
-		replyMSG.append("<button value=\"Back\" action=\"bypass -h admin_admin\" width=110 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td></tr>");
-		replyMSG.append("</table></center>");
-		
-		replyMSG.append("<br><center>Castle Information:<table width=\"100%\">");
-		replyMSG.append("<tr><td></td><td>Current Period</td><td>Next Period</td></tr>");
-		
-		for (Castle c : CastleManager.getInstance().getCastles())
-		{
-			replyMSG.append("<tr><td>" + c.getName() + "</td>" + "<td>" + c.getManorCost(CastleManorManager.PERIOD_CURRENT) + "a</td>" + "<td>" + c.getManorCost(CastleManorManager.PERIOD_NEXT) + "a</td>" + "</tr>");
-		}
-		
-		replyMSG.append("</table><br>");
-		
-		replyMSG.append("</body></html>");
-		
-		adminReply.setHtml(replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/manor.htm");
+		html.replace("%disabled%", String.valueOf(CastleManorManager.getInstance().isDisabled()));
+		html.replace("%maintenance%", String.valueOf(CastleManorManager.getInstance().isUnderMaintenance()));
+		html.replace("%refresh%", formatTime(CastleManorManager.getInstance().getMillisToManorRefresh()));
+		html.replace("%approve%", formatTime(CastleManorManager.getInstance().getMillisToNextPeriodApprove()));
+		html.replace("%value1%", (CastleManorManager.getInstance().isUnderMaintenance()) ? "Set normal" : "Set maintenance");
+		html.replace("%value2%", (CastleManorManager.getInstance().isDisabled()) ? "Enable" : "Disable");
+		html.replace("%castles%", sb.toString());
+		activeChar.sendPacket(html);
+	}
+	
+	@Override
+	public String[] getAdminCommandList()
+	{
+		return ADMIN_COMMANDS;
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminEditChar.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminEditChar.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminEditChar.java	(revision 345)
@@ -25,8 +25,7 @@
 import java.util.Map;
 import java.util.StringTokenizer;
-import java.util.logging.Logger;
 
-import net.sf.l2j.Config;
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.CharTemplateTable;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
@@ -46,10 +45,7 @@
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
 import net.sf.l2j.gameserver.util.Util;
-import net.sf.l2j.util.StringUtil;
 
 public class AdminEditChar implements IAdminCommandHandler
 {
-	private static Logger _log = Logger.getLogger(AdminEditChar.class.getName());
-	
 	private static final String[] ADMIN_COMMANDS =
 	{
@@ -193,6 +189,4 @@
 			catch (Exception e)
 			{
-				if (Config.DEVELOPER)
-					_log.warning("Set karma error: " + e);
 				activeChar.sendMessage("Usage: //setkarma <new_karma_value>");
 			}
@@ -295,5 +289,5 @@
 			{
 				String val = command.substring(14);
-				if (!Util.isValidPlayerName(val))
+				if (!StringUtil.isValidPlayerName(val))
 				{
 					activeChar.sendMessage("The new name doesn't fit with the regex pattern.");
@@ -492,54 +486,35 @@
 		else if (command.startsWith("admin_clan_info"))
 		{
-			String val;
-			L2PcInstance player;
-			try
-			{
-				val = command.substring(16);
-				player = L2World.getInstance().getPlayer(val);
-				if (player != null)
-				{
-					L2Clan clan = player.getClan();
-					if (clan != null)
-					{
-						try
-						{
-							NpcHtmlMessage msg = new NpcHtmlMessage(0);
-							msg.setFile("data/html/admin/claninfo.htm");
-							msg.replace("%clan_name%", clan.getName());
-							msg.replace("%clan_leader%", clan.getLeaderName());
-							msg.replace("%clan_level%", clan.getLevel());
-							msg.replace("%clan_has_castle%", clan.hasCastle() ? CastleManager.getInstance().getCastleById(clan.getCastleId()).getName() : "No");
-							msg.replace("%clan_has_clanhall%", clan.hasHideout() ? ClanHallManager.getInstance().getClanHallById(clan.getHideoutId()).getName() : "No");
-							msg.replace("%clan_points%", clan.getReputationScore());
-							msg.replace("%clan_players_count%", clan.getMembersCount());
-							msg.replace("%clan_ally%", clan.getAllyId() > 0 ? clan.getAllyName() : "Not in ally");
-							activeChar.sendPacket(msg);
-						}
-						catch (NullPointerException npe)
-						{
-							npe.printStackTrace();
-						}
-					}
-					else
-					{
-						activeChar.sendMessage("This player isn't in a clan.");
-						return false;
-					}
-				}
-				else
-				{
-					activeChar.sendMessage("Player is offline.");
-					return false;
-				}
-			}
-			catch (NumberFormatException nfe)
-			{
-				activeChar.sendMessage("This shouldn't happening.");
-				return false;
-			}
-			catch (Exception e)
-			{
-				e.printStackTrace();
+			try
+			{
+				final L2PcInstance player = L2World.getInstance().getPlayer(command.substring(16));
+				if (player == null)
+				{
+					activeChar.sendPacket(SystemMessageId.TARGET_CANT_FOUND);
+					return false;
+				}
+				
+				final L2Clan clan = player.getClan();
+				if (clan == null)
+				{
+					activeChar.sendMessage("This player isn't in a clan.");
+					return false;
+				}
+				
+				final NpcHtmlMessage html = new NpcHtmlMessage(0);
+				html.setFile("data/html/admin/claninfo.htm");
+				html.replace("%clan_name%", clan.getName());
+				html.replace("%clan_leader%", clan.getLeaderName());
+				html.replace("%clan_level%", clan.getLevel());
+				html.replace("%clan_has_castle%", (clan.hasCastle()) ? CastleManager.getInstance().getCastleById(clan.getCastleId()).getName() : "No");
+				html.replace("%clan_has_clanhall%", (clan.hasHideout()) ? ClanHallManager.getInstance().getClanHallById(clan.getHideoutId()).getName() : "No");
+				html.replace("%clan_points%", clan.getReputationScore());
+				html.replace("%clan_players_count%", clan.getMembersCount());
+				html.replace("%clan_ally%", (clan.getAllyId() > 0) ? clan.getAllyName() : "Not in ally");
+				activeChar.sendPacket(html);
+			}
+			catch (Exception e)
+			{
+				activeChar.sendPacket(SystemMessageId.TARGET_CANT_FOUND);
 			}
 		}
@@ -619,23 +594,26 @@
 			charactersEnd = charactersStart + maxCharactersPerPage;
 		
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/charlist.htm");
-		StringBuilder replyMSG = new StringBuilder();
-		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/charlist.htm");
+		
+		final StringBuilder sb = new StringBuilder(500);
+		
+		// First use of sb.
 		for (int x = 0; x < maxPages; x++)
 		{
 			int pagenr = x + 1;
-			replyMSG.append("<a action=\"bypass -h admin_show_characters " + x + "\">Page " + pagenr + "</a>");
-		}
-		adminReply.replace("%pages%", replyMSG.toString());
-		replyMSG.setLength(0);
-		
-		// Add player info into new Table row
+			sb.append("<a action=\"bypass -h admin_show_characters " + x + "\">Page " + pagenr + "</a>");
+		}
+		html.replace("%pages%", sb.toString());
+		
+		// Cleanup current sb.
+		sb.setLength(0);
+		
+		// Second use of sb, add player info into new table row.
 		for (int i = charactersStart; i < charactersEnd; i++)
-		{
-			replyMSG.append("<tr><td width=80><a action=\"bypass -h admin_character_info " + players[i].getName() + "\">" + players[i].getName() + "</a></td><td width=110>" + players[i].getTemplate().getClassName() + "</td><td width=40>" + players[i].getLevel() + "</td></tr>");
-		}
-		adminReply.replace("%players%", replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			sb.append("<tr><td width=80><a action=\"bypass -h admin_character_info " + players[i].getName() + "\">" + players[i].getName() + "</a></td><td width=110>" + players[i].getTemplate().getClassName() + "</td><td width=40>" + players[i].getLevel() + "</td></tr>");
+		
+		html.replace("%players%", sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -668,45 +646,45 @@
 		final String ip = clientInfo.substring(clientInfo.indexOf(" - IP: ") + 7, clientInfo.lastIndexOf("]"));
 		
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/" + filename);
-		adminReply.replace("%name%", player.getName());
-		adminReply.replace("%level%", player.getLevel());
-		adminReply.replace("%clan%", player.getClan() != null ? "<a action=\"bypass -h admin_clan_info " + player.getName() + "\">" + player.getClan().getName() + "</a>" : "none");
-		adminReply.replace("%xp%", player.getExp());
-		adminReply.replace("%sp%", player.getSp());
-		adminReply.replace("%class%", player.getTemplate().getClassName());
-		adminReply.replace("%ordinal%", player.getClassId().ordinal());
-		adminReply.replace("%classid%", player.getClassId().toString());
-		adminReply.replace("%baseclass%", CharTemplateTable.getInstance().getClassNameById(player.getBaseClass()));
-		adminReply.replace("%x%", player.getX());
-		adminReply.replace("%y%", player.getY());
-		adminReply.replace("%z%", player.getZ());
-		adminReply.replace("%currenthp%", (int) player.getCurrentHp());
-		adminReply.replace("%maxhp%", player.getMaxHp());
-		adminReply.replace("%karma%", player.getKarma());
-		adminReply.replace("%currentmp%", (int) player.getCurrentMp());
-		adminReply.replace("%maxmp%", player.getMaxMp());
-		adminReply.replace("%pvpflag%", player.getPvpFlag());
-		adminReply.replace("%currentcp%", (int) player.getCurrentCp());
-		adminReply.replace("%maxcp%", player.getMaxCp());
-		adminReply.replace("%pvpkills%", player.getPvpKills());
-		adminReply.replace("%pkkills%", player.getPkKills());
-		adminReply.replace("%currentload%", player.getCurrentLoad());
-		adminReply.replace("%maxload%", player.getMaxLoad());
-		adminReply.replace("%percent%", Util.roundTo(((float) player.getCurrentLoad() / (float) player.getMaxLoad()) * 100, 2));
-		adminReply.replace("%patk%", player.getPAtk(null));
-		adminReply.replace("%matk%", player.getMAtk(null, null));
-		adminReply.replace("%pdef%", player.getPDef(null));
-		adminReply.replace("%mdef%", player.getMDef(null, null));
-		adminReply.replace("%accuracy%", player.getAccuracy());
-		adminReply.replace("%evasion%", player.getEvasionRate(null));
-		adminReply.replace("%critical%", player.getCriticalHit(null, null));
-		adminReply.replace("%runspeed%", player.getRunSpeed());
-		adminReply.replace("%patkspd%", player.getPAtkSpd());
-		adminReply.replace("%matkspd%", player.getMAtkSpd());
-		adminReply.replace("%account%", account);
-		adminReply.replace("%ip%", ip);
-		adminReply.replace("%ai%", player.getAI().getIntention().name());
-		activeChar.sendPacket(adminReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/" + filename);
+		html.replace("%name%", player.getName());
+		html.replace("%level%", player.getLevel());
+		html.replace("%clan%", player.getClan() != null ? "<a action=\"bypass -h admin_clan_info " + player.getName() + "\">" + player.getClan().getName() + "</a>" : "none");
+		html.replace("%xp%", player.getExp());
+		html.replace("%sp%", player.getSp());
+		html.replace("%class%", player.getTemplate().getClassName());
+		html.replace("%ordinal%", player.getClassId().ordinal());
+		html.replace("%classid%", player.getClassId().toString());
+		html.replace("%baseclass%", CharTemplateTable.getInstance().getClassNameById(player.getBaseClass()));
+		html.replace("%x%", player.getX());
+		html.replace("%y%", player.getY());
+		html.replace("%z%", player.getZ());
+		html.replace("%currenthp%", (int) player.getCurrentHp());
+		html.replace("%maxhp%", player.getMaxHp());
+		html.replace("%karma%", player.getKarma());
+		html.replace("%currentmp%", (int) player.getCurrentMp());
+		html.replace("%maxmp%", player.getMaxMp());
+		html.replace("%pvpflag%", player.getPvpFlag());
+		html.replace("%currentcp%", (int) player.getCurrentCp());
+		html.replace("%maxcp%", player.getMaxCp());
+		html.replace("%pvpkills%", player.getPvpKills());
+		html.replace("%pkkills%", player.getPkKills());
+		html.replace("%currentload%", player.getCurrentLoad());
+		html.replace("%maxload%", player.getMaxLoad());
+		html.replace("%percent%", Util.roundTo(((float) player.getCurrentLoad() / (float) player.getMaxLoad()) * 100, 2));
+		html.replace("%patk%", player.getPAtk(null));
+		html.replace("%matk%", player.getMAtk(null, null));
+		html.replace("%pdef%", player.getPDef(null));
+		html.replace("%mdef%", player.getMDef(null, null));
+		html.replace("%accuracy%", player.getAccuracy());
+		html.replace("%evasion%", player.getEvasionRate(null));
+		html.replace("%critical%", player.getCriticalHit(null, null));
+		html.replace("%runspeed%", player.getRunSpeed());
+		html.replace("%patkspd%", player.getPAtkSpd());
+		html.replace("%matkspd%", player.getMAtkSpd());
+		html.replace("%account%", account);
+		html.replace("%ip%", ip);
+		html.replace("%ai%", player.getAI().getIntention().name());
+		activeChar.sendPacket(html);
 	}
 	
@@ -721,20 +699,11 @@
 		if (newKarma >= 0)
 		{
-			// for display
 			int oldKarma = player.getKarma();
-			// update karma
+			
 			player.setKarma(newKarma);
-			// Admin information
 			activeChar.sendMessage("You changed " + player.getName() + "'s karma from " + oldKarma + " to " + newKarma + ".");
-			if (Config.DEBUG)
-				_log.fine("[SET KARMA] [GM]" + activeChar.getName() + " changed " + player.getName() + "'s karma from " + oldKarma + " to " + newKarma + ".");
 		}
 		else
-		{
-			// tell admin of mistake
 			activeChar.sendMessage("The karma value must be greater or equal to 0.");
-			if (Config.DEBUG)
-				_log.fine("[SET KARMA] ERROR: [GM]" + activeChar.getName() + " entered an incorrect value for new karma: " + newKarma + " for " + player.getName() + ".");
-		}
 	}
 	
@@ -757,9 +726,10 @@
 		int charactersFound = 0;
 		
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/charfind.htm");
-		StringBuilder replyMSG = new StringBuilder();
-		
-		// Add player info into new Table row
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/charfind.htm");
+		
+		final StringBuilder sb = new StringBuilder();
+		
+		// First use of sb, add player info into new Table row
 		for (L2PcInstance player : L2World.getInstance().getAllPlayers().values())
 		{
@@ -768,27 +738,31 @@
 			{
 				charactersFound++;
-				replyMSG.append("<tr><td width=80><a action=\"bypass -h admin_character_list " + name + "\">" + name + "</a></td><td width=110>" + player.getTemplate().getClassName() + "</td><td width=40>" + player.getLevel() + "</td></tr>");
-			}
+				sb.append("<tr><td width=80><a action=\"bypass -h admin_character_list " + name + "\">" + name + "</a></td><td width=110>" + player.getTemplate().getClassName() + "</td><td width=40>" + player.getLevel() + "</td></tr>");
+			}
+			
 			if (charactersFound > 20)
 				break;
 		}
-		adminReply.replace("%results%", replyMSG.toString());
-		replyMSG.setLength(0);
-		
+		html.replace("%results%", sb.toString());
+		
+		// Cleanup sb.
+		sb.setLength(0);
+		
+		// Second use of sb.
 		if (charactersFound == 0)
-			replyMSG.append("s. Please try again.");
+			sb.append("s. Please try again.");
 		else if (charactersFound > 20)
 		{
-			adminReply.replace("%number%", " more than 20.");
-			replyMSG.append("s.<br>Please refine your search to see all of the results.");
+			html.replace("%number%", " more than 20.");
+			sb.append("s.<br>Please refine your search to see all of the results.");
 		}
 		else if (charactersFound == 1)
-			replyMSG.append(".");
+			sb.append(".");
 		else
-			replyMSG.append("s.");
-		
-		adminReply.replace("%number%", charactersFound);
-		adminReply.replace("%end%", replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			sb.append("s.");
+		
+		html.replace("%number%", charactersFound);
+		html.replace("%end%", sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -813,8 +787,8 @@
 		String ip = "0.0.0.0";
 		
-		final StringBuilder replyMSG = new StringBuilder(1000);
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/ipfind.htm");
-		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/ipfind.htm");
+		
+		final StringBuilder sb = new StringBuilder(1000);
 		for (L2PcInstance player : L2World.getInstance().getAllPlayers().values())
 		{
@@ -837,10 +811,10 @@
 			String name = player.getName();
 			charactersFound++;
-			StringUtil.append(replyMSG, "<tr><td width=80><a action=\"bypass -h admin_character_list ", name, "\">", name, "</a></td><td width=110>", player.getTemplate().getClassName(), "</td><td width=40>", String.valueOf(player.getLevel()), "</td></tr>");
+			StringUtil.append(sb, "<tr><td width=80><a action=\"bypass -h admin_character_list ", name, "\">", name, "</a></td><td width=110>", player.getTemplate().getClassName(), "</td><td width=40>", player.getLevel(), "</td></tr>");
 			
 			if (charactersFound > 20)
 				break;
 		}
-		adminReply.replace("%results%", replyMSG.toString());
+		html.replace("%results%", sb.toString());
 		
 		final String replyMSG2;
@@ -850,5 +824,5 @@
 		else if (charactersFound > 20)
 		{
-			adminReply.replace("%number%", " more than 20.");
+			html.replace("%number%", " more than 20.");
 			replyMSG2 = "s.";
 		}
@@ -858,44 +832,36 @@
 			replyMSG2 = "s.";
 		
-		adminReply.replace("%ip%", IpAdress);
-		adminReply.replace("%number%", charactersFound);
-		adminReply.replace("%end%", replyMSG2);
-		activeChar.sendPacket(adminReply);
+		html.replace("%ip%", IpAdress);
+		html.replace("%number%", charactersFound);
+		html.replace("%end%", replyMSG2);
+		activeChar.sendPacket(html);
 	}
 	
 	/**
+	 * Returns accountinfo.htm with
 	 * @param activeChar
 	 * @param characterName
-	 * @throws IllegalArgumentException
 	 */
-	private static void findCharactersPerAccount(L2PcInstance activeChar, String characterName) throws IllegalArgumentException
-	{
-		if (Util.isValidPlayerName(characterName))
-		{
-			String account = null;
-			Map<Integer, String> chars;
-			
-			L2PcInstance player = L2World.getInstance().getPlayer(characterName);
-			if (player == null)
-				throw new IllegalArgumentException("Player doesn't exist.");
-			
-			chars = player.getAccountChars();
-			account = player.getAccountName();
-			StringBuilder replyMSG = new StringBuilder();
-			NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-			
-			adminReply.setFile("data/html/admin/accountinfo.htm");
-			
-			for (String charname : chars.values())
-				replyMSG.append(charname + "<br1>");
-			
-			adminReply.replace("%characters%", replyMSG.toString());
-			adminReply.replace("%account%", account);
-			adminReply.replace("%player%", characterName);
-			
-			activeChar.sendPacket(adminReply);
-		}
-		else
-			throw new IllegalArgumentException("Malformed character name.");
+	private static void findCharactersPerAccount(L2PcInstance activeChar, String characterName)
+	{
+		if (!StringUtil.isValidPlayerName(characterName))
+		{
+			activeChar.sendMessage("Malformed character name.");
+			return;
+		}
+		
+		final L2PcInstance player = L2World.getInstance().getPlayer(characterName);
+		if (player == null)
+		{
+			activeChar.sendPacket(SystemMessageId.TARGET_CANT_FOUND);
+			return;
+		}
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/accountinfo.htm");
+		html.replace("%characters%", String.join("<br1>", player.getAccountChars().values()));
+		html.replace("%account%", player.getAccountName());
+		html.replace("%player%", characterName);
+		activeChar.sendPacket(html);
 	}
 	
@@ -945,32 +911,33 @@
 		Collections.reverse(keys);
 		
-		final StringBuilder results = new StringBuilder();
+		final StringBuilder sb = new StringBuilder();
 		for (String dualboxIP : keys)
-			StringUtil.append(results, "<a action=\"bypass -h admin_find_ip " + dualboxIP + "\">" + dualboxIP + " (" + dualboxIPs.get(dualboxIP) + ")</a><br1>");
-		
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/dualbox.htm");
-		adminReply.replace("%multibox%", multibox);
-		adminReply.replace("%results%", results.toString());
-		adminReply.replace("%strict%", "");
-		activeChar.sendPacket(adminReply);
+			StringUtil.append(sb, "<a action=\"bypass -h admin_find_ip ", dualboxIP, "\">", dualboxIP, " (", dualboxIPs.get(dualboxIP), ")</a><br1>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/dualbox.htm");
+		html.replace("%multibox%", multibox);
+		html.replace("%results%", sb.toString());
+		html.replace("%strict%", "");
+		activeChar.sendPacket(html);
 	}
 	
 	private static void gatherSummonInfo(L2Summon target, L2PcInstance activeChar)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
+		final String name = target.getName();
+		final String owner = target.getActingPlayer().getName();
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		html.setFile("data/html/admin/petinfo.htm");
-		String name = target.getName();
-		html.replace("%name%", name == null ? "N/A" : name);
-		html.replace("%level%", Integer.toString(target.getLevel()));
-		html.replace("%exp%", Long.toString(target.getStat().getExp()));
-		String owner = target.getActingPlayer().getName();
+		html.replace("%name%", (name == null) ? "N/A" : name);
+		html.replace("%level%", target.getLevel());
+		html.replace("%exp%", target.getStat().getExp());
 		html.replace("%owner%", " <a action=\"bypass -h admin_character_info " + owner + "\">" + owner + "</a>");
 		html.replace("%class%", target.getClass().getSimpleName());
-		html.replace("%ai%", target.hasAI() ? target.getAI().getIntention().name() : "NULL");
+		html.replace("%ai%", (target.hasAI()) ? target.getAI().getIntention().name() : "NULL");
 		html.replace("%hp%", (int) target.getStatus().getCurrentHp() + "/" + target.getStat().getMaxHp());
 		html.replace("%mp%", (int) target.getStatus().getCurrentMp() + "/" + target.getStat().getMaxMp());
-		html.replace("%karma%", Integer.toString(target.getKarma()));
-		html.replace("%undead%", target.isUndead() ? "yes" : "no");
+		html.replace("%karma%", target.getKarma());
+		html.replace("%undead%", (target.isUndead()) ? "yes" : "no");
 		
 		if (target instanceof L2PetInstance)
@@ -993,23 +960,16 @@
 	private static void gatherPartyInfo(L2PcInstance target, L2PcInstance activeChar)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
+		final StringBuilder sb = new StringBuilder(400);
+		for (L2PcInstance member : target.getParty().getPartyMembers())
+		{
+			if (member.getParty().getPartyLeaderOID() != member.getObjectId())
+				StringUtil.append(sb, "<tr><td><table width=270 border=0 cellpadding=2><tr><td width=30 align=right>", member.getLevel(), "</td><td width=130><a action=\"bypass -h admin_character_info ", member.getName(), "\">", member.getName(), "</a></td><td width=110 align=right>", member.getClassId().toString(), "</td></tr></table></td></tr>");
+			else
+				StringUtil.append(sb, "<tr><td><table width=270 border=0 cellpadding=2><tr><td width=30 align=right><font color=\"LEVEL\">", member.getLevel(), "</td><td width=130><a action=\"bypass -h admin_character_info ", member.getName(), "\">", member.getName(), " (Party leader)</a></td><td width=110 align=right>", member.getClassId().toString(), "</font></td></tr></table></td></tr>");
+		}
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		html.setFile("data/html/admin/partyinfo.htm");
-		StringBuilder text = new StringBuilder(400);
-		for (L2PcInstance member : target.getParty().getPartyMembers())
-		{
-			if (member.getParty().getPartyLeaderOID() != member.getObjectId())
-			{
-				text.append("<tr><td><table width=270 border=0 cellpadding=2><tr><td width=30 align=right>");
-				text.append(member.getLevel() + "</td><td width=130><a action=\"bypass -h admin_character_info " + member.getName() + "\">" + member.getName() + "</a>");
-				text.append("</td><td width=110 align=right>" + member.getClassId().toString() + "</td></tr></table></td></tr>");
-			}
-			else
-			{
-				text.append("<tr><td><table width=270 border=0 cellpadding=2><tr><td width=30 align=right><font color=\"LEVEL\">");
-				text.append(member.getLevel() + "</td><td width=130><a action=\"bypass -h admin_character_info " + member.getName() + "\">" + member.getName() + " (Party leader)</a>");
-				text.append("</td><td width=110 align=right>" + member.getClassId().toString() + "</font></td></tr></table></td></tr>");
-			}
-		}
-		html.replace("%party%", text.toString());
+		html.replace("%party%", sb.toString());
 		activeChar.sendPacket(html);
 	}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminKnownlist.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminKnownlist.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminKnownlist.java	(revision 345)
@@ -18,4 +18,5 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
 import net.sf.l2j.gameserver.model.L2Object;
@@ -24,5 +25,4 @@
 import net.sf.l2j.gameserver.model.actor.knownlist.ObjectKnownList;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -75,17 +75,15 @@
 			
 			// Generate data.
-			final StringBuilder replyMSG = new StringBuilder(list.size() * 200);
+			final StringBuilder sb = new StringBuilder(list.size() * 150);
 			for (L2Object object : list)
-			{
-				StringUtil.append(replyMSG, "<tr><td>" + object.getName() + "</td><td>" + object.getClass().getSimpleName() + "</td></tr>");
-			}
+				StringUtil.append(sb, "<tr><td>", object.getName(), "</td><td>", object.getClass().getSimpleName(), "</td></tr>");
 			
-			NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-			adminReply.setFile("data/html/admin/knownlist.htm");
-			adminReply.replace("%target%", target.getName());
-			adminReply.replace("%type%", knownlist.getClass().getSimpleName());
-			adminReply.replace("%size%", list.size());
-			adminReply.replace("%knownlist%", replyMSG.toString());
-			activeChar.sendPacket(adminReply);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
+			html.setFile("data/html/admin/knownlist.htm");
+			html.replace("%target%", target.getName());
+			html.replace("%type%", knownlist.getClass().getSimpleName());
+			html.replace("%size%", list.size());
+			html.replace("%knownlist%", sb.toString());
+			activeChar.sendPacket(html);
 		}
 		return true;
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminAdmin.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminAdmin.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminAdmin.java	(revision 345)
@@ -21,4 +21,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.cache.CrestCache;
 import net.sf.l2j.gameserver.cache.HtmCache;
@@ -43,5 +44,4 @@
 import net.sf.l2j.gameserver.network.SystemMessageId;
 import net.sf.l2j.gameserver.scripting.L2ScriptEngineManager;
-import net.sf.l2j.gameserver.util.Util;
 
 /**
@@ -109,5 +109,5 @@
 				{
 					String secondParam = st.nextToken();
-					if (Util.isDigit(secondParam))
+					if (StringUtil.isDigit(secondParam))
 					{
 						int radius = Integer.parseInt(secondParam);
@@ -127,5 +127,5 @@
 					kill(activeChar, player);
 			}
-			else if (Util.isDigit(firstParam))
+			else if (StringUtil.isDigit(firstParam))
 			{
 				int radius = Integer.parseInt(firstParam);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminRideWyvern.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminRideWyvern.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminRideWyvern.java	(revision 345)
@@ -42,5 +42,4 @@
 			}
 			
-			String mount = "";
 			StringTokenizer st = new StringTokenizer(command, " ");
 			st.nextToken(); // skip command
@@ -48,5 +47,5 @@
 			if (st.hasMoreTokens())
 			{
-				mount = st.nextToken();
+				String mount = st.nextToken();
 				
 				if (mount.equals("wyvern") || mount.equals("2"))
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminZone.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminZone.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminZone.java	(revision 345)
@@ -17,14 +17,13 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.MapRegionTable;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
 import net.sf.l2j.gameserver.instancemanager.ZoneManager;
 import net.sf.l2j.gameserver.model.L2World;
-import net.sf.l2j.gameserver.model.L2WorldRegion;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.zone.L2ZoneType;
 import net.sf.l2j.gameserver.model.zone.ZoneId;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.util.StringUtil;
 
 public class AdminZone implements IAdminCommandHandler
@@ -80,43 +79,39 @@
 		int ry = (y - L2World.WORLD_Y_MIN) / L2World.TILE_SIZE + L2World.TILE_Y_MIN;
 		
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/zone.htm");
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/zone.htm");
 		
-		adminReply.replace("%MAPREGION%", "[x:" + MapRegionTable.getMapRegionX(x) + " y:" + MapRegionTable.getMapRegionY(y) + "]");
-		adminReply.replace("%GEOREGION%", rx + "_" + ry);
-		adminReply.replace("%CLOSESTTOWN%", MapRegionTable.getInstance().getClosestTownName(x, y));
-		adminReply.replace("%CURRENTLOC%", x + ", " + y + ", " + activeChar.getZ());
+		html.replace("%MAPREGION%", "[x:" + MapRegionTable.getMapRegionX(x) + " y:" + MapRegionTable.getMapRegionY(y) + "]");
+		html.replace("%GEOREGION%", rx + "_" + ry);
+		html.replace("%CLOSESTTOWN%", MapRegionTable.getInstance().getClosestTownName(x, y));
+		html.replace("%CURRENTLOC%", x + ", " + y + ", " + activeChar.getZ());
 		
-		adminReply.replace("%PVP%", (activeChar.isInsideZone(ZoneId.PVP) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%PEACE%", (activeChar.isInsideZone(ZoneId.PEACE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%SIEGE%", (activeChar.isInsideZone(ZoneId.SIEGE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%MOTHERTREE%", (activeChar.isInsideZone(ZoneId.MOTHER_TREE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%CLANHALL%", (activeChar.isInsideZone(ZoneId.CLAN_HALL) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%NOLANDING%", (activeChar.isInsideZone(ZoneId.NO_LANDING) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%WATER%", (activeChar.isInsideZone(ZoneId.WATER) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%JAIL%", (activeChar.isInsideZone(ZoneId.JAIL) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%MONSTERTRACK%", (activeChar.isInsideZone(ZoneId.MONSTER_TRACK) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%CASTLE%", (activeChar.isInsideZone(ZoneId.CASTLE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%SWAMP%", (activeChar.isInsideZone(ZoneId.SWAMP) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%NOSUMMONFRIEND%", (activeChar.isInsideZone(ZoneId.NO_SUMMON_FRIEND) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%NOSTORE%", (activeChar.isInsideZone(ZoneId.NO_STORE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%TOWN%", (activeChar.isInsideZone(ZoneId.TOWN) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%HQ%", (activeChar.isInsideZone(ZoneId.HQ) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%DANGERAREA%", (activeChar.isInsideZone(ZoneId.DANGER_AREA) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%CASTONARTIFACT%", (activeChar.isInsideZone(ZoneId.CAST_ON_ARTIFACT) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
-		adminReply.replace("%NORESTART%", (activeChar.isInsideZone(ZoneId.NO_RESTART) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%PVP%", (activeChar.isInsideZone(ZoneId.PVP) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%PEACE%", (activeChar.isInsideZone(ZoneId.PEACE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%SIEGE%", (activeChar.isInsideZone(ZoneId.SIEGE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%MOTHERTREE%", (activeChar.isInsideZone(ZoneId.MOTHER_TREE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%CLANHALL%", (activeChar.isInsideZone(ZoneId.CLAN_HALL) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%NOLANDING%", (activeChar.isInsideZone(ZoneId.NO_LANDING) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%WATER%", (activeChar.isInsideZone(ZoneId.WATER) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%JAIL%", (activeChar.isInsideZone(ZoneId.JAIL) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%MONSTERTRACK%", (activeChar.isInsideZone(ZoneId.MONSTER_TRACK) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%CASTLE%", (activeChar.isInsideZone(ZoneId.CASTLE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%SWAMP%", (activeChar.isInsideZone(ZoneId.SWAMP) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%NOSUMMONFRIEND%", (activeChar.isInsideZone(ZoneId.NO_SUMMON_FRIEND) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%NOSTORE%", (activeChar.isInsideZone(ZoneId.NO_STORE) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%TOWN%", (activeChar.isInsideZone(ZoneId.TOWN) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%HQ%", (activeChar.isInsideZone(ZoneId.HQ) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%DANGERAREA%", (activeChar.isInsideZone(ZoneId.DANGER_AREA) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%CASTONARTIFACT%", (activeChar.isInsideZone(ZoneId.CAST_ON_ARTIFACT) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
+		html.replace("%NORESTART%", (activeChar.isInsideZone(ZoneId.NO_RESTART) ? "<font color=\"LEVEL\">YES</font>" : "NO"));
 		
-		StringBuilder zones = new StringBuilder(100);
-		L2WorldRegion region = L2World.getInstance().getRegion(x, y);
-		for (L2ZoneType zone : region.getZones())
+		final StringBuilder sb = new StringBuilder(100);
+		for (L2ZoneType zone : L2World.getInstance().getRegion(x, y).getZones())
 		{
 			if (zone.isCharacterInZone(activeChar))
-			{
-				StringUtil.append(zones, String.valueOf(zone.getId()));
-				StringUtil.append(zones, " ");
-			}
+				StringUtil.append(sb, zone.getId(), " ");
 		}
-		adminReply.replace("%ZLIST%", zones.toString());
-		activeChar.sendPacket(adminReply);
+		html.replace("%ZLIST%", sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSkill.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSkill.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSkill.java	(revision 345)
@@ -16,7 +16,6 @@
 
 import java.util.StringTokenizer;
-import java.util.logging.Logger;
 
-import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.SkillTable;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
@@ -29,12 +28,7 @@
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
-import net.sf.l2j.util.StringUtil;
 
-/**
- * This class handles following admin commands: - show_skills - remove_skills - skill_list - skill_index - add_skill - remove_skill - get_skills - reset_skills - give_all_skills - remove_all_skills - add_clan_skills
- */
 public class AdminSkill implements IAdminCommandHandler
 {
-	private static Logger _log = Logger.getLogger(AdminSkill.class.getName());
 	private static final String[] ADMIN_COMMANDS =
 	{
@@ -228,23 +222,20 @@
 			skillsEnd = skillsStart + maxSkillsPerPage;
 		
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		final StringBuilder replyMSG = StringUtil.startAppend(500 + maxPages * 50 + (skillsEnd - skillsStart + 1) * 50, "<html><body>" + "<table width=270><tr>" + "<td width=45><button value=\"Main\" action=\"bypass -h admin_admin\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td>" + "<td width=180><center>Delete Skills Menu</center></td>" + "<td width=45><button value=\"Back\" action=\"bypass -h admin_show_skills\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td>" + "</tr></table>" + "<br><br>" + "<center>Editing <font color=\"LEVEL\">", player.getName(), "</font>" + ", ", player.getTemplate().getClassName(), " lvl ", String.valueOf(player.getLevel()), ".<br><center><table width=270><tr>");
+		final StringBuilder sb = new StringBuilder(3000);
+		StringUtil.append(sb, "<html><body><table width=270><tr><td width=45><button value=\"Main\" action=\"bypass -h admin_admin\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td><td width=180><center>Delete Skills Menu</center></td><td width=45><button value=\"Back\" action=\"bypass -h admin_show_skills\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td></tr></table><br><br><center>Editing <font color=\"LEVEL\">", player.getName(), "</font>, ", player.getTemplate().getClassName(), " lvl ", player.getLevel(), ".<br><center><table width=270><tr>");
 		
 		for (int x = 0; x < maxPages; x++)
-		{
-			int pagenr = x + 1;
-			StringUtil.append(replyMSG, "<td><a action=\"bypass -h admin_remove_skills ", String.valueOf(x), "\">Page ", String.valueOf(pagenr), "</a></td>");
-		}
-		
-		replyMSG.append("</tr></table></center>" + "<br><table width=270>" + "<tr><td width=80>Name:</td><td width=60>Level:</td><td width=40>Id:</td></tr>");
+			StringUtil.append(sb, "<td><a action=\"bypass -h admin_remove_skills ", x, "\">Page ", x + 1, "</a></td>");
+		
+		sb.append("</tr></table></center><br><table width=270><tr><td width=80>Name:</td><td width=60>Level:</td><td width=40>Id:</td></tr>");
 		
 		for (int i = skillsStart; i < skillsEnd; i++)
-		{
-			StringUtil.append(replyMSG, "<tr><td width=80><a action=\"bypass -h admin_remove_skill ", String.valueOf(skills[i].getId()), "\">", skills[i].getName(), "</a></td><td width=60>", String.valueOf(skills[i].getLevel()), "</td><td width=40>", String.valueOf(skills[i].getId()), "</td></tr>");
-		}
-		
-		replyMSG.append("</table>" + "<br><center><table width=200>" + "<tr><td width=50 align=right>Id: </td>" + "<td><edit var=\"id_to_remove\" width=55></td>" + "<td width=100><button value=\"Remove skill\" action=\"bypass -h admin_remove_skill $id_to_remove\" width=95 height=21 back=\"bigbutton_over\" fore=\"bigbutton\"></td></tr>" + "<tr><td></td><td></td>" + "<td><button value=\"Back to stats\" action=\"bypass -h admin_current_player\" width=95 height=21 back=\"bigbutton_over\" fore=\"bigbutton\"></td>" + "</tr></table></center>" + "</body></html>");
-		adminReply.setHtml(replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			StringUtil.append(sb, "<tr><td width=80><a action=\"bypass -h admin_remove_skill ", skills[i].getId(), "\">", skills[i].getName(), "</a></td><td width=60>", skills[i].getLevel(), "</td><td width=40>", skills[i].getId(), "</td></tr>");
+		
+		sb.append("</table><br><center><table width=200><tr><td width=50 align=right>Id: </td><td><edit var=\"id_to_remove\" width=55></td><td width=100><button value=\"Remove skill\" action=\"bypass -h admin_remove_skill $id_to_remove\" width=95 height=21 back=\"bigbutton_over\" fore=\"bigbutton\"></td></tr><tr><td></td><td></td><td><button value=\"Back to stats\" action=\"bypass -h admin_current_player\" width=95 height=21 back=\"bigbutton_over\" fore=\"bigbutton\"></td></tr></table></center></body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -261,10 +252,10 @@
 		}
 		
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/charskills.htm");
-		adminReply.replace("%name%", player.getName());
-		adminReply.replace("%level%", player.getLevel());
-		adminReply.replace("%class%", player.getTemplate().getClassName());
-		activeChar.sendPacket(adminReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/charskills.htm");
+		html.replace("%name%", player.getName());
+		html.replace("%level%", player.getLevel());
+		html.replace("%class%", player.getTemplate().getClassName());
+		activeChar.sendPacket(html);
 	}
 	
@@ -363,7 +354,4 @@
 					activeChar.sendMessage("You gave the skill " + name + " to " + player.getName() + ".");
 				
-				if (Config.DEBUG)
-					_log.fine("[GM]" + activeChar.getName() + " gave skill " + name + " to " + player.getName() + ".");
-				
 				player.sendSkillList();
 			}
@@ -398,7 +386,4 @@
 				player.sendMessage("Admin removed the skill " + skillname + " from your skills list.");
 			
-			if (Config.DEBUG)
-				_log.fine("[GM]" + activeChar.getName() + " removed skill " + skillname + " from " + player.getName() + ".");
-			
 			player.sendSkillList();
 		}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminPForge.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminPForge.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminPForge.java	(revision 345)
@@ -17,4 +17,5 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
@@ -162,27 +163,33 @@
 	private static void showPage2(L2PcInstance activeChar, String format)
 	{
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/pforge2.htm");
-		adminReply.replace("%format%", format);
-		
-		StringBuilder replyMSG = new StringBuilder();
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/pforge2.htm");
+		html.replace("%format%", format);
+		
+		final StringBuilder sb = new StringBuilder();
+		
+		// First use of sb.
 		for (int i = 0; i < format.length(); i++)
-			replyMSG.append(format.charAt(i) + " : <edit var=\"v" + i + "\" width=100><br1>");
-		adminReply.replace("%valueditors%", replyMSG.toString());
-		replyMSG.setLength(0);
-		
+			StringUtil.append(sb, format.charAt(i), " : <edit var=\"v", i, "\" width=100><br1>");
+		html.replace("%valueditors%", sb.toString());
+		
+		// Cleanup sb.
+		sb.setLength(0);
+		
+		// Second use of sb.
 		for (int i = 0; i < format.length(); i++)
-			replyMSG.append(" \\$v" + i);
-		adminReply.basicReplace("%send%", replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			StringUtil.append(sb, " \\$v", i);
+		
+		html.basicReplace("%send%", sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
 	private static void showPage3(L2PcInstance activeChar, String format, String command)
 	{
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/pforge3.htm");
-		adminReply.replace("%format%", format);
-		adminReply.replace("%command%", command);
-		activeChar.sendPacket(adminReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/pforge3.htm");
+		html.replace("%format%", format);
+		html.replace("%command%", command);
+		activeChar.sendPacket(html);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminCursedWeapons.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminCursedWeapons.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminCursedWeapons.java	(revision 345)
@@ -15,7 +15,7 @@
 package net.sf.l2j.gameserver.handler.admincommandhandlers;
 
-import java.util.Collection;
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.handler.IAdminCommandHandler;
 import net.sf.l2j.gameserver.instancemanager.CursedWeaponsManager;
@@ -25,5 +25,4 @@
 import net.sf.l2j.gameserver.network.SystemMessageId;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -52,7 +51,4 @@
 	public boolean useAdminCommand(String command, L2PcInstance activeChar)
 	{
-		CursedWeaponsManager cwm = CursedWeaponsManager.getInstance();
-		int id = 0;
-		
 		StringTokenizer st = new StringTokenizer(command);
 		st.nextToken();
@@ -63,5 +59,5 @@
 			{
 				activeChar.sendMessage("====== Cursed Weapons: ======");
-				for (CursedWeapon cw : cwm.getCursedWeapons())
+				for (CursedWeapon cw : CursedWeaponsManager.getInstance().getCursedWeapons())
 				{
 					activeChar.sendMessage(cw.getName() + " (" + cw.getItemId() + ")");
@@ -101,13 +97,8 @@
 			else
 			{
-				final Collection<CursedWeapon> cws = cwm.getCursedWeapons();
-				final StringBuilder replyMSG = new StringBuilder(cws.size() * 600);
-				NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-				adminReply.setFile("data/html/admin/cwinfo.htm");
-				for (CursedWeapon cw : cwm.getCursedWeapons())
-				{
-					int itemId = cw.getItemId();
-					
-					StringUtil.append(replyMSG, "<table width=280><tr><td>Name:</td><td>", cw.getName(), "</td></tr>");
+				final StringBuilder sb = new StringBuilder(2000);
+				for (CursedWeapon cw : CursedWeaponsManager.getInstance().getCursedWeapons())
+				{
+					StringUtil.append(sb, "<table width=280><tr><td>Name:</td><td>", cw.getName(), "</td></tr>");
 					
 					if (cw.isActive())
@@ -125,28 +116,29 @@
 						{
 							L2PcInstance pl = cw.getPlayer();
-							StringUtil.append(replyMSG, "<tr><td>Owner:</td><td>", (pl == null ? "null" : pl.getName()), "</td></tr>" + "<tr><td>Stored values:</td><td>Karma=", String.valueOf(cw.getPlayerKarma()), " PKs=", String.valueOf(cw.getPlayerPkKills()), "</td></tr>" + "<tr><td>Current stage:</td><td>", String.valueOf(cw.getCurrentStage()), "</td></tr>" + "<tr><td>Overall time:</td><td>", String.valueOf(numDays), "d. ", String.valueOf(numHours), "h. ", String.valueOf(numMins), "m.</td></tr>" + "<tr><td>Hungry time:</td><td>", String.valueOf(cw.getHungryTime()), "m.</td></tr>" + "<tr><td>Current kills:</td><td>", String.valueOf(cw.getNbKills()), " / ", String.valueOf(cw.getNumberBeforeNextStage()), "</td></tr>" + "<tr><td><button value=\"Remove\" action=\"bypass -h admin_cw_remove ", String.valueOf(itemId), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td>" + "<td><button value=\"Go\" action=\"bypass -h admin_cw_goto ", String.valueOf(itemId), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td></tr>");
+							StringUtil.append(sb, "<tr><td>Owner:</td><td>", ((pl == null) ? "null" : pl.getName()), "</td></tr><tr><td>Stored values:</td><td>Karma=", cw.getPlayerKarma(), " PKs=", cw.getPlayerPkKills(), "</td></tr><tr><td>Current stage:</td><td>", cw.getCurrentStage(), "</td></tr><tr><td>Overall time:</td><td>", numDays, "d. ", numHours, "h. ", numMins, "m.</td></tr><tr><td>Hungry time:</td><td>", cw.getHungryTime(), "m.</td></tr><tr><td>Current kills:</td><td>", cw.getNbKills(), " / ", cw.getNumberBeforeNextStage(), "</td></tr><tr><td><button value=\"Remove\" action=\"bypass -h admin_cw_remove ", cw.getItemId(), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td><td><button value=\"Go\" action=\"bypass -h admin_cw_goto ", cw.getItemId(), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td></tr>");
 						}
 						else if (cw.isDropped())
-						{
-							StringUtil.append(replyMSG, "<tr><td>Position:</td><td>Lying on the ground</td></tr>" + "<tr><td>Overall time:</td><td>", String.valueOf(numDays), "d. ", String.valueOf(numHours), "h. ", String.valueOf(numMins), "m.</td></tr>" + "<tr><td><button value=\"Remove\" action=\"bypass -h admin_cw_remove ", String.valueOf(itemId), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td>" + "<td><button value=\"Go\" action=\"bypass -h admin_cw_goto ", String.valueOf(itemId), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td></tr>");
-						}
+							StringUtil.append(sb, "<tr><td>Position:</td><td>Lying on the ground</td></tr><tr><td>Overall time:</td><td>", numDays, "d. ", numHours, "h. ", numMins, "m.</td></tr><tr><td><button value=\"Remove\" action=\"bypass -h admin_cw_remove ", cw.getItemId(), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td><td><button value=\"Go\" action=\"bypass -h admin_cw_goto ", cw.getItemId(), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td></tr>");
 					}
 					else
-					{
-						StringUtil.append(replyMSG, "<tr><td>Position:</td><td>Doesn't exist.</td></tr>" + "<tr><td><button value=\"Give to Target\" action=\"bypass -h admin_cw_add ", String.valueOf(itemId), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td><td></td></tr>");
-					}
+						StringUtil.append(sb, "<tr><td>Position:</td><td>Doesn't exist.</td></tr><tr><td><button value=\"Give to Target\" action=\"bypass -h admin_cw_add ", cw.getItemId(), "\" width=75 height=21 back=\"L2UI_ch3.Btn1_normalOn\" fore=\"L2UI_ch3.Btn1_normal\"></td><td></td></tr>");
 					
-					replyMSG.append("</table><br>");
-				}
-				adminReply.replace("%cwinfo%", replyMSG.toString());
-				activeChar.sendPacket(adminReply);
+					sb.append("</table><br>");
+				}
+				
+				final NpcHtmlMessage html = new NpcHtmlMessage(0);
+				html.setFile("data/html/admin/cwinfo.htm");
+				html.replace("%cwinfo%", sb.toString());
+				activeChar.sendPacket(html);
 			}
 		}
 		else if (command.startsWith("admin_cw_reload"))
-			cwm.reload();
+			CursedWeaponsManager.getInstance().reload();
 		else
 		{
 			try
 			{
+				int id = 0;
+				
 				String parameter = st.nextToken();
 				if (parameter.matches("[0-9]*"))
@@ -155,5 +147,5 @@
 				{
 					parameter = parameter.replace('_', ' ');
-					for (CursedWeapon cwp : cwm.getCursedWeapons())
+					for (CursedWeapon cwp : CursedWeaponsManager.getInstance().getCursedWeapons())
 					{
 						if (cwp.getName().toLowerCase().contains(parameter.toLowerCase()))
@@ -165,5 +157,5 @@
 				}
 				
-				final CursedWeapon cw = cwm.getCursedWeapon(id);
+				final CursedWeapon cw = CursedWeaponsManager.getInstance().getCursedWeapon(id);
 				if (cw == null)
 				{
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminMaintenance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminMaintenance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminMaintenance.java	(revision 345)
@@ -107,13 +107,13 @@
 	private static void sendHtmlForm(L2PcInstance activeChar)
 	{
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/maintenance.htm");
-		adminReply.replace("%count%", L2World.getInstance().getAllPlayersCount());
-		adminReply.replace("%used%", Math.round((int) ((Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory()) / 1048576)));
-		adminReply.replace("%server_name%", LoginServerThread.getInstance().getServerName());
-		adminReply.replace("%status%", LoginServerThread.getInstance().getStatusString());
-		adminReply.replace("%max_players%", LoginServerThread.getInstance().getMaxPlayer());
-		adminReply.replace("%time%", GameTimeTaskManager.getInstance().getGameTimeFormated());
-		activeChar.sendPacket(adminReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/maintenance.htm");
+		html.replace("%count%", L2World.getInstance().getAllPlayersCount());
+		html.replace("%used%", Math.round((int) ((Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory()) / 1048576)));
+		html.replace("%server_name%", LoginServerThread.getInstance().getServerName());
+		html.replace("%status%", LoginServerThread.getInstance().getStatusString());
+		html.replace("%max_players%", LoginServerThread.getInstance().getMaxPlayer());
+		html.replace("%time%", GameTimeTaskManager.getInstance().getGameTimeFormated());
+		activeChar.sendPacket(html);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminHelpPage.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminHelpPage.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminHelpPage.java	(revision 345)
@@ -57,7 +57,7 @@
 	public static void showHelpPage(L2PcInstance targetChar, String filename)
 	{
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setFile("data/html/admin/" + filename);
-		targetChar.sendPacket(adminReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/admin/" + filename);
+		targetChar.sendPacket(html);
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminEditNpc.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminEditNpc.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminEditNpc.java	(revision 345)
@@ -19,4 +19,5 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.BuyListTable;
 import net.sf.l2j.gameserver.datatables.ItemTable;
@@ -36,5 +37,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
 import net.sf.l2j.gameserver.templates.skills.L2SkillType;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -131,26 +131,15 @@
 		}
 		
-		final StringBuilder replyMSG = new StringBuilder();
-		replyMSG.append("<html><body><center><font color=\"LEVEL\">");
-		replyMSG.append(NpcTable.getInstance().getTemplate(buyList.getNpcId()).getName());
-		replyMSG.append(" (");
-		replyMSG.append(buyList.getNpcId());
-		replyMSG.append(") buylist id: ");
-		replyMSG.append(buyList.getListId());
-		replyMSG.append("</font></center><br><table width=\"100%\"><tr><td width=200>Item</td><td width=80>Price</td></tr>");
+		final StringBuilder sb = new StringBuilder(500);
+		StringUtil.append(sb, "<html><body><center><font color=\"LEVEL\">", NpcTable.getInstance().getTemplate(buyList.getNpcId()).getName(), " (", buyList.getNpcId(), ") buylist id: ", buyList.getListId(), "</font></center><br><table width=\"100%\"><tr><td width=200>Item</td><td width=80>Price</td></tr>");
 		
 		for (Product product : buyList.getProducts())
-		{
-			replyMSG.append("<tr><td>");
-			replyMSG.append(product.getItem().getName());
-			replyMSG.append("</td><td>");
-			replyMSG.append(product.getPrice());
-			replyMSG.append("</td></tr>");
-		}
-		replyMSG.append("</table></body></html>");
-		
-		final NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setHtml(replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			StringUtil.append(sb, "<tr><td>", product.getItem().getName(), "</td><td>", product.getPrice(), "</td></tr>");
+		
+		sb.append("</table></body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -164,6 +153,6 @@
 		}
 		
-		final StringBuilder replyMSG = new StringBuilder();
-		StringUtil.append(replyMSG, "<html><title>Merchant Shop Lists</title><body>");
+		final StringBuilder sb = new StringBuilder(500);
+		StringUtil.append(sb, "<html><title>Merchant Shop Lists</title><body>");
 		
 		if (activeChar.getTarget() instanceof L2MerchantInstance)
@@ -172,17 +161,17 @@
 			int taxRate = merchant.getCastle().getTaxPercent();
 			
-			StringUtil.append(replyMSG, "<center><font color=\"LEVEL\">", merchant.getName(), " (", Integer.toString(npcId), ")</font></center><br>Tax rate: ", Integer.toString(taxRate), "%");
-		}
-		
-		StringUtil.append(replyMSG, "<table width=\"100%\">");
+			StringUtil.append(sb, "<center><font color=\"LEVEL\">", merchant.getName(), " (", npcId, ")</font></center><br>Tax rate: ", taxRate, "%");
+		}
+		
+		StringUtil.append(sb, "<table width=\"100%\">");
 		
 		for (NpcBuyList buyList : buyLists)
-			StringUtil.append(replyMSG, "<tr><td><a action=\"bypass -h admin_show_shoplist ", String.valueOf(buyList.getListId()), " 1\">Buylist id: ", String.valueOf(buyList.getListId()), "</a></td></tr>");
-		
-		StringUtil.append(replyMSG, "</table></body></html>");
-		
-		final NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setHtml(replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			StringUtil.append(sb, "<tr><td><a action=\"bypass -h admin_show_shoplist ", buyList.getListId(), " 1\">Buylist id: ", buyList.getListId(), "</a></td></tr>");
+		
+		StringUtil.append(sb, "</table></body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -196,16 +185,10 @@
 		}
 		
-		final StringBuilder replyMSG = new StringBuilder(2000);
-		replyMSG.append("<html><title>Show droplist page ");
-		replyMSG.append(page);
-		replyMSG.append("</title><body><center><font color=\"LEVEL\">");
-		replyMSG.append(npcData.getName());
-		replyMSG.append(" (");
-		replyMSG.append(npcId);
-		replyMSG.append(")</font></center><br>");
+		final StringBuilder sb = new StringBuilder(2000);
+		StringUtil.append(sb, "<html><title>Show droplist page ", page, "</title><body><center><font color=\"LEVEL\">", npcData.getName(), " (", npcId, ")</font></center><br>");
 		
 		if (!npcData.getDropData().isEmpty())
 		{
-			replyMSG.append("Drop type legend: <font color=\"3BB9FF\">Drop</font> | <font color=\"00ff00\">Sweep</font><br><table><tr><td width=25>cat.</td><td width=255>item</td></tr>");
+			sb.append("Drop type legend: <font color=\"3BB9FF\">Drop</font> | <font color=\"00ff00\">Sweep</font><br><table><tr><td width=25>cat.</td><td width=255>item</td></tr>");
 			
 			int myPage = 1;
@@ -224,6 +207,4 @@
 				for (DropData drop : cat.getAllDrops())
 				{
-					final String color = ((cat.isSweep()) ? "00FF00" : "3BB9FF");
-					
 					if (myPage != page)
 					{
@@ -243,32 +224,16 @@
 					}
 					
-					replyMSG.append("<tr><td><font color=\"");
-					replyMSG.append(color);
-					replyMSG.append("\">");
-					replyMSG.append(cat.getCategoryType());
-					replyMSG.append("</td><td>");
-					replyMSG.append(ItemTable.getInstance().getTemplate(drop.getItemId()).getName());
-					replyMSG.append(" (");
-					replyMSG.append(drop.getItemId());
-					replyMSG.append(")</td></tr>");
+					StringUtil.append(sb, "<tr><td><font color=\"", ((cat.isSweep()) ? "00FF00" : "3BB9FF"), "\">", cat.getCategoryType(), "</td><td>", ItemTable.getInstance().getTemplate(drop.getItemId()).getName(), " (", drop.getItemId(), ")</td></tr>");
 					shown++;
 				}
 			}
 			
-			replyMSG.append("</table><table width=\"100%\" bgcolor=666666><tr>");
+			sb.append("</table><table width=\"100%\" bgcolor=666666><tr>");
 			
 			if (page > 1)
 			{
-				replyMSG.append("<td width=120><a action=\"bypass -h admin_show_droplist ");
-				replyMSG.append(npcId);
-				replyMSG.append(" ");
-				replyMSG.append(page - 1);
-				replyMSG.append("\">Prev Page</a></td>");
+				StringUtil.append(sb, "<td width=120><a action=\"bypass -h admin_show_droplist ", npcId, " ", page - 1, "\">Prev Page</a></td>");
 				if (!hasMore)
-				{
-					replyMSG.append("<td width=100>Page ");
-					replyMSG.append(page);
-					replyMSG.append("</td><td width=70></td></tr>");
-				}
+					StringUtil.append(sb, "<td width=100>Page ", page, "</td><td width=70></td></tr>");
 			}
 			
@@ -276,23 +241,18 @@
 			{
 				if (page <= 1)
-					replyMSG.append("<td width=120></td>");
-				replyMSG.append("<td width=100>Page ");
-				replyMSG.append(page);
-				replyMSG.append("</td><td width=70><a action=\"bypass -h admin_show_droplist ");
-				replyMSG.append(npcId);
-				replyMSG.append(" ");
-				replyMSG.append(page + 1);
-				replyMSG.append("\">Next Page</a></td></tr>");
-			}
-			replyMSG.append("</table>");
+					sb.append("<td width=120></td>");
+				
+				StringUtil.append(sb, "<td width=100>Page ", page, "</td><td width=70><a action=\"bypass -h admin_show_droplist ", npcId, " ", page + 1, "\">Next Page</a></td></tr>");
+			}
+			sb.append("</table>");
 		}
 		else
-			replyMSG.append("This NPC has no drops.");
-		
-		replyMSG.append("</body></html>");
-		
-		final NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setHtml(replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			sb.append("This NPC has no drops.");
+		
+		sb.append("</body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -308,28 +268,15 @@
 		final L2Skill[] skills = npcData.getSkillsArray();
 		
-		final StringBuilder replyMSG = new StringBuilder();
-		replyMSG.append("<html><body><center><font color=\"LEVEL\">");
-		replyMSG.append(npcData.getName());
-		replyMSG.append(" (");
-		replyMSG.append(npcId);
-		replyMSG.append("): ");
-		replyMSG.append(skills.length);
-		replyMSG.append(" skills</font></center><table width=\"100%\">");
+		final StringBuilder sb = new StringBuilder(500);
+		StringUtil.append(sb, "<html><body><center><font color=\"LEVEL\">", npcData.getName(), " (", npcId, "): ", skills.length, " skills</font></center><table width=\"100%\">");
 		
 		for (L2Skill skill : skills)
-		{
-			replyMSG.append("<tr><td>");
-			replyMSG.append((skill.getSkillType() == L2SkillType.NOTDONE) ? ("<font color=\"777777\">" + skill.getName() + "</font>") : skill.getName());
-			replyMSG.append(" [");
-			replyMSG.append(skill.getId());
-			replyMSG.append("-");
-			replyMSG.append(skill.getLevel());
-			replyMSG.append("]</td></tr>");
-		}
-		replyMSG.append("</table></body></html>");
-		
-		final NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setHtml(replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			StringUtil.append(sb, "<tr><td>", ((skill.getSkillType() == L2SkillType.NOTDONE) ? ("<font color=\"777777\">" + skill.getName() + "</font>") : skill.getName()), " [", skill.getId(), "-", skill.getLevel(), "]</td></tr>");
+		
+		sb.append("</table></body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -343,10 +290,6 @@
 		}
 		
-		final StringBuilder replyMSG = new StringBuilder(2000);
-		replyMSG.append("<html><body><center><font color=\"LEVEL\">");
-		replyMSG.append(npcData.getName());
-		replyMSG.append(" (");
-		replyMSG.append(npcId);
-		replyMSG.append(")</font></center><br>");
+		final StringBuilder sb = new StringBuilder(500);
+		StringUtil.append(sb, "<html><body><center><font color=\"LEVEL\">", npcData.getName(), " (", npcId, ")</font></center><br>");
 		
 		if (!npcData.getEventQuests().isEmpty())
@@ -360,19 +303,19 @@
 				{
 					type = entry.getKey();
-					replyMSG.append("<br><font color=\"LEVEL\">" + type.name() + "</font><br1>");
+					StringUtil.append(sb, "<br><font color=\"LEVEL\">", type.name(), "</font><br1>");
 				}
 				
 				for (Quest quest : entry.getValue())
-					replyMSG.append(quest.getName() + "<br1>");
+					StringUtil.append(sb, quest.getName(), "<br1>");
 			}
 		}
 		else
-			replyMSG.append("This NPC isn't affected by scripts.");
-		
-		replyMSG.append("</body></html>");
-		
-		final NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-		adminReply.setHtml(replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+			sb.append("This NPC isn't affected by scripts.");
+		
+		sb.append("</body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSpawn.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSpawn.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/admincommandhandlers/AdminSpawn.java	(revision 345)
@@ -21,4 +21,5 @@
 import java.util.regex.Pattern;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.GmListTable;
 import net.sf.l2j.gameserver.datatables.NpcTable;
@@ -38,5 +39,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
 import net.sf.l2j.gameserver.util.Broadcast;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -94,12 +94,12 @@
 			
 			// Load static Htm.
-			NpcHtmlMessage adminReply = new NpcHtmlMessage(0);
-			adminReply.setFile("data/html/admin/listspawns.htm");
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
+			html.setFile("data/html/admin/listspawns.htm");
 			
 			// Generate data.
-			final StringBuilder replyMSG = new StringBuilder();
-			
-			int index = 0;
-			String name = "", x, y, z;
+			final StringBuilder sb = new StringBuilder();
+			
+			int index = 0, x, y, z;
+			String name = "";
 			
 			for (L2Spawn spawn : SpawnTable.getInstance().getSpawnTable())
@@ -113,15 +113,15 @@
 					if (_npc != null)
 					{
-						x = String.valueOf(_npc.getX());
-						y = String.valueOf(_npc.getY());
-						z = String.valueOf(_npc.getZ());
+						x = _npc.getX();
+						y = _npc.getY();
+						z = _npc.getZ();
 					}
 					else
 					{
-						x = String.valueOf(spawn.getLocx());
-						y = String.valueOf(spawn.getLocy());
-						z = String.valueOf(spawn.getLocz());
+						x = spawn.getLocx();
+						y = spawn.getLocy();
+						z = spawn.getLocz();
 					}
-					StringUtil.append(replyMSG, "<tr><td><a action=\"bypass -h admin_move_to ", x, " ", y, " ", z, "\">", String.valueOf(index), " - (", x, " ", y, " ", z, ")", "</a></td></tr>");
+					StringUtil.append(sb, "<tr><td><a action=\"bypass -h admin_move_to ", x, " ", y, " ", z, "\">", index, " - (", x, " ", y, " ", z, ")", "</a></td></tr>");
 				}
 			}
@@ -129,14 +129,14 @@
 			if (index == 0)
 			{
-				adminReply.replace("%npcid%", "?");
-				adminReply.replace("%list%", "<tr><td>The parameter you entered as npcId is invalid.</td></tr>");
+				html.replace("%npcid%", "?");
+				html.replace("%list%", "<tr><td>The parameter you entered as npcId is invalid.</td></tr>");
 			}
 			else
 			{
-				adminReply.replace("%npcid%", name + " (" + npcId + ")");
-				adminReply.replace("%list%", replyMSG.toString());
-			}
-			
-			activeChar.sendPacket(adminReply);
+				html.replace("%npcid%", name + " (" + npcId + ")");
+				html.replace("%list%", sb.toString());
+			}
+			
+			activeChar.sendPacket(html);
 		}
 		else if (command.equals("admin_show_spawns"))
@@ -300,19 +300,19 @@
 	{
 		final List<NpcTemplate> mobs = NpcTable.getInstance().getAllMonstersOfLevel(level);
-		final int mobsCount = mobs.size();
-		final StringBuilder tb = StringUtil.startAppend(500 + mobsCount * 80, "<html><title>Spawn Monster:</title><body><p> Level : ", Integer.toString(level), "<br>Total Npc's : ", Integer.toString(mobsCount), "<br>");
-		
-		// Loop
+		final StringBuilder sb = new StringBuilder(200 + mobs.size() * 100);
+		
+		StringUtil.append(sb, "<html><title>Spawn Monster:</title><body><p> Level : ", level, "<br>Total Npc's : ", mobs.size(), "<br>");
+		
 		int i = from;
-		for (int j = 0; i < mobsCount && j < 50; i++, j++)
-			StringUtil.append(tb, "<a action=\"bypass -h admin_spawn ", Integer.toString(mobs.get(i).getNpcId()), "\">", mobs.get(i).getName(), "</a><br1>");
-		
-		if (i == mobsCount)
-			tb.append("<br><center><button value=\"Back\" action=\"bypass -h admin_show_spawns\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
+		for (int j = 0; i < mobs.size() && j < 50; i++, j++)
+			StringUtil.append(sb, "<a action=\"bypass -h admin_spawn ", mobs.get(i).getNpcId(), "\">", mobs.get(i).getName(), "</a><br1>");
+		
+		if (i == mobs.size())
+			sb.append("<br><center><button value=\"Back\" action=\"bypass -h admin_show_spawns\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
 		else
-			StringUtil.append(tb, "<br><center><button value=\"Next\" action=\"bypass -h admin_spawn_index ", Integer.toString(level), " ", Integer.toString(i), "\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"><button value=\"Back\" action=\"bypass -h admin_show_spawns\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
-		
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
-		html.setHtml(tb.toString());
+			StringUtil.append(sb, "<br><center><button value=\"Next\" action=\"bypass -h admin_spawn_index ", level, " ", i, "\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"><button value=\"Back\" action=\"bypass -h admin_show_spawns\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
 		activeChar.sendPacket(html);
 	}
@@ -321,19 +321,19 @@
 	{
 		final List<NpcTemplate> mobs = NpcTable.getInstance().getAllNpcStartingWith(starting);
-		final int mobsCount = mobs.size();
-		final StringBuilder tb = StringUtil.startAppend(500 + mobsCount * 80, "<html><title>Spawn Monster:</title><body><p> There are ", Integer.toString(mobsCount), " Npcs whose name starts with ", starting, ":<br>");
-		
-		// Loop
+		final StringBuilder sb = new StringBuilder(200 + mobs.size() * 100);
+		
+		StringUtil.append(sb, "<html><title>Spawn Monster:</title><body><p> There are ", mobs.size(), " Npcs whose name starts with ", starting, ":<br>");
+		
 		int i = from;
-		for (int j = 0; i < mobsCount && j < 50; i++, j++)
-			StringUtil.append(tb, "<a action=\"bypass -h admin_spawn ", Integer.toString(mobs.get(i).getNpcId()), "\">", mobs.get(i).getName(), "</a><br1>");
-		
-		if (i == mobsCount)
-			tb.append("<br><center><button value=\"Back\" action=\"bypass -h admin_show_npcs\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
+		for (int j = 0; i < mobs.size() && j < 50; i++, j++)
+			StringUtil.append(sb, "<a action=\"bypass -h admin_spawn ", mobs.get(i).getNpcId(), "\">", mobs.get(i).getName(), "</a><br1>");
+		
+		if (i == mobs.size())
+			sb.append("<br><center><button value=\"Back\" action=\"bypass -h admin_show_npcs\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
 		else
-			StringUtil.append(tb, "<br><center><button value=\"Next\" action=\"bypass -h admin_npc_index ", starting, " ", Integer.toString(i), "\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"><button value=\"Back\" action=\"bypass -h admin_show_npcs\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
-		
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
-		html.setHtml(tb.toString());
+			StringUtil.append(sb, "<br><center><button value=\"Next\" action=\"bypass -h admin_npc_index ", starting, " ", i, "\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"><button value=\"Back\" action=\"bypass -h admin_show_npcs\" width=40 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
 		activeChar.sendPacket(html);
 	}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/usercommandhandlers/ClanPenalty.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/usercommandhandlers/ClanPenalty.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/usercommandhandlers/ClanPenalty.java	(revision 345)
@@ -15,7 +15,7 @@
 package net.sf.l2j.gameserver.handler.usercommandhandlers;
 
-import java.text.SimpleDateFormat;
 import java.util.Map;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.ClanTable;
 import net.sf.l2j.gameserver.handler.IUserCommandHandler;
@@ -23,5 +23,4 @@
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -41,14 +40,13 @@
 	public boolean useUserCommand(int id, L2PcInstance activeChar)
 	{
-		final SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
-		StringBuilder content = new StringBuilder();
+		final StringBuilder sb = new StringBuilder();
 		
 		// Join a clan penalty.
 		if (activeChar.getClanJoinExpiryTime() > System.currentTimeMillis())
-			StringUtil.append(content, "<tr><td width=170>Unable to join a clan.</td><td width=100 align=center>", format.format(activeChar.getClanJoinExpiryTime()), "</td></tr>");
+			StringUtil.append(sb, "<tr><td width=170>Unable to join a clan.</td><td width=100 align=center>", StringUtil.REVERSED_DATE.format(activeChar.getClanJoinExpiryTime()), "</td></tr>");
 		
 		// Create a clan penalty.
 		if (activeChar.getClanCreateExpiryTime() > System.currentTimeMillis())
-			StringUtil.append(content, "<tr><td width=170>Unable to create a clan.</td><td width=100 align=center>", format.format(activeChar.getClanCreateExpiryTime()), "</td></tr>");
+			StringUtil.append(sb, "<tr><td width=170>Unable to create a clan.</td><td width=100 align=center>", StringUtil.REVERSED_DATE.format(activeChar.getClanCreateExpiryTime()), "</td></tr>");
 		
 		final L2Clan clan = activeChar.getClan();
@@ -57,5 +55,5 @@
 			// Invitation in a clan penalty.
 			if (clan.getCharPenaltyExpiryTime() > System.currentTimeMillis())
-				StringUtil.append(content, "<tr><td width=170>Unable to invite a clan member.</td><td width=100 align=center>", format.format(clan.getCharPenaltyExpiryTime()), "</td></tr>");
+				StringUtil.append(sb, "<tr><td width=170>Unable to invite a clan member.</td><td width=100 align=center>", StringUtil.REVERSED_DATE.format(clan.getCharPenaltyExpiryTime()), "</td></tr>");
 			
 			// War penalty.
@@ -68,5 +66,5 @@
 						final L2Clan enemyClan = ClanTable.getInstance().getClan(entry.getKey());
 						if (enemyClan != null)
-							StringUtil.append(content, "<tr><td width=170>Unable to attack ", enemyClan.getName(), " clan.</td><td width=100 align=center>", format.format(entry.getValue()), "</td></tr>");
+							StringUtil.append(sb, "<tr><td width=170>Unable to attack ", enemyClan.getName(), " clan.</td><td width=100 align=center>", StringUtil.REVERSED_DATE.format(entry.getValue()), "</td></tr>");
 					}
 				}
@@ -74,7 +72,7 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		html.setFile("data/html/clan_penalty.htm");
-		html.replace("%content%", (content.length() == 0) ? NO_PENALTY : content.toString());
+		html.replace("%content%", (sb.length() == 0) ? NO_PENALTY : sb.toString());
 		activeChar.sendPacket(html);
 		return true;
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/usercommandhandlers/SiegeStatus.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/usercommandhandlers/SiegeStatus.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/usercommandhandlers/SiegeStatus.java	(revision 345)
@@ -15,4 +15,5 @@
 package net.sf.l2j.gameserver.handler.usercommandhandlers;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.handler.IUserCommandHandler;
 import net.sf.l2j.gameserver.instancemanager.SiegeManager;
@@ -23,5 +24,4 @@
 import net.sf.l2j.gameserver.network.SystemMessageId;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.util.StringUtil;
 
 public class SiegeStatus implements IUserCommandHandler
@@ -52,6 +52,5 @@
 		final L2Clan clan = activeChar.getClan();
 		
-		// Used to build dynamic content (in that case, online clan members).
-		StringBuilder content = new StringBuilder();
+		final StringBuilder sb = new StringBuilder();
 		
 		for (Siege siege : SiegeManager.getSieges())
@@ -65,11 +64,11 @@
 				final L2SiegeZone zone = siege.getCastle().getZone();
 				for (L2PcInstance member : clan.getOnlineMembers())
-					StringUtil.append(content, "<tr><td width=170>", member.getName(), "</td><td width=100>", (zone.isInsideZone(member.getX(), member.getY(), member.getZ())) ? IN_PROGRESS : OUTSIDE_ZONE, "</td></tr>");
+					StringUtil.append(sb, "<tr><td width=170>", member.getName(), "</td><td width=100>", (zone.isInsideZone(member.getX(), member.getY(), member.getZ())) ? IN_PROGRESS : OUTSIDE_ZONE, "</td></tr>");
 				
-				NpcHtmlMessage html = new NpcHtmlMessage(0);
+				final NpcHtmlMessage html = new NpcHtmlMessage(0);
 				html.setFile("data/html/siege_status.htm");
 				html.replace("%kills%", clan.getSiegeKills());
 				html.replace("%deaths%", clan.getSiegeDeaths());
-				html.replace("%content%", content.toString());
+				html.replace("%content%", sb.toString());
 				activeChar.sendPacket(html);
 				return true;
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/itemhandlers/Book.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/itemhandlers/Book.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/handler/itemhandlers/Book.java	(revision 345)
@@ -29,8 +29,9 @@
 		if (!(playable instanceof L2PcInstance))
 			return;
-		L2PcInstance activeChar = (L2PcInstance) playable;
+		
+		final L2PcInstance activeChar = (L2PcInstance) playable;
 		final int itemId = item.getItemId();
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		html.setFile("data/html/help/" + itemId + ".htm");
 		html.setItemId(itemId);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/GameServer.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/GameServer.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/GameServer.java	(revision 345)
@@ -29,4 +29,5 @@
 import net.sf.l2j.L2DatabaseFactory;
 import net.sf.l2j.Server;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.commons.mmocore.SelectorConfig;
 import net.sf.l2j.commons.mmocore.SelectorThread;
@@ -121,5 +122,4 @@
 import net.sf.l2j.util.DeadLockDetector;
 import net.sf.l2j.util.IPv4Filter;
-import net.sf.l2j.util.Util;
 
 public class GameServer
@@ -153,14 +153,14 @@
 		new File("./data/crests").mkdirs();
 		
-		Util.printSection("World");
+		StringUtil.printSection("World");
 		L2World.getInstance();
 		MapRegionTable.getInstance();
 		AnnouncementTable.getInstance();
 		
-		Util.printSection("Skills");
+		StringUtil.printSection("Skills");
 		SkillTable.getInstance();
 		SkillTreeTable.getInstance();
 		
-		Util.printSection("Items");
+		StringUtil.printSection("Items");
 		ItemTable.getInstance();
 		SummonItemsData.getInstance();
@@ -175,5 +175,5 @@
 		CursedWeaponsManager.getInstance();
 		
-		Util.printSection("Admins");
+		StringUtil.printSection("Admins");
 		AccessLevels.getInstance();
 		AdminCommandAccessRights.getInstance();
@@ -183,5 +183,5 @@
 		PetitionManager.getInstance();
 		
-		Util.printSection("Characters");
+		StringUtil.printSection("Characters");
 		CharTemplateTable.getInstance();
 		CharNameTable.getInstance();
@@ -194,5 +194,5 @@
 		RaidBossPointsManager.getInstance();
 		
-		Util.printSection("Community server");
+		StringUtil.printSection("Community server");
 		if (Config.ENABLE_COMMUNITY_BOARD) // Forums has to be loaded before clan data
 			ForumsBBSManager.getInstance().initRoot();
@@ -200,5 +200,5 @@
 			_log.config("Community server is disabled.");
 		
-		Util.printSection("Clans");
+		StringUtil.printSection("Clans");
 		CrestCache.getInstance();
 		ClanTable.getInstance();
@@ -206,16 +206,16 @@
 		ClanHallManager.getInstance();
 		
-		Util.printSection("Geodata & Pathfinding");
+		StringUtil.printSection("Geodata & Pathfinding");
 		GeoData.initialize();
 		PathFinding.initialize();
 		
-		Util.printSection("World Bosses");
+		StringUtil.printSection("World Bosses");
 		GrandBossManager.getInstance();
 		
-		Util.printSection("Zones");
+		StringUtil.printSection("Zones");
 		ZoneManager.getInstance();
 		GrandBossManager.getInstance().initZones();
 		
-		Util.printSection("Task Managers");
+		StringUtil.printSection("Task Managers");
 		AttackStanceTaskManager.getInstance();
 		DecayTaskManager.getInstance();
@@ -228,21 +228,21 @@
 		WaterTaskManager.getInstance();
 		
-		Util.printSection("Castles");
+		StringUtil.printSection("Castles");
 		CastleManager.getInstance().load();
 		
-		Util.printSection("Seven Signs");
+		StringUtil.printSection("Seven Signs");
 		SevenSigns.getInstance().spawnSevenSignsNPC();
 		SevenSignsFestival.getInstance();
 		
-		Util.printSection("Sieges");
+		StringUtil.printSection("Sieges");
 		SiegeManager.getInstance();
 		SiegeManager.getSieges();
 		MercTicketManager.getInstance();
 		
-		Util.printSection("Manor Manager");
+		StringUtil.printSection("Manor Manager");
 		CastleManorManager.getInstance();
 		L2Manor.getInstance();
 		
-		Util.printSection("NPCs");
+		StringUtil.printSection("NPCs");
 		BufferTable.getInstance();
 		HerbDropTable.getInstance();
@@ -257,13 +257,13 @@
 		DimensionalRiftManager.getInstance();
 		
-		Util.printSection("Olympiads & Heroes");
+		StringUtil.printSection("Olympiads & Heroes");
 		OlympiadGameManager.getInstance();
 		Olympiad.getInstance();
 		Hero.getInstance();
 		
-		Util.printSection("Four Sepulchers");
+		StringUtil.printSection("Four Sepulchers");
 		FourSepulchersManager.getInstance().init();
 		
-		Util.printSection("Quests & Scripts");
+		StringUtil.printSection("Quests & Scripts");
 		QuestManager.getInstance();
 		BoatManager.getInstance();
@@ -285,8 +285,8 @@
 			_log.config("QuestManager: Skipping scripts.");
 		
-		Util.printSection("Monster Derby Track");
+		StringUtil.printSection("Monster Derby Track");
 		MonsterRace.getInstance();
 		
-		Util.printSection("Handlers");
+		StringUtil.printSection("Handlers");
 		_log.config("AutoSpawnHandler: Loaded " + AutoSpawnManager.getInstance().size() + " handlers.");
 		_log.config("AdminCommandHandler: Loaded " + AdminCommandHandler.getInstance().size() + " handlers.");
@@ -302,5 +302,5 @@
 			FishingChampionshipManager.getInstance();
 		
-		Util.printSection("System");
+		StringUtil.printSection("System");
 		TaskManager.getInstance();
 		Runtime.getRuntime().addShutdownHook(Shutdown.getInstance());
@@ -329,5 +329,5 @@
 		_log.info("Maximum allowed players: " + Config.MAXIMUM_ONLINE_USERS);
 		
-		Util.printSection("Login");
+		StringUtil.printSection("Login");
 		_loginThread = LoginServerThread.getInstance();
 		_loginThread.start();
@@ -383,5 +383,5 @@
 		is.close();
 		
-		Util.printSection("aCis");
+		StringUtil.printSection("aCis");
 		
 		// Initialize config
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/serverpackets/ShowBoard.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/serverpackets/ShowBoard.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/serverpackets/ShowBoard.java	(revision 345)
@@ -17,5 +17,5 @@
 import java.util.List;
 
-import net.sf.l2j.util.StringUtil;
+import net.sf.l2j.commons.lang.StringUtil;
 
 public class ShowBoard extends L2GameServerPacket
@@ -33,14 +33,14 @@
 	private final static String ADDFAV = "bypass bbs_add_fav";
 	
-	private final StringBuilder _htmlCode;
+	private final StringBuilder _htmlCode = new StringBuilder();
 	
 	public ShowBoard(String htmlCode, String id)
 	{
-		_htmlCode = StringUtil.startAppend(500, id, "\u0008", htmlCode);
+		StringUtil.append(_htmlCode, id, "\u0008", htmlCode);
 	}
 	
 	public ShowBoard(List<String> arg)
 	{
-		_htmlCode = StringUtil.startAppend(500, "1002\u0008");
+		_htmlCode.append("1002\u0008");
 		for (String str : arg)
 			StringUtil.append(_htmlCode, str, " \u0008");
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestLinkHtml.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestLinkHtml.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestLinkHtml.java	(revision 345)
@@ -42,8 +42,7 @@
 			return;
 		
-		NpcHtmlMessage msg = new NpcHtmlMessage(0);
-		msg.setFile(_link);
-		
-		sendPacket(msg);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile(_link);
+		sendPacket(html);
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestSellItem.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestSellItem.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestSellItem.java	(revision 345)
@@ -120,8 +120,8 @@
 		if (!htmlFolder.isEmpty())
 		{
-			String content = HtmCache.getInstance().getHtm("data/html/" + htmlFolder + "/" + merchant.getNpcId() + "-sold.htm");
+			final String content = HtmCache.getInstance().getHtm("data/html/" + htmlFolder + "/" + merchant.getNpcId() + "-sold.htm");
 			if (content != null)
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(merchant.getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(merchant.getObjectId());
 				html.setHtml(content);
 				html.replace("%objectId%", merchant.getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestBypassToServer.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestBypassToServer.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestBypassToServer.java	(revision 345)
@@ -197,5 +197,5 @@
 		final String[] cmd = st.nextToken().split("#");
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		html.setFile("data/html/help/" + cmd[0]);
 		if (cmd.length > 1)
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestChangePetName.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestChangePetName.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestChangePetName.java	(revision 345)
@@ -15,9 +15,9 @@
 package net.sf.l2j.gameserver.network.clientpackets;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.PetDataTable;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.actor.instance.L2PetInstance;
 import net.sf.l2j.gameserver.network.SystemMessageId;
-import net.sf.l2j.gameserver.util.Util;
 
 public final class RequestChangePetName extends L2GameClientPacket
@@ -61,5 +61,5 @@
 		}
 		
-		if (!Util.isValidName(_name, "^[A-Za-z]{2,8}$"))
+		if (!StringUtil.isValidName(_name, "^[A-Za-z]{2,8}$"))
 		{
 			activeChar.sendPacket(SystemMessageId.NAMING_PETNAME_CONTAINS_INVALID_CHARS);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestOlympiadMatchList.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestOlympiadMatchList.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestOlympiadMatchList.java	(revision 345)
@@ -15,4 +15,5 @@
 package net.sf.l2j.gameserver.network.clientpackets;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.model.olympiad.Olympiad;
@@ -20,10 +21,5 @@
 import net.sf.l2j.gameserver.model.olympiad.OlympiadGameTask;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.util.StringUtil;
 
-/**
- * format ch c: (id) 0xD0 h: (subid) 0x13
- * @author -Wooden-
- */
 public final class RequestOlympiadMatchList extends L2GameClientPacket
 {
@@ -40,35 +36,32 @@
 			return;
 		
-		NpcHtmlMessage message = new NpcHtmlMessage(0);
-		StringBuilder list = new StringBuilder(1500);
-		OlympiadGameTask task;
+		int i = 0;
 		
-		message.setFile(Olympiad.OLYMPIAD_HTML_PATH + "olympiad_arena_observe_list.htm");
-		for (int i = 0; i <= 21; i++)
+		final StringBuilder sb = new StringBuilder(1500);
+		for (OlympiadGameTask task : OlympiadGameManager.getInstance().getOlympiadTasks())
 		{
-			task = OlympiadGameManager.getInstance().getOlympiadTask(i);
-			if (task != null)
+			StringUtil.append(sb, "<tr><td fixwidth=10><a action=\"bypass arenachange ", i, "\">", ++i, "</a></td><td fixwidth=80>");
+			
+			if (task.isGameStarted())
 			{
-				StringUtil.append(list, "<tr><td fixwidth=10><a action=\"bypass arenachange ", String.valueOf(i), "\">", String.valueOf(i + 1), "</a></td><td fixwidth=80>");
+				if (task.isInTimerTime())
+					StringUtil.append(sb, "&$907;"); // Counting In Progress
+				else if (task.isBattleStarted())
+					StringUtil.append(sb, "&$829;"); // In Progress
+				else
+					StringUtil.append(sb, "&$908;"); // Terminate
+					
+				StringUtil.append(sb, "</td><td>", task.getGame().getPlayerNames()[0], "&nbsp; / &nbsp;", task.getGame().getPlayerNames()[1]);
+			}
+			else
+				StringUtil.append(sb, "&$906;", "</td><td>&nbsp;"); // Initial State
 				
-				if (task.isGameStarted())
-				{
-					if (task.isInTimerTime())
-						StringUtil.append(list, "&$907;"); // Counting In Progress
-					else if (task.isBattleStarted())
-						StringUtil.append(list, "&$829;"); // In Progress
-					else
-						StringUtil.append(list, "&$908;"); // Terminate
-						
-					StringUtil.append(list, "</td><td>", task.getGame().getPlayerNames()[0], "&nbsp; / &nbsp;", task.getGame().getPlayerNames()[1]);
-				}
-				else
-					StringUtil.append(list, "&$906;", "</td><td>&nbsp;"); // Initial State
-					
-				StringUtil.append(list, "</td><td><font color=\"aaccff\"></font></td></tr>");
-			}
+			StringUtil.append(sb, "</td><td><font color=\"aaccff\"></font></td></tr>");
 		}
-		message.replace("%list%", list.toString());
-		activeChar.sendPacket(message);
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile(Olympiad.OLYMPIAD_HTML_PATH + "olympiad_arena_observe_list.htm");
+		html.replace("%list%", sb.toString());
+		activeChar.sendPacket(html);
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/CharacterCreate.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/CharacterCreate.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/CharacterCreate.java	(revision 345)
@@ -16,4 +16,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.CharNameTable;
 import net.sf.l2j.gameserver.datatables.CharTemplateTable;
@@ -80,5 +81,5 @@
 		}
 		
-		if (!Util.isValidPlayerName(_name))
+		if (!StringUtil.isValidPlayerName(_name))
 		{
 			sendPacket(new CharCreateFail(CharCreateFail.REASON_INCORRECT_NAME));
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/EnterWorld.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/EnterWorld.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/EnterWorld.java	(revision 345)
@@ -207,13 +207,13 @@
 		if (Config.ENABLE_COMMUNITY_BOARD && clan != null && clan.isNoticeEnabled())
 		{
-			NpcHtmlMessage notice = new NpcHtmlMessage(0);
-			notice.setFile("data/html/clan_notice.htm");
-			notice.replace("%clan_name%", clan.getName());
-			notice.replace("%notice_text%", clan.getNotice().replaceAll("\r\n", "<br>").replaceAll("action", "").replaceAll("bypass", ""));
-			sendPacket(notice);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
+			html.setFile("data/html/clan_notice.htm");
+			html.replace("%clan_name%", clan.getName());
+			html.replace("%notice_text%", clan.getNotice().replaceAll("\r\n", "<br>").replaceAll("action", "").replaceAll("bypass", ""));
+			sendPacket(html);
 		}
 		else if (Config.SERVER_NEWS)
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(0);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
 			html.setFile("data/html/servnews.htm");
 			sendPacket(html);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestRecipeShopMakeItem.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestRecipeShopMakeItem.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/network/clientpackets/RequestRecipeShopMakeItem.java	(revision 345)
@@ -20,6 +20,6 @@
 import net.sf.l2j.gameserver.network.SystemMessageId;
 import net.sf.l2j.gameserver.util.FloodProtectors;
+import net.sf.l2j.gameserver.util.FloodProtectors.Action;
 import net.sf.l2j.gameserver.util.Util;
-import net.sf.l2j.gameserver.util.FloodProtectors.Action;
 
 public final class RequestRecipeShopMakeItem extends L2GameClientPacket
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/Shutdown.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/Shutdown.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/Shutdown.java	(revision 345)
@@ -21,4 +21,5 @@
 import net.sf.l2j.Config;
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.BufferTable;
 import net.sf.l2j.gameserver.instancemanager.CastleManorManager;
@@ -41,5 +42,4 @@
 import net.sf.l2j.gameserver.taskmanager.MovementTaskManager;
 import net.sf.l2j.gameserver.util.Broadcast;
-import net.sf.l2j.util.Util;
 
 /**
@@ -118,5 +118,5 @@
 		if (this == SingletonHolder._instance)
 		{
-			Util.printSection("Under " + MODE_TEXT[_shutdownMode] + " process");
+			StringUtil.printSection("Under " + MODE_TEXT[_shutdownMode] + " process");
 			
 			// disconnect players
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/MovieMakerManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/MovieMakerManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/MovieMakerManager.java	(revision 345)
@@ -4,4 +4,5 @@
 import java.util.Map;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.ThreadPoolManager;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
@@ -37,11 +38,11 @@
 	public void mainHtm(L2PcInstance player)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		
 		if (!_sequence.isEmpty())
 		{
-			StringBuilder sb = new StringBuilder();
+			final StringBuilder sb = new StringBuilder();
 			for (Sequence s : _sequence.values())
-				sb.append("<tr><td>" + s._sequenceId + ": (" + s._dist + ", " + s._yaw + ", " + s._pitch + ", " + s._time + ", " + s._duration + ", " + s._turn + ", " + s._rise + ", " + s._widescreen + ")</td></tr>");
+				StringUtil.append(sb, "<tr><td>", s._sequenceId, ": (", s._dist, ", ", s._yaw, ", ", s._pitch, ", ", s._time, ", ", s._duration, ", ", s._turn, ", ", s._rise, ", ", s._widescreen, ")</td></tr>");
 			
 			html.setFile("data/html/admin/movie/main_notempty.htm");
@@ -114,5 +115,5 @@
 	public void addSequence(L2PcInstance player)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		html.setFile("data/html/admin/movie/add_sequence.htm");
 		player.sendPacket(html);
@@ -125,5 +126,5 @@
 			final Sequence s = _sequence.get(id);
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(0);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
 			html.setFile("data/html/admin/movie/edit_sequence.htm");
 			html.replace("%sId%", s._sequenceId);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/FourSepulchersManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/FourSepulchersManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/FourSepulchersManager.java	(revision 345)
@@ -1796,5 +1796,5 @@
 	public void showHtmlFile(L2PcInstance player, String file, L2Npc npc, L2PcInstance member)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 		html.setFile("data/html/sepulchers/" + file);
 		if (member != null)
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/RaidBossSpawnManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/RaidBossSpawnManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/RaidBossSpawnManager.java	(revision 345)
@@ -27,4 +27,5 @@
 
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.ThreadPoolManager;
 import net.sf.l2j.gameserver.datatables.NpcTable;
@@ -34,5 +35,4 @@
 import net.sf.l2j.gameserver.model.actor.template.NpcTemplate;
 import net.sf.l2j.gameserver.templates.StatsSet;
-import net.sf.l2j.gameserver.util.Util;
 import net.sf.l2j.util.Rnd;
 
@@ -170,7 +170,5 @@
 			if (!_schedules.containsKey(boss.getNpcId()))
 			{
-				final Calendar time = Calendar.getInstance();
-				time.setTimeInMillis(respawnTime);
-				_log.info("RaidBoss: " + boss.getName() + " - " + Util.formatDate(time.getTime(), "d MMM yyyy HH:mm") + " (" + respawnDelay + "h).");
+				_log.info("RaidBoss: " + boss.getName() + " - " + StringUtil.DATE_MM.format(respawnTime) + " (" + respawnDelay + "h).");
 				
 				_schedules.put(boss.getNpcId(), ThreadPoolManager.getInstance().scheduleGeneral(new spawnSchedule(boss.getNpcId()), respawnDelay * 3600000));
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/SevenSignsFestival.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/SevenSignsFestival.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/SevenSignsFestival.java	(revision 345)
@@ -29,4 +29,5 @@
 import net.sf.l2j.Config;
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.ThreadPoolManager;
 import net.sf.l2j.gameserver.ai.CtrlIntention;
@@ -55,5 +56,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
 import net.sf.l2j.gameserver.templates.StatsSet;
-import net.sf.l2j.gameserver.util.Util;
 import net.sf.l2j.util.Rnd;
 
@@ -3361,20 +3361,12 @@
 			statement.close();
 			
-			StringBuilder query = new StringBuilder();
-			query.append("SELECT festival_cycle, ");
+			final StringBuilder sb = new StringBuilder("SELECT festival_cycle, ");
 			
 			for (int i = 0; i < FESTIVAL_COUNT - 1; i++)
-			{
-				query.append("accumulated_bonus");
-				query.append(String.valueOf(i));
-				query.append(", ");
-			}
-			
-			query.append("accumulated_bonus");
-			query.append(String.valueOf(FESTIVAL_COUNT - 1));
-			query.append(" ");
-			query.append("FROM seven_signs_status WHERE id=0");
-			
-			statement = con.prepareStatement(query.toString());
+				StringUtil.append(sb, "accumulated_bonus", i, ", ");
+			
+			StringUtil.append(sb, "accumulated_bonus", FESTIVAL_COUNT - 1, " ", "FROM seven_signs_status WHERE id=0");
+			
+			statement = con.prepareStatement(sb.toString());
 			rset = statement.executeQuery();
 			
@@ -3389,7 +3381,4 @@
 			rset.close();
 			statement.close();
-			
-			if (Config.DEBUG)
-				_log.info("SevenSignsFestival: Loaded data from database.");
 		}
 		catch (SQLException e)
@@ -3910,6 +3899,4 @@
 	public boolean setFinalScore(L2PcInstance player, int oracle, int festivalId, int offeringScore)
 	{
-		List<String> partyMembers;
-		
 		int currDawnHighScore = getHighestScore(SevenSigns.CABAL_DAWN, festivalId);
 		int currDuskHighScore = getHighestScore(SevenSigns.CABAL_DUSK, festivalId);
@@ -3943,9 +3930,6 @@
 				return false;
 			
-			List<Integer> prevParticipants = getPreviousParticipants(oracle, festivalId);
-			partyMembers = new ArrayList<>(prevParticipants.size());
-			
-			// Record a string list of the party members involved.
-			for (Integer partyMember : prevParticipants)
+			final List<String> partyMembers = new ArrayList<>();
+			for (int partyMember : getPreviousParticipants(oracle, festivalId))
 				partyMembers.add(CharNameTable.getInstance().getNameById(partyMember));
 			
@@ -3953,5 +3937,5 @@
 			currFestData.set("date", String.valueOf(System.currentTimeMillis()));
 			currFestData.set("score", offeringScore);
-			currFestData.set("members", Util.implodeString(partyMembers, ","));
+			currFestData.set("members", String.join(",", partyMembers));
 			
 			if (Config.DEBUG)
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/DimensionalRiftManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/DimensionalRiftManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/DimensionalRiftManager.java	(revision 345)
@@ -228,5 +228,5 @@
 		if (party.getMemberCount() < Config.RIFT_MIN_PARTY_SIZE)
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 			html.setFile("data/html/seven_signs/rift/SmallParty.htm");
 			html.replace("%npc_name%", npc.getName());
@@ -239,5 +239,5 @@
 		if (!isAllowedEnter(type))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 			html.setFile("data/html/seven_signs/rift/Full.htm");
 			html.replace("%npc_name%", npc.getName());
@@ -265,5 +265,5 @@
 			if (i == null || i.getCount() < getNeededItems(type))
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 				html.setFile("data/html/seven_signs/rift/NoFragments.htm");
 				html.replace("%npc_name%", npc.getName());
@@ -279,5 +279,5 @@
 			if (!p.destroyItem("RiftEntrance", i, count, null, true))
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 				html.setFile("data/html/seven_signs/rift/NoFragments.htm");
 				html.replace("%npc_name%", npc.getName());
@@ -462,5 +462,5 @@
 	public void showHtmlFile(L2PcInstance player, String file, L2Npc npc)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 		html.setFile(file);
 		html.replace("%npc_name%", npc.getName());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/DuelManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/DuelManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/DuelManager.java	(revision 345)
@@ -53,7 +53,7 @@
 	}
 	
-	public void removeDuel(Duel duel)
+	public void removeDuel(int duelId)
 	{
-		_duels.remove(duel);
+		_duels.remove(duelId);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/FishingChampionshipManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/FishingChampionshipManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/FishingChampionshipManager.java	(revision 345)
@@ -280,5 +280,5 @@
 						pl.addItem("fishing_reward", Config.ALT_FISH_CHAMPIONSHIP_REWARD_ITEM, rewardCnt, null, true);
 						
-						NpcHtmlMessage html = new NpcHtmlMessage(0);
+						final NpcHtmlMessage html = new NpcHtmlMessage(0);
 						html.setFile("data/html/fisherman/championship/fish_event_reward001.htm");
 						pl.sendPacket(html);
@@ -291,5 +291,5 @@
 	public void showMidResult(L2PcInstance pl)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(0);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		
 		if (_needRefresh)
@@ -324,5 +324,5 @@
 	public void showChampScreen(L2PcInstance pl, int objectId)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(objectId);
+		final NpcHtmlMessage html = new NpcHtmlMessage(objectId);
 		html.setFile("data/html/fisherman/championship/fish_event001.htm");
 		
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/PetitionManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/PetitionManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/instancemanager/PetitionManager.java	(revision 345)
@@ -15,7 +15,5 @@
 package net.sf.l2j.gameserver.instancemanager;
 
-import java.text.SimpleDateFormat;
 import java.util.ArrayList;
-import java.util.Date;
 import java.util.HashMap;
 import java.util.List;
@@ -24,4 +22,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.GmListTable;
 import net.sf.l2j.gameserver.idfactory.IdFactory;
@@ -463,11 +462,10 @@
 	public void sendPendingPetitionList(L2PcInstance activeChar)
 	{
-		StringBuilder htmlContent = new StringBuilder("<html><body>" + "<center><font color=\"LEVEL\">Current Petitions</font><br><table width=\"300\">");
-		SimpleDateFormat dateFormat = new SimpleDateFormat("dd MMM HH:mm z");
+		final StringBuilder sb = new StringBuilder("<html><body><center><font color=\"LEVEL\">Current Petitions</font><br><table width=\"300\">");
 		
 		if (getPendingPetitionCount() == 0)
-			htmlContent.append("<tr><td colspan=\"4\">There are no currently pending petitions.</td></tr>");
+			sb.append("<tr><td colspan=\"4\">There are no currently pending petitions.</td></tr>");
 		else
-			htmlContent.append("<tr><td></td><td><font color=\"999999\">Petitioner</font></td>" + "<td><font color=\"999999\">Petition Type</font></td><td><font color=\"999999\">Submitted</font></td></tr>");
+			sb.append("<tr><td></td><td><font color=\"999999\">Petitioner</font></td><td><font color=\"999999\">Petition Type</font></td><td><font color=\"999999\">Submitted</font></td></tr>");
 		
 		for (Petition currPetition : getPendingPetitions().values())
@@ -476,19 +474,19 @@
 				continue;
 			
-			htmlContent.append("<tr><td>");
+			sb.append("<tr><td>");
 			
 			if (currPetition.getState() != PetitionState.In_Process)
-				htmlContent.append("<button value=\"View\" action=\"bypass -h admin_view_petition " + currPetition.getId() + "\" " + "width=\"40\" height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\">");
+				StringUtil.append(sb, "<button value=\"View\" action=\"bypass -h admin_view_petition ", currPetition.getId(), "\" width=\"40\" height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\">");
 			else
-				htmlContent.append("<font color=\"999999\">In Process</font>");
-			
-			htmlContent.append("</td><td>" + currPetition.getPetitioner().getName() + "</td><td>" + currPetition.getTypeAsString() + "</td><td>" + dateFormat.format(new Date(currPetition.getSubmitTime())) + "</td></tr>");
-		}
-		
-		htmlContent.append("</table><br><button value=\"Refresh\" action=\"bypass -h admin_view_petitions\" width=\"50\" " + "height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\"><br><button value=\"Back\" action=\"bypass -h admin_admin\" " + "width=\"40\" height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
-		
-		NpcHtmlMessage htmlMsg = new NpcHtmlMessage(0);
-		htmlMsg.setHtml(htmlContent.toString());
-		activeChar.sendPacket(htmlMsg);
+				sb.append("<font color=\"999999\">In Process</font>");
+			
+			StringUtil.append(sb, "</td><td>", currPetition.getPetitioner().getName(), "</td><td>", currPetition.getTypeAsString(), "</td><td>", StringUtil.DATE.format(currPetition.getSubmitTime()), "</td></tr>");
+		}
+		
+		sb.append("</table><br><button value=\"Refresh\" action=\"bypass -h admin_view_petitions\" width=\"50\" " + "height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\"><br><button value=\"Back\" action=\"bypass -h admin_admin\" " + "width=\"40\" height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\"></center></body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -516,20 +514,19 @@
 		
 		Petition currPetition = getPendingPetitions().get(petitionId);
-		StringBuilder htmlContent = new StringBuilder("<html><body>");
-		SimpleDateFormat dateFormat = new SimpleDateFormat("EEE dd MMM HH:mm z");
-		
-		htmlContent.append("<center><br><font color=\"LEVEL\">Petition #" + currPetition.getId() + "</font><br1>");
-		htmlContent.append("<img src=\"L2UI.SquareGray\" width=\"200\" height=\"1\"></center><br>");
-		htmlContent.append("Submit Time: " + dateFormat.format(new Date(currPetition.getSubmitTime())) + "<br1>");
-		htmlContent.append("Petitioner: " + currPetition.getPetitioner().getName() + "<br1>");
-		htmlContent.append("Petition Type: " + currPetition.getTypeAsString() + "<br>" + currPetition.getContent() + "<br>");
-		htmlContent.append("<center><button value=\"Accept\" action=\"bypass -h admin_accept_petition " + currPetition.getId() + "\"" + "width=\"50\" height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\"><br1>");
-		htmlContent.append("<button value=\"Reject\" action=\"bypass -h admin_reject_petition " + currPetition.getId() + "\" " + "width=\"50\" height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\"><br>");
-		htmlContent.append("<button value=\"Back\" action=\"bypass -h admin_view_petitions\" width=\"40\" height=\"15\" back=\"sek.cbui94\" " + "fore=\"sek.cbui92\"></center>");
-		htmlContent.append("</body></html>");
-		
-		NpcHtmlMessage htmlMsg = new NpcHtmlMessage(0);
-		htmlMsg.setHtml(htmlContent.toString());
-		activeChar.sendPacket(htmlMsg);
+		final StringBuilder sb = new StringBuilder("<html><body>");
+		
+		sb.append("<center><br><font color=\"LEVEL\">Petition #" + currPetition.getId() + "</font><br1>");
+		sb.append("<img src=\"L2UI.SquareGray\" width=\"200\" height=\"1\"></center><br>");
+		sb.append("Submit Time: " + StringUtil.DATE_MM.format(currPetition.getSubmitTime()) + "<br1>");
+		sb.append("Petitioner: " + currPetition.getPetitioner().getName() + "<br1>");
+		sb.append("Petition Type: " + currPetition.getTypeAsString() + "<br>" + currPetition.getContent() + "<br>");
+		sb.append("<center><button value=\"Accept\" action=\"bypass -h admin_accept_petition " + currPetition.getId() + "\"" + "width=\"50\" height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\"><br1>");
+		sb.append("<button value=\"Reject\" action=\"bypass -h admin_reject_petition " + currPetition.getId() + "\" " + "width=\"50\" height=\"15\" back=\"sek.cbui94\" fore=\"sek.cbui92\"><br>");
+		sb.append("<button value=\"Back\" action=\"bypass -h admin_view_petitions\" width=\"40\" height=\"15\" back=\"sek.cbui94\" " + "fore=\"sek.cbui92\"></center>");
+		sb.append("</body></html>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/converter/GeoDataConverter.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/converter/GeoDataConverter.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/converter/GeoDataConverter.java	(revision 345)
@@ -31,4 +31,5 @@
 import net.sf.l2j.Server;
 import net.sf.l2j.commons.config.ExProperties;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.geoengine.converter.blocks.Block;
 import net.sf.l2j.gameserver.geoengine.converter.blocks.ComplexBlock;
@@ -39,5 +40,4 @@
 import net.sf.l2j.gameserver.geoengine.geodata.GeoStructure;
 import net.sf.l2j.gameserver.model.L2World;
-import net.sf.l2j.util.Util;
 
 /**
@@ -69,12 +69,12 @@
 		
 		// Initialize config
-		Util.printSection("aCis");
+		StringUtil.printSection("aCis");
 		Config.load();
 		
 		// load geodata and pathfinding
-		Util.printSection("Geodata Converter");
+		StringUtil.printSection("Geodata Converter");
 		loadConvertAndSave();
 		
-		Util.printSection("Completed");
+		StringUtil.printSection("Completed");
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/pathfinding/CellPathFindingStd.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/pathfinding/CellPathFindingStd.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/pathfinding/CellPathFindingStd.java	(revision 345)
@@ -22,4 +22,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.geoengine.GeoData;
 import net.sf.l2j.gameserver.geoengine.PathFinding;
@@ -28,5 +29,4 @@
 import net.sf.l2j.gameserver.geoengine.pathfinding.nodes.NodeBufferStd;
 import net.sf.l2j.gameserver.model.Location;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -322,14 +322,14 @@
 		public String toString()
 		{
-			final StringBuilder stat = new StringBuilder(100);
-			
-			StringUtil.append(stat, "Buffer ", String.valueOf(_size), "x", String.valueOf(_size), ": count=", String.valueOf(_count), " uses=", String.valueOf(_playableUses), "/", String.valueOf(_uses));
+			final StringBuilder sb = new StringBuilder(100);
+			
+			StringUtil.append(sb, "Buffer ", _size, "x", _size, ": count=", _count, " uses=", _playableUses, "/", _uses);
 			
 			if (_uses > 0)
-				StringUtil.append(stat, " total/avg(ms)=", String.valueOf(_elapsed), "/", String.format("%1.2f", (double) _elapsed / _uses));
-			
-			StringUtil.append(stat, " ovf=", String.valueOf(_playableOverflows), "/", String.valueOf(_overflows));
-			
-			return stat.toString();
+				StringUtil.append(sb, " total/avg(ms)=", _elapsed, "/", String.format("%1.2f", (double) _elapsed / _uses));
+			
+			StringUtil.append(sb, " ovf=", _playableOverflows, "/", _overflows);
+			
+			return sb.toString();
 		}
 	}
@@ -343,10 +343,10 @@
 			list.add(buffer.toString());
 		
-		list.add("Use: playable=" + String.valueOf(_postFilterPlayableUses) + " non-playable=" + String.valueOf(_postFilterUses - _postFilterPlayableUses));
+		list.add("Use: playable=" + _postFilterPlayableUses + " non-playable=" + (_postFilterUses - _postFilterPlayableUses));
 		
 		if (_postFilterUses > 0)
-			list.add("Time (ms): total=" + String.valueOf(_postFilterElapsed) + " avg=" + String.format("%1.2f", (double) _postFilterElapsed / _postFilterUses));
-		
-		list.add("Pathfind: success=" + String.valueOf(_findSuccess) + ", fail=" + String.valueOf(_findFails));
+			list.add("Time (ms): total=" + _postFilterElapsed + " avg=" + String.format("%1.2f", (double) _postFilterElapsed / _postFilterUses));
+		
+		list.add("Pathfind: success=" + _findSuccess + ", fail=" + _findFails);
 		
 		return list;
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/pathfinding/CellPathFindingDiag.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/pathfinding/CellPathFindingDiag.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/geoengine/pathfinding/CellPathFindingDiag.java	(revision 345)
@@ -22,4 +22,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.geoengine.GeoData;
 import net.sf.l2j.gameserver.geoengine.PathFinding;
@@ -28,5 +29,4 @@
 import net.sf.l2j.gameserver.geoengine.pathfinding.nodes.NodeBufferDiag;
 import net.sf.l2j.gameserver.model.Location;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -322,14 +322,14 @@
 		public String toString()
 		{
-			final StringBuilder stat = new StringBuilder(100);
-			
-			StringUtil.append(stat, "Buffer ", String.valueOf(_size), "x", String.valueOf(_size), ": count=", String.valueOf(_count), " uses=", String.valueOf(_playableUses), "/", String.valueOf(_uses));
+			final StringBuilder sb = new StringBuilder(100);
+			
+			StringUtil.append(sb, "Buffer ", _size, "x", _size, ": count=", _count, " uses=", _playableUses, "/", _uses);
 			
 			if (_uses > 0)
-				StringUtil.append(stat, " total/avg(ms)=", String.valueOf(_elapsed), "/", String.format("%1.2f", (double) _elapsed / _uses));
-			
-			StringUtil.append(stat, " ovf=", String.valueOf(_playableOverflows), "/", String.valueOf(_overflows));
-			
-			return stat.toString();
+				StringUtil.append(sb, " total/avg(ms)=", _elapsed, "/", String.format("%1.2f", (double) _elapsed / _uses));
+			
+			StringUtil.append(sb, " ovf=", _playableOverflows, "/", _overflows);
+			
+			return sb.toString();
 		}
 	}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/L2Clan.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/L2Clan.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/L2Clan.java	(revision 345)
@@ -28,4 +28,5 @@
 import net.sf.l2j.Config;
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.cache.CrestCache;
 import net.sf.l2j.gameserver.cache.CrestCache.CrestType;
@@ -55,5 +56,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
 import net.sf.l2j.gameserver.network.serverpackets.UserInfo;
-import net.sf.l2j.gameserver.util.Util;
 
 public class L2Clan
@@ -1867,5 +1867,5 @@
 		}
 		
-		if (!Util.isAlphaNumeric(allyName))
+		if (!StringUtil.isAlphaNumeric(allyName))
 		{
 			player.sendPacket(SystemMessageId.INCORRECT_ALLIANCE_NAME);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/MacroList.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/MacroList.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/MacroList.java	(revision 345)
@@ -27,8 +27,8 @@
 
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.L2Macro.L2MacroCmd;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.network.serverpackets.SendMacroList;
-import net.sf.l2j.util.StringUtil;
 
 public class MacroList
@@ -133,5 +133,5 @@
 			for (L2MacroCmd cmd : macro.commands)
 			{
-				StringUtil.append(sb, String.valueOf(cmd.type), ",", String.valueOf(cmd.d1), ",", String.valueOf(cmd.d2));
+				StringUtil.append(sb, cmd.type, ",", cmd.d1, ",", cmd.d2);
 				if (cmd.cmd != null && cmd.cmd.length() > 0)
 					StringUtil.append(sb, ",", cmd.cmd);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/zone/type/L2EffectZone.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/zone/type/L2EffectZone.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/zone/type/L2EffectZone.java	(revision 345)
@@ -29,5 +29,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.EtcStatusUpdate;
 import net.sf.l2j.util.Rnd;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -77,5 +76,5 @@
 				String[] skillSplit = skill.split("-");
 				if (skillSplit.length != 2)
-					_log.warning(StringUtil.concat(getClass().getSimpleName() + ": invalid config property -> skillsIdLvl \"", skill, "\""));
+					_log.warning(getClass().getSimpleName() + ": invalid config property -> skillsIdLvl \"" + skill + "\"");
 				else
 				{
@@ -87,5 +86,5 @@
 					{
 						if (!skill.isEmpty())
-							_log.warning(StringUtil.concat(getClass().getSimpleName() + ": invalid config property -> skillsIdLvl \"", skillSplit[0], "\"", skillSplit[1]));
+							_log.warning(getClass().getSimpleName() + ": invalid config property -> skillsIdLvl \"" + skillSplit[0] + "\"" + skillSplit[1]);
 					}
 				}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Duel.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Duel.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Duel.java	(revision 345)
@@ -651,5 +651,5 @@
 		// Cleanup.
 		_playerConditions.clear();
-		DuelManager.getInstance().removeDuel(this);
+		DuelManager.getInstance().removeDuel(_duelId);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Siege.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Siege.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Siege.java	(revision 345)
@@ -28,4 +28,5 @@
 import net.sf.l2j.Config;
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.ThreadPoolManager;
 import net.sf.l2j.gameserver.datatables.ClanTable;
@@ -54,5 +55,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.UserInfo;
 import net.sf.l2j.gameserver.util.Broadcast;
-import net.sf.l2j.util.Util;
 
 public class Siege implements Siegable
@@ -1026,5 +1026,5 @@
 			startAutoTask(); // Prepare start siege task.
 			
-		Util.printSection(getCastle().getName());
+		StringUtil.printSection(getCastle().getName());
 		_log.info("SiegeManager: New date: " + getCastle().getSiegeDate().getTime());
 		_log.info("SiegeManager: New registration end date: " + getCastle().getSiegeRegistrationEndDate().getTime());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Hero.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Hero.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/entity/Hero.java	(revision 345)
@@ -23,9 +23,7 @@
 import java.sql.ResultSet;
 import java.sql.SQLException;
-import java.text.SimpleDateFormat;
 import java.util.ArrayList;
 import java.util.Calendar;
 import java.util.Collections;
-import java.util.Date;
 import java.util.HashMap;
 import java.util.List;
@@ -35,4 +33,5 @@
 
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.CharNameTable;
 import net.sf.l2j.gameserver.datatables.CharTemplateTable;
@@ -54,5 +53,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
 import net.sf.l2j.gameserver.templates.StatsSet;
-import net.sf.l2j.util.StringUtil;
 
 public class Hero
@@ -292,6 +290,5 @@
 				int param = rset.getInt("param");
 				
-				String date = (new SimpleDateFormat("yyyy-MM-dd HH")).format(new Date(time));
-				_diaryentry.set("date", date);
+				_diaryentry.set("date", StringUtil.REVERSED_DATE_HH.format(time));
 				
 				if (action == ACTION_RAID_KILLED)
@@ -373,6 +370,5 @@
 						
 						fight.set("time", calcFightTime(time));
-						String date = (new SimpleDateFormat("yyyy-MM-dd HH:mm")).format(new Date(start));
-						fight.set("start", date);
+						fight.set("start", StringUtil.REVERSED_DATE_MM.format(start));
 						
 						fight.set("classed", classed);
@@ -409,6 +405,5 @@
 						
 						fight.set("time", calcFightTime(time));
-						String date = (new SimpleDateFormat("yyyy-MM-dd HH:mm")).format(new Date(start));
-						fight.set("start", date);
+						fight.set("start", StringUtil.REVERSED_DATE_MM.format(start));
 						
 						fight.set("classed", classed);
@@ -481,69 +476,66 @@
 	public void showHeroDiary(L2PcInstance activeChar, int heroclass, int charid, int page)
 	{
+		if (!_herodiary.containsKey(charid))
+			return;
+		
 		final int perpage = 10;
 		
-		if (_herodiary.containsKey(charid))
-		{
-			List<StatsSet> _mainlist = _herodiary.get(charid);
-			NpcHtmlMessage html = new NpcHtmlMessage(0);
-			html.setFile("data/html/olympiad/herodiary.htm");
-			html.replace("%heroname%", CharNameTable.getInstance().getNameById(charid));
-			html.replace("%message%", _heroMessage.get(charid));
-			html.disableValidation();
-			
-			if (!_mainlist.isEmpty())
-			{
-				List<StatsSet> _list = new ArrayList<>();
-				_list.addAll(_mainlist);
-				Collections.reverse(_list);
-				
-				boolean color = true;
-				final StringBuilder fList = new StringBuilder(500);
-				int counter = 0;
-				int breakat = 0;
-				for (int i = ((page - 1) * perpage); i < _list.size(); i++)
-				{
-					breakat = i;
-					StatsSet _diaryentry = _list.get(i);
-					StringUtil.append(fList, "<tr><td>");
-					if (color)
-						StringUtil.append(fList, "<table width=270 bgcolor=\"131210\">");
-					else
-						StringUtil.append(fList, "<table width=270>");
-					StringUtil.append(fList, "<tr><td width=270><font color=\"LEVEL\">" + _diaryentry.getString("date") + ":xx</font></td></tr>");
-					StringUtil.append(fList, "<tr><td width=270>" + _diaryentry.getString("action") + "</td></tr>");
-					StringUtil.append(fList, "<tr><td>&nbsp;</td></tr></table>");
-					StringUtil.append(fList, "</td></tr>");
-					color = !color;
-					
-					counter++;
-					if (counter >= perpage)
-						break;
-				}
-				
-				if (breakat < (_list.size() - 1))
-					html.replace("%buttprev%", "<button value=\"Prev\" action=\"bypass _diary?class=" + heroclass + "&page=" + (page + 1) + "\" width=60 height=25 back=\"L2UI_ct1.button_df\" fore=\"L2UI_ct1.button_df\">");
-				else
-					html.replace("%buttprev%", "");
-				
-				if (page > 1)
-					html.replace("%buttnext%", "<button value=\"Next\" action=\"bypass _diary?class=" + heroclass + "&page=" + (page - 1) + "\" width=60 height=25 back=\"L2UI_ct1.button_df\" fore=\"L2UI_ct1.button_df\">");
-				else
-					html.replace("%buttnext%", "");
-				
-				html.replace("%list%", fList.toString());
-			}
+		List<StatsSet> _mainlist = _herodiary.get(charid);
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/olympiad/herodiary.htm");
+		html.replace("%heroname%", CharNameTable.getInstance().getNameById(charid));
+		html.replace("%message%", _heroMessage.get(charid));
+		html.disableValidation();
+		
+		if (!_mainlist.isEmpty())
+		{
+			List<StatsSet> _list = new ArrayList<>();
+			_list.addAll(_mainlist);
+			Collections.reverse(_list);
+			
+			boolean color = true;
+			int counter = 0;
+			int breakat = 0;
+			
+			final StringBuilder sb = new StringBuilder(500);
+			for (int i = ((page - 1) * perpage); i < _list.size(); i++)
+			{
+				breakat = i;
+				StatsSet _diaryentry = _list.get(i);
+				StringUtil.append(sb, "<tr><td>", ((color) ? "<table width=270 bgcolor=\"131210\">" : "<table width=270>"), "<tr><td width=270><font color=\"LEVEL\">", _diaryentry.getString("date"), ":xx</font></td></tr><tr><td width=270>", _diaryentry.getString("action"), "</td></tr><tr><td>&nbsp;</td></tr></table></td></tr>");
+				color = !color;
+				
+				counter++;
+				if (counter >= perpage)
+					break;
+			}
+			
+			if (breakat < (_list.size() - 1))
+				html.replace("%buttprev%", "<button value=\"Prev\" action=\"bypass _diary?class=" + heroclass + "&page=" + (page + 1) + "\" width=60 height=25 back=\"L2UI_ct1.button_df\" fore=\"L2UI_ct1.button_df\">");
 			else
-			{
-				html.replace("%list%", "");
 				html.replace("%buttprev%", "");
+			
+			if (page > 1)
+				html.replace("%buttnext%", "<button value=\"Next\" action=\"bypass _diary?class=" + heroclass + "&page=" + (page - 1) + "\" width=60 height=25 back=\"L2UI_ct1.button_df\" fore=\"L2UI_ct1.button_df\">");
+			else
 				html.replace("%buttnext%", "");
-			}
-			activeChar.sendPacket(html);
-		}
+			
+			html.replace("%list%", sb.toString());
+		}
+		else
+		{
+			html.replace("%list%", "");
+			html.replace("%buttprev%", "");
+			html.replace("%buttnext%", "");
+		}
+		activeChar.sendPacket(html);
 	}
 	
 	public void showHeroFights(L2PcInstance activeChar, int heroclass, int charid, int page)
 	{
+		if (!_herofights.containsKey(charid))
+			return;
+		
 		final int perpage = 20;
 		int _win = 0;
@@ -551,72 +543,62 @@
 		int _draw = 0;
 		
-		if (_herofights.containsKey(charid))
-		{
-			List<StatsSet> _list = _herofights.get(charid);
-			
-			NpcHtmlMessage FightReply = new NpcHtmlMessage(0);
-			FightReply.setFile("data/html/olympiad/herohistory.htm");
-			FightReply.replace("%heroname%", CharNameTable.getInstance().getNameById(charid));
-			FightReply.disableValidation();
-			
-			if (!_list.isEmpty())
-			{
-				if (_herocounts.containsKey(charid))
-				{
-					StatsSet _herocount = _herocounts.get(charid);
-					_win = _herocount.getInteger("victory");
-					_loss = _herocount.getInteger("loss");
-					_draw = _herocount.getInteger("draw");
-				}
-				
-				boolean color = true;
-				final StringBuilder fList = new StringBuilder(500);
-				int counter = 0;
-				int breakat = 0;
-				for (int i = ((page - 1) * perpage); i < _list.size(); i++)
-				{
-					breakat = i;
-					StatsSet fight = _list.get(i);
-					StringUtil.append(fList, "<tr><td>");
-					if (color)
-						StringUtil.append(fList, "<table width=270 bgcolor=\"131210\">");
-					else
-						StringUtil.append(fList, "<table width=270>");
-					StringUtil.append(fList, "<tr><td width=220><font color=\"LEVEL\">" + fight.getString("start") + "</font>&nbsp;&nbsp;" + fight.getString("result") + "</td><td width=50 align=right>" + (fight.getInteger("classed") > 0 ? "<font color=\"FFFF99\">cls</font>" : "<font color=\"999999\">non-cls<font>") + "</td></tr>");
-					StringUtil.append(fList, "<tr><td width=220>vs " + fight.getString("oponent") + " (" + fight.getString("oponentclass") + ")</td><td width=50 align=right>(" + fight.getString("time") + ")</td></tr>");
-					StringUtil.append(fList, "<tr><td colspan=2>&nbsp;</td></tr></table>");
-					StringUtil.append(fList, "</td></tr>");
-					color = !color;
-					
-					counter++;
-					if (counter >= perpage)
-						break;
-				}
-				
-				if (breakat < (_list.size() - 1))
-					FightReply.replace("%buttprev%", "<button value=\"Prev\" action=\"bypass _match?class=" + heroclass + "&page=" + (page + 1) + "\" width=60 height=25 back=\"L2UI_ct1.button_df\" fore=\"L2UI_ct1.button_df\">");
-				else
-					FightReply.replace("%buttprev%", "");
-				
-				if (page > 1)
-					FightReply.replace("%buttnext%", "<button value=\"Next\" action=\"bypass _match?class=" + heroclass + "&page=" + (page - 1) + "\" width=60 height=25 back=\"L2UI_ct1.button_df\" fore=\"L2UI_ct1.button_df\">");
-				else
-					FightReply.replace("%buttnext%", "");
-				
-				FightReply.replace("%list%", fList.toString());
-			}
+		List<StatsSet> _list = _herofights.get(charid);
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setFile("data/html/olympiad/herohistory.htm");
+		html.replace("%heroname%", CharNameTable.getInstance().getNameById(charid));
+		html.disableValidation();
+		
+		if (!_list.isEmpty())
+		{
+			if (_herocounts.containsKey(charid))
+			{
+				StatsSet _herocount = _herocounts.get(charid);
+				_win = _herocount.getInteger("victory");
+				_loss = _herocount.getInteger("loss");
+				_draw = _herocount.getInteger("draw");
+			}
+			
+			boolean color = true;
+			int counter = 0;
+			int breakat = 0;
+			
+			final StringBuilder sb = new StringBuilder(500);
+			for (int i = ((page - 1) * perpage); i < _list.size(); i++)
+			{
+				breakat = i;
+				StatsSet fight = _list.get(i);
+				StringUtil.append(sb, "<tr><td>", ((color) ? "<table width=270 bgcolor=\"131210\">" : "<table width=270><tr><td width=220><font color=\"LEVEL\">"), fight.getString("start"), "</font>&nbsp;&nbsp;", fight.getString("result"), "</td><td width=50 align=right>", ((fight.getInteger("classed") > 0) ? "<font color=\"FFFF99\">cls</font>" : "<font color=\"999999\">non-cls<font>"), "</td></tr><tr><td width=220>vs ", fight.getString("oponent"), " (", fight.getString("oponentclass"), ")</td><td width=50 align=right>(", fight.getString("time"), ")</td></tr><tr><td colspan=2>&nbsp;</td></tr></table></td></tr>");
+				color = !color;
+				
+				counter++;
+				if (counter >= perpage)
+					break;
+			}
+			
+			if (breakat < (_list.size() - 1))
+				html.replace("%buttprev%", "<button value=\"Prev\" action=\"bypass _match?class=" + heroclass + "&page=" + (page + 1) + "\" width=60 height=25 back=\"L2UI_ct1.button_df\" fore=\"L2UI_ct1.button_df\">");
 			else
-			{
-				FightReply.replace("%list%", "");
-				FightReply.replace("%buttprev%", "");
-				FightReply.replace("%buttnext%", "");
-			}
-			
-			FightReply.replace("%win%", _win);
-			FightReply.replace("%draw%", _draw);
-			FightReply.replace("%loos%", _loss);
-			
-			activeChar.sendPacket(FightReply);
-		}
+				html.replace("%buttprev%", "");
+			
+			if (page > 1)
+				html.replace("%buttnext%", "<button value=\"Next\" action=\"bypass _match?class=" + heroclass + "&page=" + (page - 1) + "\" width=60 height=25 back=\"L2UI_ct1.button_df\" fore=\"L2UI_ct1.button_df\">");
+			else
+				html.replace("%buttnext%", "");
+			
+			html.replace("%list%", sb.toString());
+		}
+		else
+		{
+			html.replace("%list%", "");
+			html.replace("%buttprev%", "");
+			html.replace("%buttnext%", "");
+		}
+		
+		html.replace("%win%", _win);
+		html.replace("%draw%", _draw);
+		html.replace("%loos%", _loss);
+		
+		activeChar.sendPacket(html);
 	}
 	
@@ -818,6 +800,5 @@
 			// Prepare new data
 			StatsSet _diaryentry = new StatsSet();
-			String date = (new SimpleDateFormat("yyyy-MM-dd HH")).format(new Date(System.currentTimeMillis()));
-			_diaryentry.set("date", date);
+			_diaryentry.set("date", StringUtil.REVERSED_DATE_HH.format(System.currentTimeMillis()));
 			_diaryentry.set("action", template.getName() + " was defeated");
 			
@@ -846,6 +827,5 @@
 			// Prepare new data
 			StatsSet _diaryentry = new StatsSet();
-			String date = (new SimpleDateFormat("yyyy-MM-dd HH")).format(new Date(System.currentTimeMillis()));
-			_diaryentry.set("date", date);
+			_diaryentry.set("date", StringUtil.REVERSED_DATE_HH.format(System.currentTimeMillis()));
 			_diaryentry.set("action", castle.getName() + " Castle was successfuly taken");
 			
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/olympiad/OlympiadGameManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/olympiad/OlympiadGameManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/olympiad/OlympiadGameManager.java	(revision 345)
@@ -151,4 +151,9 @@
 	}
 	
+	public OlympiadGameTask[] getOlympiadTasks()
+	{
+		return _tasks;
+	}
+	
 	public final int getNumberOfStadiums()
 	{
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/olympiad/OlympiadManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/olympiad/OlympiadManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/olympiad/OlympiadManager.java	(revision 345)
@@ -301,5 +301,5 @@
 		if (points <= 0)
 		{
-			NpcHtmlMessage message = new NpcHtmlMessage(0);
+			final NpcHtmlMessage message = new NpcHtmlMessage(0);
 			message.setFile("data/html/olympiad/noble_nopoints1.htm");
 			message.replace("%objectId%", player.getTargetId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/L2Summon.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/L2Summon.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/L2Summon.java	(revision 345)
@@ -229,12 +229,10 @@
 		if (player.isGM())
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/admin/petinfo.htm");
-			String name = getName();
-			html.replace("%name%", name == null ? "N/A" : name);
+			html.replace("%name%", getName() == null ? "N/A" : getName());
 			html.replace("%level%", getLevel());
 			html.replace("%exp%", getStat().getExp());
-			String owner = getActingPlayer().getName();
-			html.replace("%owner%", " <a action=\"bypass -h admin_character_info " + owner + "\">" + owner + "</a>");
+			html.replace("%owner%", " <a action=\"bypass -h admin_character_info " + getActingPlayer().getName() + "\">" + getActingPlayer().getName() + "</a>");
 			html.replace("%class%", getClass().getSimpleName());
 			html.replace("%ai%", hasAI() ? getAI().getIntention().name() : "NULL");
@@ -246,6 +244,5 @@
 			if (this instanceof L2PetInstance)
 			{
-				int objId = getActingPlayer().getObjectId();
-				html.replace("%inv%", " <a action=\"bypass admin_show_pet_inv " + objId + "\">view</a>");
+				html.replace("%inv%", " <a action=\"bypass admin_show_pet_inv " + getActingPlayer().getObjectId() + "\">view</a>");
 				html.replace("%food%", ((L2PetInstance) this).getCurrentFed() + "/" + ((L2PetInstance) this).getPetLevelData().getPetMaxFeed());
 				html.replace("%load%", ((L2PetInstance) this).getInventory().getTotalWeight() + "/" + ((L2PetInstance) this).getMaxLoad());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/L2Npc.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/L2Npc.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/L2Npc.java	(revision 345)
@@ -22,4 +22,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.ThreadPoolManager;
 import net.sf.l2j.gameserver.ai.CtrlIntention;
@@ -83,5 +84,4 @@
 import net.sf.l2j.gameserver.util.Broadcast;
 import net.sf.l2j.util.Rnd;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -514,17 +514,5 @@
 	
 	/**
-	 * Manage and Display the GM console to modify the L2Npc (GM only).<BR>
-	 * <BR>
-	 * <B><U> Actions (If the L2PcInstance is a GM only)</U> :</B><BR>
-	 * <BR>
-	 * <li>Set the L2Npc as target of the L2PcInstance player (if necessary)</li> <li>Send MyTargetSelected to the L2PcInstance player (display the select window)</li> <li>If L2Npc is autoAttackable, send StatusUpdate to the L2PcInstance in order to update L2Npc HP bar</li> <li>Send a Server->Client
-	 * NpcHtmlMessage() containing the GM console about this L2Npc</li><BR>
-	 * <BR>
-	 * <FONT COLOR=#FF0000><B> <U>Caution</U> : Each group of Server->Client packet must be terminated by a ActionFailed packet in order to avoid that client wait an other packet</B></FONT><BR>
-	 * <BR>
-	 * <B><U> Example of use </U> :</B><BR>
-	 * <BR>
-	 * <li>Client packet : Action</li><BR>
-	 * <BR>
+	 * Manage the shift && left click action.
 	 */
 	@Override
@@ -534,7 +522,6 @@
 		if (player.isGM())
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/admin/npcinfo.htm");
-			
 			html.replace("%class%", getClass().getSimpleName());
 			html.replace("%id%", getTemplate().getNpcId());
@@ -550,5 +537,4 @@
 			html.replace("%mp%", (int) getCurrentMp());
 			html.replace("%mpmax%", getMaxMp());
-			
 			html.replace("%patk%", getPAtk(null));
 			html.replace("%matk%", getMAtk(null, null));
@@ -569,5 +555,4 @@
 			html.replace("%loc%", getX() + " " + getY() + " " + getZ());
 			html.replace("%dist%", (int) Math.sqrt(player.getDistanceSq(this)));
-			
 			html.replace("%ele_fire%", getDefenseElementValue((byte) 2));
 			html.replace("%ele_water%", getDefenseElementValue((byte) 3));
@@ -604,4 +589,5 @@
 				html.replace("%ai%", "");
 			}
+			
 			html.replace("%ai_type%", getAiType().name());
 			html.replace("%ai_clan%", (getClans() != null) ? "<tr><td width=100><font color=\"LEVEL\">Clan:</font></td><td align=right width=170>" + Arrays.toString(getClans()) + " " + getClanRange() + "</td></tr>" + ((getIgnoredIds() != null) ? "<tr><td width=100><font color=\"LEVEL\">Ignored ids:</font></td><td align=right width=170>" + Arrays.toString(getIgnoredIds()) + "</td></tr>" : "") : "");
@@ -679,5 +665,5 @@
 		if (command.equalsIgnoreCase("TerritoryStatus"))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			if (getCastle().getOwnerId() > 0)
@@ -740,5 +726,5 @@
 				return;
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/" + path);
 			html.replace("%objectId%", getObjectId());
@@ -867,14 +853,8 @@
 	
 	/**
-	 * Open a quest window on client with the text of the L2NpcInstance.<BR>
-	 * <BR>
-	 * <B><U> Actions</U> :</B><BR>
-	 * <BR>
-	 * <li>Get the text of the quest state in the folder data/scripts/quests/questId/stateId.htm</li> <li>Send a Server->Client NpcHtmlMessage containing the text of the L2NpcInstance to the L2PcInstance</li> <li>Send a Server->Client ActionFailed to the L2PcInstance in order to avoid that the
-	 * client wait another packet</li><BR>
-	 * <BR>
-	 * @param player The L2PcInstance that talk with the L2NpcInstance
-	 * @param npc The L2Npc instance.
-	 * @param quest
+	 * Open a quest window on client with the text of the L2Npc. Create the QuestState if not existing.
+	 * @param player : the L2PcInstance that talk with the L2Npc.
+	 * @param npc : the L2Npc instance.
+	 * @param quest : the quest HTMLs to show.
 	 */
 	public static void showQuestWindowSingle(L2PcInstance player, L2Npc npc, Quest quest)
@@ -882,7 +862,7 @@
 		if (quest == null)
 		{
-			NpcHtmlMessage npcReply = new NpcHtmlMessage(npc.getObjectId());
-			npcReply.setHtml(Quest.getNoQuestMsg());
-			player.sendPacket(npcReply);
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+			html.setHtml(Quest.getNoQuestMsg());
+			player.sendPacket(html);
 			
 			player.sendPacket(ActionFailed.STATIC_PACKET);
@@ -901,7 +881,7 @@
 			if (quest.isRealQuest() && player.getAllQuests(false).size() >= 25)
 			{
-				NpcHtmlMessage npcReply = new NpcHtmlMessage(npc.getObjectId());
-				npcReply.setHtml(Quest.getTooMuchQuestsMsg());
-				player.sendPacket(npcReply);
+				final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+				html.setHtml(Quest.getTooMuchQuestsMsg());
+				player.sendPacket(html);
 				
 				player.sendPacket(ActionFailed.STATIC_PACKET);
@@ -926,11 +906,8 @@
 	public static void showQuestWindowChoose(L2PcInstance player, L2Npc npc, List<Quest> quests)
 	{
-		final StringBuilder sb = StringUtil.startAppend(150, "<html><body>");
+		final StringBuilder sb = new StringBuilder("<html><body>");
 		
 		for (Quest q : quests)
 		{
-			if (q == null)
-				continue;
-			
 			StringUtil.append(sb, "<a action=\"bypass -h npc_%objectId%_Quest ", q.getName(), "\">[", q.getDescr());
 			
@@ -946,8 +923,8 @@
 		sb.append("</body></html>");
 		
-		NpcHtmlMessage npcReply = new NpcHtmlMessage(npc.getObjectId());
-		npcReply.setHtml(sb.toString());
-		npcReply.replace("%objectId%", npc.getObjectId());
-		player.sendPacket(npcReply);
+		final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+		html.setHtml(sb.toString());
+		html.replace("%objectId%", npc.getObjectId());
+		player.sendPacket(html);
 		
 		player.sendPacket(ActionFailed.STATIC_PACKET);
@@ -1046,10 +1023,5 @@
 	
 	/**
-	 * Open a Loto window on client with the text of the L2Npc.<BR>
-	 * <BR>
-	 * <B><U> Actions</U> :</B><BR>
-	 * <BR>
-	 * <li>Get the text of the selected HTML file in function of the npcId and of the page number</li> <li>Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance</li> <li>Send a Server->Client ActionFailed to the L2PcInstance in order to avoid that the client wait
-	 * another packet</li><BR>
+	 * Open a Loto window on client with the text of the L2Npc.
 	 * @param player The L2PcInstance that talk with the L2Npc
 	 * @param val The number of the page of the L2Npc to display
@@ -1065,11 +1037,10 @@
 	{
 		int npcId = getTemplate().getNpcId();
-		String filename;
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		
 		if (val == 0) // 0 - first buy lottery ticket window
 		{
-			filename = (getHtmlPath(npcId, 1));
-			html.setFile(filename);
+			html.setFile(getHtmlPath(npcId, 1));
 		}
 		else if (val >= 1 && val <= 21) // 1-20 - buttons, 21 - second buy lottery ticket window
@@ -1088,6 +1059,5 @@
 			}
 			
-			filename = (getHtmlPath(npcId, 5));
-			html.setFile(filename);
+			html.setFile(getHtmlPath(npcId, 5));
 			
 			int count = 0;
@@ -1181,31 +1151,28 @@
 			player.addItem("Loto", item, player, true);
 			
-			filename = (getHtmlPath(npcId, 3));
-			html.setFile(filename);
+			html.setFile(getHtmlPath(npcId, 3));
 		}
 		else if (val == 23) // 23 - current lottery jackpot
 		{
-			filename = (getHtmlPath(npcId, 3));
-			html.setFile(filename);
+			html.setFile(getHtmlPath(npcId, 3));
 		}
 		else if (val == 24) // 24 - Previous winning numbers/Prize claim
 		{
-			filename = (getHtmlPath(npcId, 4));
-			html.setFile(filename);
-			
-			int lotonumber = Lottery.getInstance().getId();
-			String message = "";
+			final int lotoNumber = Lottery.getInstance().getId();
+			
+			final StringBuilder sb = new StringBuilder();
 			for (ItemInstance item : player.getInventory().getItems())
 			{
 				if (item == null)
 					continue;
-				if (item.getItemId() == 4442 && item.getCustomType1() < lotonumber)
+				
+				if (item.getItemId() == 4442 && item.getCustomType1() < lotoNumber)
 				{
-					message = message + "<a action=\"bypass -h npc_%objectId%_Loto " + item.getObjectId() + "\">" + item.getCustomType1() + " Event Number ";
+					StringUtil.append(sb, "<a action=\"bypass -h npc_%objectId%_Loto ", item.getObjectId(), "\">", item.getCustomType1(), " Event Number ");
+					
 					int[] numbers = Lottery.decodeNumbers(item.getEnchantLevel(), item.getCustomType2());
 					for (int i = 0; i < 5; i++)
-					{
-						message += numbers[i] + " ";
-					}
+						StringUtil.append(sb, numbers[i], " ");
+					
 					int[] check = Lottery.checkTicket(item);
 					if (check[0] > 0)
@@ -1214,26 +1181,27 @@
 						{
 							case 1:
-								message += "- 1st Prize";
+								sb.append("- 1st Prize");
 								break;
 							case 2:
-								message += "- 2nd Prize";
+								sb.append("- 2nd Prize");
 								break;
 							case 3:
-								message += "- 3th Prize";
+								sb.append("- 3th Prize");
 								break;
 							case 4:
-								message += "- 4th Prize";
+								sb.append("- 4th Prize");
 								break;
 						}
-						message += " " + check[1] + "a.";
+						StringUtil.append(sb, " ", check[1], "a.");
 					}
-					message += "</a><br>";
+					sb.append("</a><br>");
 				}
 			}
 			
-			if (message.isEmpty())
-				message += "There is no winning lottery ticket...<br>";
-			
-			html.replace("%result%", message);
+			if (sb.length() == 0)
+				sb.append("There is no winning lottery ticket...<br>");
+			
+			html.setFile(getHtmlPath(npcId, 4));
+			html.replace("%result%", sb.toString());
 		}
 		else if (val > 24) // >24 - check lottery ticket by item object id
@@ -1330,8 +1298,8 @@
 		if (player_level > higestLevel || !player.isNewbie())
 		{
-			NpcHtmlMessage npcReply = new NpcHtmlMessage(getObjectId());
-			npcReply.setHtml("<html><body>Newbie Guide:<br>Only a <font color=\"LEVEL\">novice character of level " + higestLevel + " or less</font> can receive my support magic.<br>Your novice character is the first one that you created and raised in this world.</body></html>");
-			npcReply.replace("%objectId%", getObjectId());
-			player.sendPacket(npcReply);
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			html.setHtml("<html><body>Newbie Guide:<br>Only a <font color=\"LEVEL\">novice character of level " + higestLevel + " or less</font> can receive my support magic.<br>Your novice character is the first one that you created and raised in this world.</body></html>");
+			html.replace("%objectId%", getObjectId());
+			player.sendPacket(html);
 			return;
 		}
@@ -1340,8 +1308,8 @@
 		if (player_level < lowestLevel)
 		{
-			NpcHtmlMessage npcReply = new NpcHtmlMessage(getObjectId());
-			npcReply.setHtml("<html><body>Come back here when you have reached level " + lowestLevel + ". I will give you support magic then.</body></html>");
-			npcReply.replace("%objectId%", getObjectId());
-			player.sendPacket(npcReply);
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			html.setHtml("<html><body>Come back here when you have reached level " + lowestLevel + ". I will give you support magic then.</body></html>");
+			html.replace("%objectId%", getObjectId());
+			player.sendPacket(html);
 			return;
 		}
@@ -1373,10 +1341,10 @@
 	private boolean showPkDenyChatWindow(L2PcInstance player, String type)
 	{
-		String html = HtmCache.getInstance().getHtm("data/html/" + type + "/" + getNpcId() + "-pk.htm");
-		if (html != null)
-		{
-			NpcHtmlMessage pkDenyMsg = new NpcHtmlMessage(getObjectId());
-			pkDenyMsg.setHtml(html);
-			player.sendPacket(pkDenyMsg);
+		String content = HtmCache.getInstance().getHtm("data/html/" + type + "/" + getNpcId() + "-pk.htm");
+		if (content != null)
+		{
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			html.setHtml(content);
+			player.sendPacket(html);
 			player.sendPacket(ActionFailed.STATIC_PACKET);
 			return true;
@@ -1387,10 +1355,5 @@
 	
 	/**
-	 * Open a chat window on client with the text of the L2Npc.<BR>
-	 * <BR>
-	 * <B><U> Actions</U> :</B><BR>
-	 * <BR>
-	 * <li>Get the text of the selected HTML file in function of the npcId and of the page number</li> <li>Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance</li> <li>Send a Server->Client ActionFailed to the L2PcInstance in order to avoid that the client wait
-	 * another packet</li><BR>
+	 * Open a chat window on client with the text of the L2Npc.
 	 * @param player The L2PcInstance that talk with the L2Npc
 	 */
@@ -1434,6 +1397,5 @@
 			filename = getHtmlPath(npcId, val);
 		
-		// Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
@@ -1454,6 +1416,5 @@
 	public void showChatWindow(L2PcInstance player, String filename)
 	{
-		// Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2VillageMasterInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2VillageMasterInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2VillageMasterInstance.java	(revision 345)
@@ -19,4 +19,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.CharTemplateTable;
 import net.sf.l2j.gameserver.datatables.ClanTable;
@@ -46,6 +47,4 @@
 import net.sf.l2j.gameserver.util.FloodProtectors;
 import net.sf.l2j.gameserver.util.FloodProtectors.Action;
-import net.sf.l2j.gameserver.util.Util;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -179,5 +178,5 @@
 				OlympiadManager.getInstance().unRegisterNoble(player);
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			int cmdChoice = 0;
@@ -201,4 +200,7 @@
 			}
 			
+			StringBuilder sb;
+			Set<PlayerClass> subsAvailable;
+			
 			switch (cmdChoice)
 			{
@@ -206,4 +208,5 @@
 					html.setFile("data/html/villagemaster/SubClass.htm");
 					break;
+				
 				case 1: // Add Subclass - Initial
 					// Subclasses may not be added while a summon is active.
@@ -228,20 +231,19 @@
 					}
 					
+					subsAvailable = getAvailableSubClasses(player);
+					if (subsAvailable == null || subsAvailable.isEmpty())
+					{
+						player.sendMessage("There are no sub classes available at this time.");
+						return;
+					}
+					
+					sb = new StringBuilder(300);
+					for (PlayerClass subClass : subsAvailable)
+						StringUtil.append(sb, "<a action=\"bypass -h npc_%objectId%_Subclass 4 ", subClass.ordinal(), "\" msg=\"1268;", formatClassForDisplay(subClass), "\">", formatClassForDisplay(subClass), "</a><br>");
+					
 					html.setFile("data/html/villagemaster/SubClass_Add.htm");
-					final StringBuilder content1 = StringUtil.startAppend(200);
-					Set<PlayerClass> subsAvailable = getAvailableSubClasses(player);
-					
-					if (subsAvailable != null && !subsAvailable.isEmpty())
-					{
-						for (PlayerClass subClass : subsAvailable)
-							StringUtil.append(content1, "<a action=\"bypass -h npc_%objectId%_Subclass 4 ", String.valueOf(subClass.ordinal()), "\" msg=\"1268;", formatClassForDisplay(subClass), "\">", formatClassForDisplay(subClass), "</a><br>");
-					}
-					else
-					{
-						player.sendMessage("There are no sub classes available at this time.");
-						return;
-					}
-					html.replace("%list%", content1.toString());
+					html.replace("%list%", sb.toString());
 					break;
+				
 				case 2: // Change Class - Initial
 					// Subclasses may not be changed while a summon is active.
@@ -263,8 +265,8 @@
 					else
 					{
-						final StringBuilder content2 = StringUtil.startAppend(200);
+						sb = new StringBuilder(300);
 						
 						if (checkVillageMaster(player.getBaseClass()))
-							StringUtil.append(content2, "<a action=\"bypass -h npc_%objectId%_Subclass 5 0\">", CharTemplateTable.getInstance().getClassNameById(player.getBaseClass()), "</a><br>");
+							StringUtil.append(sb, "<a action=\"bypass -h npc_%objectId%_Subclass 5 0\">", CharTemplateTable.getInstance().getClassNameById(player.getBaseClass()), "</a><br>");
 						
 						for (Iterator<SubClass> subList = iterSubClasses(player); subList.hasNext();)
@@ -272,11 +274,11 @@
 							SubClass subClass = subList.next();
 							if (checkVillageMaster(subClass.getClassDefinition()))
-								StringUtil.append(content2, "<a action=\"bypass -h npc_%objectId%_Subclass 5 ", String.valueOf(subClass.getClassIndex()), "\">", formatClassForDisplay(subClass.getClassDefinition()), "</a><br>");
+								StringUtil.append(sb, "<a action=\"bypass -h npc_%objectId%_Subclass 5 ", subClass.getClassIndex(), "\">", formatClassForDisplay(subClass.getClassDefinition()), "</a><br>");
 						}
 						
-						if (content2.length() > 0)
+						if (sb.length() > 0)
 						{
 							html.setFile("data/html/villagemaster/SubClass_Change.htm");
-							html.replace("%list%", content2.toString());
+							html.replace("%list%", sb.toString());
 						}
 						else
@@ -284,4 +286,5 @@
 					}
 					break;
+				
 				case 3: // Change/Cancel Subclass - Initial
 					if (player.getSubClasses() == null || player.getSubClasses().isEmpty())
@@ -294,6 +297,5 @@
 					if (player.getTotalSubClasses() > 3)
 					{
-						html.setFile("data/html/villagemaster/SubClass_ModifyCustom.htm");
-						final StringBuilder content3 = StringUtil.startAppend(200);
+						sb = new StringBuilder(300);
 						int classIndex = 1;
 						
@@ -301,7 +303,9 @@
 						{
 							SubClass subClass = subList.next();
-							StringUtil.append(content3, "Sub-class ", String.valueOf(classIndex++), "<br>", "<a action=\"bypass -h npc_%objectId%_Subclass 6 ", String.valueOf(subClass.getClassIndex()), "\">", CharTemplateTable.getInstance().getClassNameById(subClass.getClassId()), "</a><br>");
+							StringUtil.append(sb, "Sub-class ", classIndex++, "<br>", "<a action=\"bypass -h npc_%objectId%_Subclass 6 ", subClass.getClassIndex(), "\">", CharTemplateTable.getInstance().getClassNameById(subClass.getClassId()), "</a><br>");
 						}
-						html.replace("%list%", content3.toString());
+						
+						html.setFile("data/html/villagemaster/SubClass_ModifyCustom.htm");
+						html.replace("%list%", sb.toString());
 					}
 					else
@@ -325,4 +329,5 @@
 					}
 					break;
+				
 				case 4: // Add Subclass - Action (Subclass 4 x[x])
 					if (!FloodProtectors.performAction(player.getClient(), Action.SUBCLASS))
@@ -374,4 +379,5 @@
 						html.setFile("data/html/villagemaster/SubClass_Fail.htm");
 					break;
+				
 				case 5: // Change Class - Action
 					if (!FloodProtectors.performAction(player.getClient(), Action.SUBCLASS))
@@ -406,4 +412,5 @@
 					player.sendPacket(SystemMessageId.SUBCLASS_TRANSFER_COMPLETED); // Transfer completed.
 					return;
+					
 				case 6: // Change/Cancel Subclass - Choice
 					// validity check
@@ -420,7 +427,7 @@
 					}
 					
-					final StringBuilder content6 = StringUtil.startAppend(200);
+					sb = new StringBuilder(300);
 					for (PlayerClass subClass : subsAvailable)
-						StringUtil.append(content6, "<a action=\"bypass -h npc_%objectId%_Subclass 7 ", String.valueOf(paramOne), " ", String.valueOf(subClass.ordinal()), "\" msg=\"1445;", "\">", formatClassForDisplay(subClass), "</a><br>");
+						StringUtil.append(sb, "<a action=\"bypass -h npc_%objectId%_Subclass 7 ", paramOne, " ", subClass.ordinal(), "\" msg=\"1445;", "\">", formatClassForDisplay(subClass), "</a><br>");
 					
 					switch (paramOne)
@@ -429,15 +436,19 @@
 							html.setFile("data/html/villagemaster/SubClass_ModifyChoice1.htm");
 							break;
+						
 						case 2:
 							html.setFile("data/html/villagemaster/SubClass_ModifyChoice2.htm");
 							break;
+						
 						case 3:
 							html.setFile("data/html/villagemaster/SubClass_ModifyChoice3.htm");
 							break;
+						
 						default:
 							html.setFile("data/html/villagemaster/SubClass_ModifyChoice.htm");
 					}
-					html.replace("%list%", content6.toString());
+					html.replace("%list%", sb.toString());
 					break;
+				
 				case 7: // Change Subclass - Action
 					if (!FloodProtectors.performAction(player.getClient(), Action.SUBCLASS))
@@ -770,5 +781,5 @@
 		}
 		
-		if (!Util.isAlphaNumeric(clanName))
+		if (!StringUtil.isAlphaNumeric(clanName))
 		{
 			player.sendPacket(SystemMessageId.CLAN_NAME_INVALID);
@@ -861,5 +872,5 @@
 		}
 		
-		if (!Util.isAlphaNumeric(pledgeName))
+		if (!StringUtil.isAlphaNumeric(pledgeName))
 		{
 			player.sendPacket(SystemMessageId.CLAN_NAME_INVALID);
@@ -952,5 +963,5 @@
 		if (player.getClan() == null || !player.isClanLeader())
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(0);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
 			html.setFile("data/html/villagemaster/NotClanLeader.htm");
 			player.sendPacket(html);
@@ -982,5 +993,5 @@
 			else
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(1);
+				final NpcHtmlMessage html = new NpcHtmlMessage(0);
 				html.setFile("data/html/villagemaster/NoMoreSkills.htm");
 				player.sendPacket(html);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2MerchantInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2MerchantInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2MerchantInstance.java	(revision 345)
@@ -104,5 +104,5 @@
 		else if (actualCommand.equalsIgnoreCase("Multisell_Shadow"))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			if (player.getLevel() < 40)
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClanHallDoormenInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClanHallDoormenInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClanHallDoormenInstance.java	(revision 345)
@@ -40,5 +40,5 @@
 			return;
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		
 		final L2Clan owner = ClanTable.getInstance().getClan(getClanHall().getOwnerId());
@@ -71,5 +71,5 @@
 		getClanHall().openCloseDoors(true);
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile("data/html/clanHallDoormen/doormen-opened.htm");
 		html.replace("%objectId%", getObjectId());
@@ -82,5 +82,5 @@
 		getClanHall().openCloseDoors(false);
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile("data/html/clanHallDoormen/doormen-closed.htm");
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DoormenInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DoormenInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DoormenInstance.java	(revision 345)
@@ -79,5 +79,5 @@
 		player.sendPacket(ActionFailed.STATIC_PACKET);
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		
 		if (!isOwnerClan(player))
@@ -116,5 +116,5 @@
 		player.sendPacket(ActionFailed.STATIC_PACKET);
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile("data/html/doormen/" + getTemplate().getNpcId() + "-busy.htm");
 		player.sendPacket(html);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2WeddingManagerInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2WeddingManagerInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2WeddingManagerInstance.java	(revision 345)
@@ -18,4 +18,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.ai.CtrlIntention;
 import net.sf.l2j.gameserver.datatables.SkillTable.FrequentSkill;
@@ -256,8 +257,8 @@
 	private void sendHtmlMessage(L2PcInstance player, String file)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(file);
 		html.replace("%objectId%", getObjectId());
-		html.replace("%adenasCost%", Config.WEDDING_PRICE);
+		html.replace("%adenasCost%", StringUtil.formatNumber(Config.WEDDING_PRICE));
 		html.replace("%needOrNot%", Config.WEDDING_FORMALWEAR ? "will" : "won't");
 		player.sendPacket(html);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleTeleporterInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleTeleporterInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleTeleporterInstance.java	(revision 345)
@@ -61,5 +61,5 @@
 			}
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/castleteleporter/MassGK-1.htm");
 			html.replace("%delay%", getDelayInSeconds());
@@ -84,5 +84,5 @@
 			filename = "data/html/castleteleporter/MassGK-1.htm";
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2WyvernManagerInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2WyvernManagerInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2WyvernManagerInstance.java	(revision 345)
@@ -122,5 +122,5 @@
 	private void sendHtm(L2PcInstance player, String val)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile("data/html/wyvernmanager/wyvernmanager-" + val + ".htm");
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2FestivalGuideInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2FestivalGuideInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2FestivalGuideInstance.java	(revision 345)
@@ -289,5 +289,5 @@
 					break;
 				case 4: // Current High Scores
-					StringBuilder strBuffer = new StringBuilder("<html><body>Festival Guide:<br>These are the top scores of the week, for the ");
+					final StringBuilder sb = new StringBuilder("<html><body>Festival Guide:<br>These are the top scores of the week, for the ");
 					
 					final StatsSet dawnData = SevenSignsFestival.getInstance().getHighestScoreData(SevenSigns.CABAL_DAWN, _festivalType);
@@ -298,15 +298,15 @@
 					final int duskScore = duskData.getInteger("score");
 					
-					strBuffer.append(SevenSignsFestival.getFestivalName(_festivalType) + " festival.<br>");
+					sb.append(SevenSignsFestival.getFestivalName(_festivalType) + " festival.<br>");
 					
 					if (dawnScore > 0)
-						strBuffer.append("Dawn: " + calculateDate(dawnData.getString("date")) + ". Score " + dawnScore + "<br>" + dawnData.getString("members") + "<br>");
-					else
-						strBuffer.append("Dawn: No record exists. Score 0<br>");
+						sb.append("Dawn: " + calculateDate(dawnData.getString("date")) + ". Score " + dawnScore + "<br>" + dawnData.getString("members") + "<br>");
+					else
+						sb.append("Dawn: No record exists. Score 0<br>");
 					
 					if (duskScore > 0)
-						strBuffer.append("Dusk: " + calculateDate(duskData.getString("date")) + ". Score " + duskScore + "<br>" + duskData.getString("members") + "<br>");
-					else
-						strBuffer.append("Dusk: No record exists. Score 0<br>");
+						sb.append("Dusk: " + calculateDate(duskData.getString("date")) + ". Score " + duskScore + "<br>" + duskData.getString("members") + "<br>");
+					else
+						sb.append("Dusk: No record exists. Score 0<br>");
 					
 					// If no data is returned, assume there is no record, or all scores are 0.
@@ -318,13 +318,13 @@
 							cabalStr = "Children of Dawn";
 						
-						strBuffer.append("Consecutive top scores: " + calculateDate(overallData.getString("date")) + ". Score " + overallData.getInteger("score") + "<br>Affilated side: " + cabalStr + "<br>" + overallData.getString("members") + "<br>");
-					}
-					else
-						strBuffer.append("Consecutive top scores: No record exists. Score 0<br>");
-					
-					strBuffer.append("<a action=\"bypass -h npc_" + getObjectId() + "_Chat 0\">Go back.</a></body></html>");
-					
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
-					html.setHtml(strBuffer.toString());
+						sb.append("Consecutive top scores: " + calculateDate(overallData.getString("date")) + ". Score " + overallData.getInteger("score") + "<br>Affilated side: " + cabalStr + "<br>" + overallData.getString("members") + "<br>");
+					}
+					else
+						sb.append("Consecutive top scores: No record exists. Score 0<br>");
+					
+					sb.append("<a action=\"bypass -h npc_" + getObjectId() + "_Chat 0\">Go back.</a></body></html>");
+					
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					html.setHtml(sb.toString());
 					player.sendPacket(html);
 					break;
@@ -427,6 +427,5 @@
 		}
 		
-		// Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
@@ -440,11 +439,6 @@
 	private void showChatWindow(L2PcInstance player, int val, String suffix, boolean isDescription)
 	{
-		String filename = SevenSigns.SEVEN_SIGNS_HTML_PATH + "festival/";
-		filename += (isDescription) ? "desc_" : "festival_";
-		filename += (suffix != null) ? val + suffix + ".htm" : val + ".htm";
-		
-		// Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
-		html.setFile(filename);
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		html.setFile(SevenSigns.SEVEN_SIGNS_HTML_PATH + "festival/" + ((isDescription) ? "desc_" : "festival_") + ((suffix != null) ? val + suffix : val) + ".htm");
 		html.replace("%objectId%", getObjectId());
 		html.replace("%festivalType%", SevenSignsFestival.getFestivalName(_festivalType));
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2AuctioneerInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2AuctioneerInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2AuctioneerInstance.java	(revision 345)
@@ -21,5 +21,5 @@
 import java.util.StringTokenizer;
 
-import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.MapRegionTable;
 import net.sf.l2j.gameserver.instancemanager.AuctionManager;
@@ -31,5 +31,4 @@
 import net.sf.l2j.gameserver.network.SystemMessageId;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.gameserver.util.Util;
 
 public final class L2AuctioneerInstance extends L2NpcInstance
@@ -55,5 +54,5 @@
 		if (condition == COND_BUSY_BECAUSE_OF_SIEGE)
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/auction/auction-busy.htm");
 			html.replace("%objectId%", getObjectId());
@@ -79,18 +78,12 @@
 					return;
 				
-				if (Config.DEBUG)
-					_log.warning("Auction: bidding show is successful.");
-				
 				try
 				{
 					int auctionId = Integer.parseInt(val);
-					
-					if (Config.DEBUG)
-						_log.warning("Auction: auction has started.");
 					
 					final Auction a = AuctionManager.getInstance().getAuction(auctionId);
 					if (a != null)
 					{
-						NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+						final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 						html.setFile("data/html/auction/AgitAuctionInfo.htm");
 						html.replace("%AGIT_NAME%", a.getItemName());
@@ -100,5 +93,5 @@
 						html.replace("%AGIT_LEASE%", ClanHallManager.getInstance().getClanHallById(a.getItemId()).getLease());
 						html.replace("%AGIT_LOCATION%", ClanHallManager.getInstance().getClanHallById(a.getItemId()).getLocation());
-						html.replace("%AGIT_AUCTION_END%", Util.formatDate(a.getEndDate(), "dd/MM/yyyy HH:mm"));
+						html.replace("%AGIT_AUCTION_END%", StringUtil.DATE_MM.format(a.getEndDate()));
 						html.replace("%AGIT_AUCTION_REMAIN%", ((a.getEndDate() - System.currentTimeMillis()) / 3600000) + " hours " + (((a.getEndDate() - System.currentTimeMillis()) / 60000) % 60) + " minutes");
 						html.replace("%AGIT_AUCTION_MINBID%", a.getStartingBid());
@@ -120,5 +113,5 @@
 			else if (actualCommand.equalsIgnoreCase("location"))
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/auction/location.htm");
 				html.replace("%location%", MapRegionTable.getInstance().getClosestTownName(player.getX(), player.getY()));
@@ -200,5 +193,5 @@
 							minimumBid = AuctionManager.getInstance().getAuction(Integer.parseInt(val)).getStartingBid();
 						
-						NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+						final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 						html.setFile("data/html/auction/AgitBid1.htm");
 						html.replace("%AGIT_LINK_BACK%", "bypass -h npc_" + getObjectId() + "_bidding " + val);
@@ -227,17 +220,11 @@
 						auctionId = Integer.parseInt(val);
 					
-					if (Config.DEBUG)
-						_log.warning("Auction: command bidlist has started.");
-					
-					String biders = "";
-					final Map<Integer, Bidder> bidders = AuctionManager.getInstance().getAuction(auctionId).getBidders();
-					for (Bidder b : bidders.values())
-					{
-						biders += "<tr>" + "<td>" + b.getClanName() + "</td><td>" + b.getName() + "</td><td>" + b.getTimeBid().get(Calendar.YEAR) + "/" + (b.getTimeBid().get(Calendar.MONTH) + 1) + "/" + b.getTimeBid().get(Calendar.DATE) + "</td>" + "</tr>";
-					}
-					
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final StringBuilder sb = new StringBuilder();
+					for (Bidder bidder : AuctionManager.getInstance().getAuction(auctionId).getBidders().values())
+						StringUtil.append(sb, "<tr><td>", bidder.getClanName(), "</td><td>", bidder.getName(), "</td><td>", bidder.getTimeBid().get(Calendar.YEAR), "/", (bidder.getTimeBid().get(Calendar.MONTH) + 1), "/", bidder.getTimeBid().get(Calendar.DATE), "</td></tr>");
+					
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					html.setFile("data/html/auction/AgitBidderList.htm");
-					html.replace("%AGIT_LIST%", biders);
+					html.replace("%AGIT_LIST%", sb.toString());
 					html.replace("%AGIT_LINK_BACK%", "bypass -h npc_" + getObjectId() + "_bidding " + val);
 					html.replace("%x%", val);
@@ -253,5 +240,5 @@
 				{
 					int bid = AuctionManager.getInstance().getAuction(player.getClan().getAuctionBiddedAt()).getBidders().get(player.getClanId()).getBid();
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					html.setFile("data/html/auction/AgitBidCancel.htm");
 					html.replace("%AGIT_BID%", bid);
@@ -273,5 +260,5 @@
 				else if (actualCommand.equalsIgnoreCase("cancelAuction"))
 				{
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					html.setFile("data/html/auction/AgitSaleCancel.htm");
 					html.replace("%AGIT_DEPOSIT%", ClanHallManager.getInstance().getClanHallByOwner(player.getClan()).getLease());
@@ -293,5 +280,5 @@
 				else if (actualCommand.equalsIgnoreCase("sale"))
 				{
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					html.setFile("data/html/auction/AgitSale1.htm");
 					html.replace("%AGIT_DEPOSIT%", ClanHallManager.getInstance().getClanHallByOwner(player.getClan()).getLease());
@@ -309,9 +296,9 @@
 						if (a != null)
 						{
-							NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+							final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 							html.setFile("data/html/auction/AgitBid2.htm");
 							html.replace("%AGIT_AUCTION_BID%", a.getBidders().get(player.getClanId()).getBid());
 							html.replace("%AGIT_AUCTION_MINBID%", a.getStartingBid());
-							html.replace("%AGIT_AUCTION_END%", Util.formatDate(a.getEndDate(), "dd/MM/yyyy HH:mm"));
+							html.replace("%AGIT_AUCTION_END%", StringUtil.DATE_MM.format(a.getEndDate()));
 							html.replace("%AGIT_LINK_BACK%", "bypass -h npc_" + getObjectId() + "_selectedItems");
 							html.replace("npc_%objectId%_bid1", "npc_" + getObjectId() + "_bid1 " + a.getId());
@@ -356,8 +343,8 @@
 								_pendingAuctions.put(a.getId(), a);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/auction/AgitSale3.htm");
 								html.replace("%x%", val);
-								html.replace("%AGIT_AUCTION_END%", Util.formatDate(a.getEndDate(), "dd/MM/yyyy HH:mm"));
+								html.replace("%AGIT_AUCTION_END%", StringUtil.DATE_MM.format(a.getEndDate()));
 								html.replace("%AGIT_AUCTION_MINBID%", a.getStartingBid());
 								html.replace("%AGIT_AUCTION_MIN%", a.getStartingBid());
@@ -399,5 +386,5 @@
 					else if (actualCommand.equalsIgnoreCase("sale2"))
 					{
-						NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+						final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 						html.setFile("data/html/auction/AgitSale2.htm");
 						html.replace("%AGIT_LAST_PRICE%", ClanHallManager.getInstance().getClanHallByOwner(player.getClan()).getLease());
@@ -424,5 +411,5 @@
 			filename = "data/html/auction/auction.htm";
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
@@ -456,5 +443,5 @@
 	private void showAuctionsList(String val, L2PcInstance player)
 	{
-		List<Auction> auctions = AuctionManager.getInstance().getAuctions();
+		final List<Auction> auctions = AuctionManager.getInstance().getAuctions();
 		
 		int limit = 15; // Limit to prevent client crash
@@ -471,22 +458,11 @@
 		}
 		
-		if (Config.DEBUG)
-			_log.warning("Auction: list command has started.");
-		
-		StringBuilder items = new StringBuilder();
-		items.append("<table width=280 border=0><tr>");
+		final StringBuilder sb = new StringBuilder(2000);
+		
+		sb.append("<table width=280 border=0><tr>");
 		for (int j = 1; j <= npage; j++)
-		{
-			items.append("<td><center><a action=\"bypass -h npc_");
-			items.append(getObjectId());
-			items.append("_list ");
-			items.append(j);
-			items.append("\"> Page ");
-			items.append(j);
-			items.append(" </a></center></td>");
-		}
-		
-		items.append("</tr></table>");
-		items.append("<table width=280 border=0>");
+			StringUtil.append(sb, "<td><center><a action=\"bypass -h npc_", getObjectId(), "_list ", j, "\"> Page ", j, " </a></center></td>");
+		
+		sb.append("</tr></table><table width=280 border=0>");
 		
 		for (Auction a : auctions)
@@ -505,30 +481,12 @@
 				i++;
 			
-			items.append("<tr>");
-			items.append("<td><font color=\"aaaaff\">");
-			items.append(ClanHallManager.getInstance().getClanHallById(a.getItemId()).getLocation());
-			items.append("</font></td>");
-			items.append("<td><font color=\"ffffaa\"><a action=\"bypass -h npc_");
-			items.append(getObjectId());
-			items.append("_bidding ");
-			items.append(a.getId());
-			items.append("\">");
-			items.append(a.getItemName());
-			items.append(" [");
-			items.append(a.getBidders().size());
-			items.append("]</a></font></td>");
-			items.append("<td>" + Util.formatDate(a.getEndDate(), "yy/MM/dd"));
-			items.append("</td>");
-			items.append("<td><font color=\"aaffff\">");
-			items.append(a.getStartingBid());
-			items.append("</font></td>");
-			items.append("</tr>");
-		}
-		items.append("</table>");
-		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			StringUtil.append(sb, "<tr><td><font color=\"aaaaff\">", ClanHallManager.getInstance().getClanHallById(a.getItemId()).getLocation(), "</font></td><td><font color=\"ffffaa\"><a action=\"bypass -h npc_", getObjectId(), "_bidding ", a.getId(), "\">", a.getItemName(), " [", a.getBidders().size(), "]</a></font></td><td>", StringUtil.REVERSED_DATE.format(a.getEndDate()), "</td><td><font color=\"aaffff\">", a.getStartingBid(), "</font></td></tr>");
+		}
+		sb.append("</table>");
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile("data/html/auction/AgitAuctionList.htm");
 		html.replace("%AGIT_LINK_BACK%", "bypass -h npc_" + getObjectId() + "_start");
-		html.replace("%itemsField%", items.toString());
+		html.replace("%itemsField%", sb.toString());
 		player.sendPacket(html);
 		return;
@@ -546,5 +504,5 @@
 			if (a != null)
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/auction/AgitBidInfo.htm");
 				html.replace("%AGIT_NAME%", a.getItemName());
@@ -554,5 +512,5 @@
 				html.replace("%AGIT_LEASE%", ClanHallManager.getInstance().getClanHallById(a.getItemId()).getLease());
 				html.replace("%AGIT_LOCATION%", ClanHallManager.getInstance().getClanHallById(a.getItemId()).getLocation());
-				html.replace("%AGIT_AUCTION_END%", Util.formatDate(a.getEndDate(), "dd/MM/yyyy HH:mm"));
+				html.replace("%AGIT_AUCTION_END%", StringUtil.DATE_MM.format(a.getEndDate()));
 				html.replace("%AGIT_AUCTION_REMAIN%", ((a.getEndDate() - System.currentTimeMillis()) / 3600000) + " hours " + (((a.getEndDate() - System.currentTimeMillis()) / 60000) % 60) + " minutes");
 				html.replace("%AGIT_AUCTION_MINBID%", a.getStartingBid());
@@ -573,5 +531,5 @@
 			if (a != null)
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/auction/AgitSaleInfo.htm");
 				html.replace("%AGIT_NAME%", a.getItemName());
@@ -581,5 +539,5 @@
 				html.replace("%AGIT_LEASE%", ClanHallManager.getInstance().getClanHallById(a.getItemId()).getLease());
 				html.replace("%AGIT_LOCATION%", ClanHallManager.getInstance().getClanHallById(a.getItemId()).getLocation());
-				html.replace("%AGIT_AUCTION_END%", Util.formatDate(a.getEndDate(), "dd/MM/yyyy HH:mm"));
+				html.replace("%AGIT_AUCTION_END%", StringUtil.DATE_MM.format(a.getEndDate()));
 				html.replace("%AGIT_AUCTION_REMAIN%", ((a.getEndDate() - System.currentTimeMillis()) / 3600000) + " hours " + (((a.getEndDate() - System.currentTimeMillis()) / 60000) % 60) + " minutes");
 				html.replace("%AGIT_AUCTION_MINBID%", a.getStartingBid());
@@ -602,5 +560,5 @@
 			if (ClanHallManager.getInstance().getClanHallById(itemId) != null)
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/auction/AgitInfo.htm");
 				html.replace("%AGIT_NAME%", ClanHallManager.getInstance().getClanHallById(itemId).getName());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2FishermanInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2FishermanInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2FishermanInstance.java	(revision 345)
@@ -112,5 +112,5 @@
 	private static void sendHtml(L2PcInstance player, L2Npc npc, String htmlName)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 		html.setFile("data/html/fisherman/championship/" + htmlName);
 		player.sendPacket(html);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleBlacksmithInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleBlacksmithInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleBlacksmithInstance.java	(revision 345)
@@ -25,5 +25,5 @@
 		if (CastleManorManager.getInstance().isDisabled())
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/npcdefault.htm");
 			html.replace("%objectId%", getObjectId());
@@ -60,5 +60,5 @@
 		if (CastleManorManager.getInstance().isDisabled())
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/npcdefault.htm");
 			html.replace("%objectId%", getObjectId());
@@ -84,5 +84,5 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2TeleporterInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2TeleporterInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2TeleporterInstance.java	(revision 345)
@@ -110,5 +110,5 @@
 			return;
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		
 		String content = HtmCache.getInstance().getHtm("data/html/teleporter/half/" + getNpcId() + ".htm");
@@ -141,5 +141,5 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
@@ -159,17 +159,20 @@
 				return;
 			}
-			else if (MapRegionTable.townHasCastleInSiege(list.getLocX(), list.getLocY()) && isInsideZone(ZoneId.TOWN))
+			
+			if (MapRegionTable.townHasCastleInSiege(list.getLocX(), list.getLocY()) && isInsideZone(ZoneId.TOWN))
 			{
 				player.sendPacket(SystemMessageId.NO_PORT_THAT_IS_IN_SIGE);
 				return;
 			}
-			else if (!Config.KARMA_PLAYER_CAN_USE_GK && player.getKarma() > 0) // karma
+			
+			if (!Config.KARMA_PLAYER_CAN_USE_GK && player.getKarma() > 0) // karma
 			{
 				player.sendMessage("Go away, you're not welcome here.");
 				return;
 			}
-			else if (list.getIsForNoble() && !player.isNoble())
-			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			
+			if (list.getIsForNoble() && !player.isNoble())
+			{
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/teleporter/nobleteleporter-no.htm");
 				html.replace("%objectId%", getObjectId());
@@ -178,5 +181,6 @@
 				return;
 			}
-			else if (player.isAlikeDead())
+			
+			if (player.isAlikeDead())
 				return;
 			
@@ -191,10 +195,5 @@
 			
 			if (Config.ALT_GAME_FREE_TELEPORT || player.destroyItemByItemId("Teleport " + (list.getIsForNoble() ? " nobless" : ""), 57, price, this, true))
-			{
-				if (Config.DEBUG)
-					_log.fine("Teleporting player " + player.getName() + " to new location: " + list.getLocX() + ":" + list.getLocY() + ":" + list.getLocZ());
-				
 				player.teleToLocation(list.getLocX(), list.getLocY(), list.getLocZ(), 20);
-			}
 		}
 		else
@@ -208,11 +207,10 @@
 		if (CastleManager.getInstance().getCastleIndex(this) < 0) // Teleporter isn't on castle ground
 			return COND_REGULAR; // Regular access
-		else if (getCastle().getSiege().isInProgress()) // Teleporter is on castle ground and siege is in progress
+		
+		if (getCastle().getSiege().isInProgress()) // Teleporter is on castle ground and siege is in progress
 			return COND_BUSY_BECAUSE_OF_SIEGE; // Busy because of siege
-		else if (player.getClan() != null) // Teleporter is on castle ground and player is in a clan
-		{
-			if (getCastle().getOwnerId() == player.getClanId()) // Clan owns castle
-				return COND_OWNER; // Owner
-		}
+		
+		if (player.getClan() != null && getCastle().getOwnerId() == player.getClanId()) // Teleporter is on castle ground and player is in a clan
+			return COND_OWNER;
 		
 		return COND_ALL_FALSE;
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleChamberlainInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleChamberlainInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleChamberlainInstance.java	(revision 345)
@@ -19,4 +19,5 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.ClanTable;
 import net.sf.l2j.gameserver.instancemanager.CastleManager;
@@ -34,5 +35,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.ExShowSeedSetting;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.gameserver.util.Util;
 
 /**
@@ -74,5 +74,5 @@
 			if (cond == COND_BUSY_BECAUSE_OF_SIEGE)
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/chamberlain/busy.htm");
 				player.sendPacket(html);
@@ -133,8 +133,9 @@
 			else
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final L2Clan clan = ClanTable.getInstance().getClan(castle.getOwnerId());
+				
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/chamberlain/report.htm");
 				html.replace("%objectId%", getObjectId());
-				L2Clan clan = ClanTable.getInstance().getClan(castle.getOwnerId());
 				html.replace("%clanname%", clan.getName());
 				html.replace("%clanleadername%", clan.getLeaderName());
@@ -269,9 +270,9 @@
 				}
 			}
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile(filename);
 			html.replace("%objectId%", getObjectId());
-			html.replace("%tax_income%", Util.formatAdena(castle.getTreasury()));
-			html.replace("%withdraw_amount%", Util.formatAdena(amount));
+			html.replace("%tax_income%", StringUtil.formatNumber(castle.getTreasury()));
+			html.replace("%withdraw_amount%", StringUtil.formatNumber(amount));
 			player.sendPacket(html);
 		}
@@ -283,5 +284,5 @@
 			if (val.isEmpty())
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/chamberlain/" + getNpcId() + "-d.htm");
 				html.replace("%objectId%", getObjectId());
@@ -294,5 +295,5 @@
 				castle.openCloseDoor(player, Integer.parseInt(st.nextToken()), open);
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile((open) ? "data/html/chamberlain/doors-open.htm" : "data/html/chamberlain/doors-close.htm");
 			html.replace("%objectId%", getObjectId());
@@ -302,5 +303,5 @@
 		else if (actualCommand.equalsIgnoreCase("tax_set")) // tax rates control
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			if (!validatePrivileges(player, L2Clan.CP_CS_TAXES))
@@ -348,5 +349,5 @@
 			if (filename.length() != 0)
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile(filename);
 				html.replace("%objectId%", getObjectId());
@@ -452,5 +453,5 @@
 		else if (actualCommand.equals("give_crown"))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			if (cond == COND_OWNER)
@@ -485,5 +486,5 @@
 				return;
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			if (val.isEmpty())
 				html.setFile("data/html/chamberlain/" + getNpcId() + "-gu.htm");
@@ -506,5 +507,5 @@
 			final String level = st.nextToken();
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/chamberlain/doors-confirm.htm");
 			html.replace("%objectId%", getObjectId());
@@ -534,5 +535,5 @@
 			final int currentHpRatio = door.getUpgradeHpRatio();
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			if (currentHpRatio >= level)
@@ -557,5 +558,5 @@
 				return;
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			if (val.isEmpty())
 				html.setFile("data/html/chamberlain/" + getNpcId() + "-tu.htm");
@@ -576,5 +577,5 @@
 			final String level = st.nextToken();
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/chamberlain/traps-confirm.htm");
 			html.replace("%objectId%", getObjectId());
@@ -598,5 +599,5 @@
 			final int currentLevel = castle.getTrapUpgradeLevel(trapIndex);
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			if (currentLevel >= level)
@@ -635,5 +636,5 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
@@ -663,5 +664,5 @@
 		if ((player.getClanPrivileges() & privilege) != privilege)
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/chamberlain/noprivs.htm");
 			player.sendPacket(html);
@@ -673,5 +674,5 @@
 	private void sendFileMessage(L2PcInstance player, String htmlMessage)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(htmlMessage);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2PcInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2PcInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2PcInstance.java	(revision 345)
@@ -9655,7 +9655,8 @@
 						
 						// Open a Html message to inform the player
-						NpcHtmlMessage htmlMsg = new NpcHtmlMessage(0);
-						htmlMsg.setFile("data/html/jail_out.htm");
-						sendPacket(htmlMsg);
+						final NpcHtmlMessage html = new NpcHtmlMessage(0);
+						html.setFile("data/html/jail_out.htm");
+						sendPacket(html);
+						
 						stopPunishTask(true);
 						teleToLocation(17836, 170178, -3507, 20); // Floran village
@@ -9715,9 +9716,9 @@
 				
 				// Open a Html message to inform the player
-				NpcHtmlMessage htmlMsg = new NpcHtmlMessage(0);
-				htmlMsg.setFile("data/html/jail_in.htm");
-				sendPacket(htmlMsg);
+				final NpcHtmlMessage html = new NpcHtmlMessage(0);
+				html.setFile("data/html/jail_in.htm");
+				sendPacket(html);
+				
 				setIsIn7sDungeon(false);
-				
 				teleToLocation(-114356, -249645, -2984, 0); // Jail
 				break;
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleMagicianInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleMagicianInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleMagicianInstance.java	(revision 345)
@@ -56,5 +56,5 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2RaceManagerInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2RaceManagerInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2RaceManagerInstance.java	(revision 345)
@@ -18,4 +18,5 @@
 import java.util.Locale;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.idfactory.IdFactory;
 import net.sf.l2j.gameserver.instancemanager.games.MonsterRace;
@@ -29,9 +30,8 @@
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
-import net.sf.l2j.util.StringUtil;
 
 public class L2RaceManagerInstance extends L2NpcInstance
 {
-	protected static final int _cost[] =
+	protected static final int TICKET_PRICES[] =
 	{
 		100,
@@ -87,5 +87,5 @@
 			String search, replace;
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			if (val < 10)
@@ -123,5 +123,5 @@
 				else
 				{
-					html.replace(search, _cost[val - 11]);
+					html.replace(search, TICKET_PRICES[val - 11]);
 					player.setRace(1, val - 10);
 				}
@@ -138,5 +138,5 @@
 				html.replace(search, replace);
 				search = "0adena";
-				int price = _cost[player.getRace(1) - 1];
+				int price = TICKET_PRICES[player.getRace(1) - 1];
 				html.replace(search, price);
 				search = "0tax";
@@ -155,5 +155,5 @@
 				int priceId = player.getRace(1);
 				
-				if (!player.reduceAdena("Race", _cost[priceId - 1], this, true))
+				if (!player.reduceAdena("Race", TICKET_PRICES[priceId - 1], this, true))
 					return;
 				
@@ -165,5 +165,5 @@
 				item.setEnchantLevel(MonsterRace.getInstance().getRaceNumber());
 				item.setCustomType1(ticket);
-				item.setCustomType2(_cost[priceId - 1] / 100);
+				item.setCustomType2(TICKET_PRICES[priceId - 1] / 100);
 				
 				player.addItem("Race", item, player, false);
@@ -171,5 +171,5 @@
 				
 				// Refresh lane bet.
-				MonsterRace.setBetOnLane(ticket, _cost[priceId - 1], true);
+				MonsterRace.setBetOnLane(ticket, TICKET_PRICES[priceId - 1], true);
 				super.onBypassFeedback(player, "Chat 0");
 				return;
@@ -189,5 +189,5 @@
 			}
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile(getHtmlPath(getTemplate().getNpcId(), 5));
 			for (int i = 0; i < 8; i++)
@@ -208,5 +208,5 @@
 		else if (command.equals("ShowInfo"))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile(getHtmlPath(getTemplate().getNpcId(), 6));
 			
@@ -223,9 +223,6 @@
 		else if (command.equals("ShowTickets"))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
-			html.setFile(getHtmlPath(getTemplate().getNpcId(), 7));
-			
 			// Generate data.
-			final StringBuilder replyMSG = new StringBuilder();
+			final StringBuilder sb = new StringBuilder();
 			
 			// Retrieve player's tickets.
@@ -236,8 +233,10 @@
 					continue;
 				
-				StringUtil.append(replyMSG, "<tr><td><a action=\"bypass -h npc_%objectId%_ShowTicket ", Integer.toString(ticket.getObjectId()), "\">", Integer.toString(ticket.getEnchantLevel()), " Race Number</a></td><td align=right><font color=\"LEVEL\">", Integer.toString(ticket.getCustomType1()), "</font> Number</td><td align=right><font color=\"LEVEL\">", Integer.toString(ticket.getCustomType2() * 100), "</font> Adena</td></tr>");
-			}
-			
-			html.replace("%tickets%", replyMSG.toString());
+				StringUtil.append(sb, "<tr><td><a action=\"bypass -h npc_%objectId%_ShowTicket ", ticket.getObjectId(), "\">", ticket.getEnchantLevel(), " Race Number</a></td><td align=right><font color=\"LEVEL\">", ticket.getCustomType1(), "</font> Number</td><td align=right><font color=\"LEVEL\">", ticket.getCustomType2() * 100, "</font> Adena</td></tr>");
+			}
+			
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			html.setFile(getHtmlPath(getTemplate().getNpcId(), 7));
+			html.replace("%tickets%", sb.toString());
 			html.replace("%objectId%", getObjectId());
 			player.sendPacket(html);
@@ -274,5 +273,5 @@
 			}
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile(getHtmlPath(getTemplate().getNpcId(), 8));
 			html.replace("%raceId%", raceId);
@@ -325,9 +324,6 @@
 		else if (command.equals("ViewHistory"))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
-			html.setFile(getHtmlPath(getTemplate().getNpcId(), 9));
-			
 			// Generate data.
-			final StringBuilder replyMSG = new StringBuilder();
+			final StringBuilder sb = new StringBuilder();
 			
 			// Use whole history, pickup from 'last element' and stop at 'latest element - 7'.
@@ -336,8 +332,10 @@
 			{
 				final HistoryInfo info = history.get(i);
-				StringUtil.append(replyMSG, "<tr><td><font color=\"LEVEL\">", String.valueOf(info.getRaceId()), "</font> th</td><td><font color=\"LEVEL\">", String.valueOf(info.getFirst()), "</font> Lane </td><td><font color=\"LEVEL\">", String.valueOf(info.getSecond()), "</font> Lane</td><td align=right><font color=00ffff>", String.format(Locale.ENGLISH, "%.2f", info.getOddRate()), "</font> Times</td></tr>");
-			}
-			
-			html.replace("%infos%", replyMSG.toString());
+				StringUtil.append(sb, "<tr><td><font color=\"LEVEL\">", info.getRaceId(), "</font> th</td><td><font color=\"LEVEL\">", info.getFirst(), "</font> Lane </td><td><font color=\"LEVEL\">", info.getSecond(), "</font> Lane</td><td align=right><font color=00ffff>", String.format(Locale.ENGLISH, "%.2f", info.getOddRate()), "</font> Times</td></tr>");
+			}
+			
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			html.setFile(getHtmlPath(getTemplate().getNpcId(), 9));
+			html.replace("%infos%", sb.toString());
 			html.replace("%objectId%", getObjectId());
 			player.sendPacket(html);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2GoldenRamInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2GoldenRamInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2GoldenRamInstance.java	(revision 345)
@@ -116,5 +116,5 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
@@ -148,5 +148,5 @@
 				}
 				
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/default/31556-" + val + ".htm");
 				player.sendPacket(html);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2OlympiadManagerInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2OlympiadManagerInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2OlympiadManagerInstance.java	(revision 345)
@@ -17,4 +17,5 @@
 import java.util.List;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.MultisellData;
 import net.sf.l2j.gameserver.model.actor.template.NpcTemplate;
@@ -28,5 +29,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.ExHeroList;
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -80,6 +80,5 @@
 		}
 		
-		// Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile("data/html/olympiad/" + filename);
 		
@@ -186,5 +185,5 @@
 			int val = Integer.parseInt(command.substring(9, 10));
 			
-			NpcHtmlMessage reply = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			switch (val)
 			{
@@ -194,11 +193,11 @@
 					{
 						List<String> names = Olympiad.getInstance().getClassLeaderBoard(classId);
-						reply.setFile(Olympiad.OLYMPIAD_HTML_PATH + "noble_ranking.htm");
+						html.setFile(Olympiad.OLYMPIAD_HTML_PATH + "noble_ranking.htm");
 						
 						int index = 1;
 						for (String name : names)
 						{
-							reply.replace("%place" + index + "%", index);
-							reply.replace("%rank" + index + "%", name);
+							html.replace("%place" + index + "%", index);
+							html.replace("%rank" + index + "%", name);
 							
 							index++;
@@ -209,45 +208,42 @@
 						for (; index <= 10; index++)
 						{
-							reply.replace("%place" + index + "%", "");
-							reply.replace("%rank" + index + "%", "");
-						}
-						
-						reply.replace("%objectId%", getObjectId());
-						player.sendPacket(reply);
+							html.replace("%place" + index + "%", "");
+							html.replace("%rank" + index + "%", "");
+						}
+						
+						html.replace("%objectId%", getObjectId());
+						player.sendPacket(html);
 					}
 					break;
 				
 				case 3: // Spectator overview
-					StringBuilder list = new StringBuilder(2000);
-					OlympiadGameTask task;
-					
-					reply.setFile(Olympiad.OLYMPIAD_HTML_PATH + "olympiad_observe_list.htm");
-					for (int i = 0; i <= 21; i++)
-					{
-						task = OlympiadGameManager.getInstance().getOlympiadTask(i);
-						if (task != null)
-						{
-							StringUtil.append(list, "<a action=\"bypass arenachange ", String.valueOf(i), "\">Arena ", String.valueOf(i + 1), "&nbsp;");
+					html.setFile(Olympiad.OLYMPIAD_HTML_PATH + "olympiad_observe_list.htm");
+					
+					int i = 0;
+					
+					final StringBuilder sb = new StringBuilder(2000);
+					for (OlympiadGameTask task : OlympiadGameManager.getInstance().getOlympiadTasks())
+					{
+						StringUtil.append(sb, "<a action=\"bypass arenachange ", i, "\">Arena ", ++i, "&nbsp;");
+						
+						if (task.isGameStarted())
+						{
+							if (task.isInTimerTime())
+								StringUtil.append(sb, "(&$907;)"); // Counting In Progress
+							else if (task.isBattleStarted())
+								StringUtil.append(sb, "(&$829;)"); // In Progress
+							else
+								StringUtil.append(sb, "(&$908;)"); // Terminate
+								
+							StringUtil.append(sb, "&nbsp;", task.getGame().getPlayerNames()[0], "&nbsp; : &nbsp;", task.getGame().getPlayerNames()[1]);
+						}
+						else
+							StringUtil.append(sb, "(&$906;)</td><td>&nbsp;"); // Initial State
 							
-							if (task.isGameStarted())
-							{
-								if (task.isInTimerTime())
-									StringUtil.append(list, "(&$907;)"); // Counting In Progress
-								else if (task.isBattleStarted())
-									StringUtil.append(list, "(&$829;)"); // In Progress
-								else
-									StringUtil.append(list, "(&$908;)"); // Terminate
-									
-								StringUtil.append(list, "&nbsp;", task.getGame().getPlayerNames()[0], "&nbsp; : &nbsp;", task.getGame().getPlayerNames()[1]);
-							}
-							else
-								StringUtil.append(list, "(&$906;)", "</td><td>&nbsp;"); // Initial State
-								
-							StringUtil.append(list, "</a><br>");
-						}
-					}
-					reply.replace("%list%", list.toString());
-					reply.replace("%objectId%", getObjectId());
-					player.sendPacket(reply);
+						StringUtil.append(sb, "</a><br>");
+					}
+					html.replace("%list%", sb.toString());
+					html.replace("%objectId%", getObjectId());
+					player.sendPacket(html);
 					break;
 				
@@ -259,7 +255,7 @@
 					if (Hero.getInstance().isInactiveHero(player.getObjectId()))
 					{
-						reply.setFile(Olympiad.OLYMPIAD_HTML_PATH + "hero_confirm.htm");
-						reply.replace("%objectId%", getObjectId());
-						player.sendPacket(reply);
+						html.setFile(Olympiad.OLYMPIAD_HTML_PATH + "hero_confirm.htm");
+						html.replace("%objectId%", getObjectId());
+						player.sendPacket(html);
 					}
 					break;
@@ -279,5 +275,5 @@
 				
 				case 7: // Main panel
-					reply.setFile(Olympiad.OLYMPIAD_HTML_PATH + "hero_main.htm");
+					html.setFile(Olympiad.OLYMPIAD_HTML_PATH + "hero_main.htm");
 					
 					String hiddenText = "";
@@ -285,7 +281,7 @@
 						hiddenText = "<a action=\"bypass -h npc_%objectId%_Olympiad 5\">\"I want to be a Hero.\"</a><br>";
 					
-					reply.replace("%hero%", hiddenText);
-					reply.replace("%objectId%", getObjectId());
-					player.sendPacket(reply);
+					html.replace("%hero%", hiddenText);
+					html.replace("%objectId%", getObjectId());
+					player.sendPacket(html);
 					break;
 				
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2MercManagerInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2MercManagerInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2MercManagerInstance.java	(revision 345)
@@ -87,5 +87,5 @@
 			filename = "data/html/mercmanager/mercmanager.htm"; // Owner message window
 			
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClassMasterInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClassMasterInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClassMasterInstance.java	(revision 345)
@@ -18,4 +18,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.CharTemplateTable;
 import net.sf.l2j.gameserver.datatables.ItemTable;
@@ -28,5 +29,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;
 import net.sf.l2j.gameserver.network.serverpackets.UserInfo;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -59,6 +59,5 @@
 			filename = "data/html/classmaster/" + getNpcId() + ".htm";
 		
-		// Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
@@ -84,5 +83,5 @@
 			if (checkAndChangeClass(player, val))
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/classmaster/ok.htm");
 				html.replace("%name%", CharTemplateTable.getInstance().getClassNameById(val));
@@ -92,5 +91,5 @@
 		else if (command.startsWith("become_noble"))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			
 			if (!player.isNoble())
@@ -118,12 +117,12 @@
 	private static final void showHtmlMenu(L2PcInstance player, int objectId, int level)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(objectId);
+		final NpcHtmlMessage html = new NpcHtmlMessage(objectId);
 		
 		if (!Config.CLASS_MASTER_SETTINGS.isAllowed(level))
 		{
-			int jobLevel = player.getClassId().level();
 			final StringBuilder sb = new StringBuilder(100);
 			sb.append("<html><body>");
-			switch (jobLevel)
+			
+			switch (player.getClassId().level())
 			{
 				case 0:
@@ -137,4 +136,5 @@
 						sb.append("I can't change your occupation.<br>");
 					break;
+				
 				case 1:
 					if (Config.CLASS_MASTER_SETTINGS.isAllowed(2))
@@ -145,4 +145,5 @@
 						sb.append("I can't change your occupation.<br>");
 					break;
+				
 				case 2:
 					if (Config.CLASS_MASTER_SETTINGS.isAllowed(3))
@@ -151,4 +152,5 @@
 						sb.append("I can't change your occupation.<br>");
 					break;
+				
 				case 3:
 					sb.append("There is no class change available for you anymore.<br>");
@@ -172,5 +174,5 @@
 					{
 						if (validateClassId(currentClassId, cid) && cid.level() == level)
-							StringUtil.append(menu, "<a action=\"bypass -h npc_%objectId%_change_class ", String.valueOf(cid.getId()), "\">", CharTemplateTable.getInstance().getClassNameById(cid.getId()), "</a><br>");
+							StringUtil.append(menu, "<a action=\"bypass -h npc_%objectId%_change_class ", cid.getId(), "\">", CharTemplateTable.getInstance().getClassNameById(cid.getId()), "</a><br>");
 					}
 					
@@ -325,7 +327,7 @@
 			return "<tr><td>none</td></r>";
 		
-		StringBuilder sb = new StringBuilder();
+		final StringBuilder sb = new StringBuilder();
 		for (ItemHolder item : neededItems)
-			sb.append("<tr><td><font color=\"LEVEL\">" + item.getCount() + "</font></td><td>" + ItemTable.getInstance().getTemplate(item.getId()).getName() + "</td></tr>");
+			StringUtil.append(sb, "<tr><td><font color=\"LEVEL\">", item.getCount(), "</font></td><td>", ItemTable.getInstance().getTemplate(item.getId()).getName(), "</td></tr>");
 		
 		return sb.toString();
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SepulcherNpcInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SepulcherNpcInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SepulcherNpcInstance.java	(revision 345)
@@ -235,5 +235,5 @@
 	public void showChatWindow(L2PcInstance player, int val)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(getHtmlPath(getNpcId(), val));
 		html.replace("%objectId%", getObjectId());
@@ -391,5 +391,5 @@
 	public void showHtmlFile(L2PcInstance player, String file)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile("data/html/sepulchers/" + file);
 		html.replace("%npcname%", getName());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DuskPriestInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DuskPriestInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DuskPriestInstance.java	(revision 345)
@@ -103,5 +103,5 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SiegeNpcInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SiegeNpcInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SiegeNpcInstance.java	(revision 345)
@@ -33,5 +33,5 @@
 		else
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/siege/" + getNpcId() + "-busy.htm");
 			html.replace("%castlename%", getCastle().getName());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleWarehouseInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleWarehouseInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2CastleWarehouseInstance.java	(revision 345)
@@ -45,5 +45,5 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DoorInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DoorInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DoorInstance.java	(revision 345)
@@ -16,8 +16,5 @@
 
 import java.util.concurrent.ScheduledFuture;
-import java.util.logging.Level;
-import java.util.logging.Logger;
 
-import net.sf.l2j.Config;
 import net.sf.l2j.gameserver.ThreadPoolManager;
 import net.sf.l2j.gameserver.ai.CtrlIntention;
@@ -49,6 +46,4 @@
 public class L2DoorInstance extends L2Character
 {
-	protected static final Logger log = Logger.getLogger(L2DoorInstance.class.getName());
-	
 	/** The castle index in the array of L2Castle this L2Npc belongs to */
 	private int _castleIndex = -2;
@@ -140,12 +135,5 @@
 		public void run()
 		{
-			try
-			{
-				onClose();
-			}
-			catch (Throwable e)
-			{
-				log.log(Level.SEVERE, "", e);
-			}
+			onClose();
 		}
 	}
@@ -159,26 +147,8 @@
 		public void run()
 		{
-			try
-			{
-				String doorAction;
-				
-				if (!isOpened())
-				{
-					doorAction = "opened";
-					openMe();
-				}
-				else
-				{
-					doorAction = "closed";
-					closeMe();
-				}
-				
-				if (Config.DEBUG)
-					log.info("Auto " + doorAction + " door ID " + _doorId + " (" + getName() + ") for " + (_autoActionDelay / 60000) + " minute(s).");
-			}
-			catch (Exception e)
-			{
-				log.warning("Could not auto open/close door ID " + _doorId + " (" + getName() + ")");
-			}
+			if (!isOpened())
+				openMe();
+			else
+				closeMe();
 		}
 	}
@@ -409,21 +379,16 @@
 		if (player.isGM())
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/admin/infos/doorinfo.htm");
-			
 			html.replace("%class%", getClass().getSimpleName());
 			html.replace("%objid%", getObjectId());
 			html.replace("%doorid%", getDoorId());
-			
 			html.replace("%hp%", (int) getCurrentHp());
 			html.replace("%hpmax%", getMaxHp());
-			
 			html.replace("%pdef%", getPDef(null));
 			html.replace("%mdef%", getMDef(null, null));
-			
 			html.replace("%minx%", getXMin());
 			html.replace("%miny%", getYMin());
 			html.replace("%minz%", getZMin());
-			
 			html.replace("%maxx%", getXMax());
 			html.replace("%maxy%", getYMax());
@@ -431,5 +396,4 @@
 			html.replace("%unlock%", isUnlockable() ? "<font color=00FF00>YES<font>" : "<font color=FF0000>NO</font>");
 			html.replace("%isWall%", isWall() ? "<font color=00FF00>YES<font>" : "<font color=FF0000>NO</font>");
-			
 			player.sendPacket(html);
 			player.sendPacket(ActionFailed.STATIC_PACKET);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2BufferInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2BufferInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2BufferInstance.java	(revision 345)
@@ -25,4 +25,5 @@
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.BufferTable;
 import net.sf.l2j.gameserver.datatables.SkillTable;
@@ -47,5 +48,5 @@
 		if (currentCommand.startsWith("menu"))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(1);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
 			html.setFile(getHtmlPath(getNpcId(), 0));
 			html.replace("%objectId%", getObjectId());
@@ -60,5 +61,5 @@
 				summon.stopAllEffectsExceptThoseThatLastThroughDeath();
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(1);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
 			html.setFile(getHtmlPath(getNpcId(), 0));
 			html.replace("%objectId%", getObjectId());
@@ -74,5 +75,5 @@
 				summon.setCurrentHpMp(summon.getMaxHp(), summon.getMaxMp());
 			
-			NpcHtmlMessage html = new NpcHtmlMessage(1);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
 			html.setFile(getHtmlPath(getNpcId(), 0));
 			html.replace("%objectId%", getObjectId());
@@ -222,5 +223,5 @@
 	private void showGiveBuffsWindow(L2PcInstance player, String targetType)
 	{
-		final StringBuilder sb = new StringBuilder();
+		final StringBuilder sb = new StringBuilder(200);
 		
 		final Map<String, ArrayList<Integer>> schemes = BufferTable.getInstance().getPlayerSchemes(player.getObjectId());
@@ -232,9 +233,9 @@
 			{
 				final int cost = getFee(scheme.getValue());
-				sb.append("<font color=\"LEVEL\"><a action=\"bypass -h npc_%objectId%_givebuffs " + targetType + " " + scheme.getKey() + " " + cost + "\">" + scheme.getKey() + " (" + scheme.getValue().size() + " skill(s))</a>" + ((cost > 0) ? " - Adena cost: " + cost : "") + "</font><br1>");
-			}
-		}
-		
-		NpcHtmlMessage html = new NpcHtmlMessage(1);
+				StringUtil.append(sb, "<font color=\"LEVEL\"><a action=\"bypass -h npc_%objectId%_givebuffs ", targetType, " ", scheme.getKey(), " ", cost, "\">", scheme.getKey(), " (", scheme.getValue().size(), " skill(s))</a>", ((cost > 0) ? " - Adena cost: " + cost : ""), "</font><br1>");
+			}
+		}
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		html.setFile(getHtmlPath(getNpcId(), 1));
 		html.replace("%schemes%", sb.toString());
@@ -250,5 +251,5 @@
 	private void showManageSchemeWindow(L2PcInstance player)
 	{
-		final StringBuilder sb = new StringBuilder();
+		final StringBuilder sb = new StringBuilder(200);
 		
 		final Map<String, ArrayList<Integer>> schemes = BufferTable.getInstance().getPlayerSchemes(player.getObjectId());
@@ -259,13 +260,10 @@
 			sb.append("<table>");
 			for (Map.Entry<String, ArrayList<Integer>> scheme : schemes.entrySet())
-			{
-				sb.append("<tr><td width=140>" + scheme.getKey() + " (" + scheme.getValue().size() + " skill(s))</td>");
-				sb.append("<td width=60><button value=\"Clear\" action=\"bypass -h npc_%objectId%_clearscheme " + scheme.getKey() + "\" width=55 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td>");
-				sb.append("<td width=60><button value=\"Drop\" action=\"bypass -h npc_%objectId%_deletescheme " + scheme.getKey() + "\" width=55 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td></tr>");
-			}
+				StringUtil.append(sb, "<tr><td width=140>", scheme.getKey(), " (", scheme.getValue().size(), " skill(s))</td><td width=60><button value=\"Clear\" action=\"bypass -h npc_%objectId%_clearscheme ", scheme.getKey(), "\" width=55 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td><td width=60><button value=\"Drop\" action=\"bypass -h npc_%objectId%_deletescheme ", scheme.getKey(), "\" width=55 height=15 back=\"sek.cbui94\" fore=\"sek.cbui92\"></td></tr>");
+			
 			sb.append("</table>");
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(1);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		html.setFile(getHtmlPath(getNpcId(), 2));
 		html.replace("%schemes%", sb.toString());
@@ -283,5 +281,5 @@
 	private void showEditSchemeWindow(L2PcInstance player, String groupType, String schemeName)
 	{
-		NpcHtmlMessage html = new NpcHtmlMessage(1);
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
 		
 		if (schemeName.equalsIgnoreCase("none"))
@@ -316,18 +314,18 @@
 			return "Please create at least one scheme.";
 		
-		StringBuilder tb = new StringBuilder();
-		tb.append("<table>");
+		final StringBuilder sb = new StringBuilder(200);
+		sb.append("<table>");
 		
 		for (Map.Entry<String, ArrayList<Integer>> scheme : schemes.entrySet())
 		{
 			if (schemeName.equalsIgnoreCase(scheme.getKey()))
-				tb.append("<tr><td width=200>" + scheme.getKey() + " (<font color=\"LEVEL\">" + scheme.getValue().size() + "</font> / " + Config.BUFFER_MAX_SKILLS + " skill(s))</td></tr>");
+				StringUtil.append(sb, "<tr><td width=200>", scheme.getKey(), " (<font color=\"LEVEL\">", scheme.getValue().size(), "</font> / ", Config.BUFFER_MAX_SKILLS, " skill(s))</td></tr>");
 			else
-				tb.append("<tr><td width=200><a action=\"bypass -h npc_%objectId%_editschemes none " + scheme.getKey() + "\">" + scheme.getKey() + " (" + scheme.getValue().size() + " / " + Config.BUFFER_MAX_SKILLS + " skill(s))</a></td></tr>");
-		}
-		
-		tb.append("</table>");
-		
-		return tb.toString();
+				StringUtil.append(sb, "<tr><td width=200><a action=\"bypass -h npc_%objectId%_editschemes none ", scheme.getKey(), "\">", scheme.getKey(), " (", scheme.getValue().size(), " / ", Config.BUFFER_MAX_SKILLS, " skill(s))</a></td></tr>");
+		}
+		
+		sb.append("</table>");
+		
+		return sb.toString();
 	}
 	
@@ -352,7 +350,7 @@
 			return "That group doesn't contain any skills.";
 		
-		StringBuilder tb = new StringBuilder();
-		
-		tb.append("<table>");
+		final StringBuilder sb = new StringBuilder(500);
+		
+		sb.append("<table>");
 		int count = 0;
 		for (int skillId : skills)
@@ -362,27 +360,27 @@
 			
 			if (count == 0)
-				tb.append("<tr>");
+				sb.append("<tr>");
 			
 			if (skillId < 100)
-				tb.append("<td><button action=\"bypass -h npc_%objectId%_skillselect " + groupType + " " + schemeName + " " + skillId + "\" width=32 height=32 back=\"icon.skill00" + skillId + "\" fore=\"icon.skill00" + skillId + "\"></td>");
+				StringUtil.append(sb, "<td><button action=\"bypass -h npc_%objectId%_skillselect ", groupType, " ", schemeName, " ", skillId, "\" width=32 height=32 back=\"icon.skill00", skillId, "\" fore=\"icon.skill00", skillId, "\"></td>");
 			else if (skillId < 1000)
-				tb.append("<td><button action=\"bypass -h npc_%objectId%_skillselect " + groupType + " " + schemeName + " " + skillId + "\" width=32 height=32 back=\"icon.skill0" + skillId + "\" fore=\"icon.skill0" + skillId + "\"></td>");
+				StringUtil.append(sb, "<td><button action=\"bypass -h npc_%objectId%_skillselect ", groupType, " ", schemeName, " ", skillId, "\" width=32 height=32 back=\"icon.skill0", skillId, "\" fore=\"icon.skill0", skillId, "\"></td>");
 			else
-				tb.append("<td><button action=\"bypass -h npc_%objectId%_skillselect " + groupType + " " + schemeName + " " + skillId + "\" width=32 height=32 back=\"icon.skill" + skillId + "\" fore=\"icon.skill" + skillId + "\"></td>");
+				StringUtil.append(sb, "<td><button action=\"bypass -h npc_%objectId%_skillselect ", groupType, " ", schemeName, " ", skillId, "\" width=32 height=32 back=\"icon.skill", skillId, "\" fore=\"icon.skill", skillId, "\"></td>");
 			
 			count++;
 			if (count == 6)
 			{
-				tb.append("</tr>");
+				sb.append("</tr>");
 				count = 0;
 			}
 		}
 		
-		if (!tb.toString().endsWith("</tr>"))
-			tb.append("</tr>");
-		
-		tb.append("</table>");
-		
-		return tb.toString();
+		if (!sb.toString().endsWith("</tr>"))
+			sb.append("</tr>");
+		
+		sb.append("</table>");
+		
+		return sb.toString();
 	}
 	
@@ -399,6 +397,6 @@
 			return "That scheme is empty.";
 		
-		StringBuilder tb = new StringBuilder();
-		tb.append("<table>");
+		final StringBuilder sb = new StringBuilder(500);
+		sb.append("<table>");
 		int count = 0;
 		
@@ -406,27 +404,27 @@
 		{
 			if (count == 0)
-				tb.append("<tr>");
+				sb.append("<tr>");
 			
 			if (sk < 100)
-				tb.append("<td><button action=\"bypass -h npc_%objectId%_skillunselect " + groupType + " " + schemeName + " " + sk + "\" width=32 height=32 back=\"icon.skill00" + sk + "\" fore=\"icon.skill00" + sk + "\"></td>");
+				StringUtil.append(sb, "<td><button action=\"bypass -h npc_%objectId%_skillunselect ", groupType, " ", schemeName, " ", sk, "\" width=32 height=32 back=\"icon.skill00", sk, "\" fore=\"icon.skill00", sk, "\"></td>");
 			else if (sk < 1000)
-				tb.append("<td><button action=\"bypass -h npc_%objectId%_skillunselect " + groupType + " " + schemeName + " " + sk + "\" width=32 height=32 back=\"icon.skill0" + sk + "\" fore=\"icon.skill0" + sk + "\"></td>");
+				StringUtil.append(sb, "<td><button action=\"bypass -h npc_%objectId%_skillunselect ", groupType, " ", schemeName, " ", sk, "\" width=32 height=32 back=\"icon.skill0", sk, "\" fore=\"icon.skill0", sk, "\"></td>");
 			else
-				tb.append("<td><button action=\"bypass -h npc_%objectId%_skillunselect " + groupType + " " + schemeName + " " + sk + "\" width=32 height=32 back=\"icon.skill" + sk + "\" fore=\"icon.skill" + sk + "\"></td>");
+				StringUtil.append(sb, "<td><button action=\"bypass -h npc_%objectId%_skillunselect ", groupType, " ", schemeName, " ", sk, "\" width=32 height=32 back=\"icon.skill", sk, "\" fore=\"icon.skill", sk, "\"></td>");
 			
 			count++;
 			if (count == 6)
 			{
-				tb.append("</tr>");
+				sb.append("</tr>");
 				count = 0;
 			}
 		}
 		
-		if (!tb.toString().endsWith("<tr>"))
-			tb.append("<tr>");
-		
-		tb.append("</table>");
-		
-		return tb.toString();
+		if (!sb.toString().endsWith("<tr>"))
+			sb.append("<tr>");
+		
+		sb.append("</table>");
+		
+		return sb.toString();
 	}
 	
@@ -438,6 +436,6 @@
 	private static String getTypesFrame(String groupType, String schemeName)
 	{
-		StringBuilder tb = new StringBuilder();
-		tb.append("<table>");
+		final StringBuilder sb = new StringBuilder(500);
+		sb.append("<table>");
 		
 		int count = 0;
@@ -445,25 +443,25 @@
 		{
 			if (count == 0)
-				tb.append("<tr>");
+				sb.append("<tr>");
 			
 			if (groupType.equalsIgnoreCase(s))
-				tb.append("<td width=65>" + s + "</td>");
+				StringUtil.append(sb, "<td width=65>", s, "</td>");
 			else
-				tb.append("<td width=65><a action=\"bypass -h npc_%objectId%_editschemes " + s + " " + schemeName + "\">" + s + "</a></td>");
+				StringUtil.append(sb, "<td width=65><a action=\"bypass -h npc_%objectId%_editschemes ", s, " ", schemeName, "\">", s, "</a></td>");
 			
 			count++;
 			if (count == 4)
 			{
-				tb.append("</tr>");
+				sb.append("</tr>");
 				count = 0;
 			}
 		}
 		
-		if (!tb.toString().endsWith("</tr>"))
-			tb.append("</tr>");
-		
-		tb.append("</table>");
-		
-		return tb.toString();
+		if (!sb.toString().endsWith("</tr>"))
+			sb.append("</tr>");
+		
+		sb.append("</table>");
+		
+		return sb.toString();
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClanHallManagerInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClanHallManagerInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2ClanHallManagerInstance.java	(revision 345)
@@ -15,8 +15,8 @@
 package net.sf.l2j.gameserver.model.actor.instance;
 
-import java.text.SimpleDateFormat;
 import java.util.StringTokenizer;
 
 import net.sf.l2j.Config;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.datatables.SkillTable;
 import net.sf.l2j.gameserver.datatables.TeleportLocationTable;
@@ -88,6 +88,4 @@
 		if (condition == COND_OWNER)
 		{
-			SimpleDateFormat format = new SimpleDateFormat("dd/MM/yyyy HH:mm");
-			
 			StringTokenizer st = new StringTokenizer(command, " ");
 			String actualCommand = st.nextToken();
@@ -97,5 +95,5 @@
 			if (actualCommand.equalsIgnoreCase("banish_foreigner"))
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				
 				if ((player.getClanPrivileges() & L2Clan.CP_CH_DISMISS) == L2Clan.CP_CH_DISMISS)
@@ -117,5 +115,5 @@
 			else if (actualCommand.equalsIgnoreCase("manage_vault"))
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				
 				if ((player.getClanPrivileges() & L2Clan.CP_CL_VIEW_WAREHOUSE) == L2Clan.CP_CL_VIEW_WAREHOUSE)
@@ -123,5 +121,5 @@
 					html.setFile("data/html/clanHallManager/vault.htm");
 					html.replace("%rent%", getClanHall().getLease());
-					html.replace("%date%", format.format(getClanHall().getPaidUntil()));
+					html.replace("%date%", StringUtil.DATE_MM.format(getClanHall().getPaidUntil()));
 				}
 				else
@@ -133,5 +131,5 @@
 			else if (actualCommand.equalsIgnoreCase("door"))
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				
 				if ((player.getClanPrivileges() & L2Clan.CP_CH_OPEN_DOOR) == L2Clan.CP_CH_OPEN_DOOR)
@@ -160,5 +158,5 @@
 				if (val.equalsIgnoreCase("tele"))
 				{
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					
 					final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_TELEPORT);
@@ -179,5 +177,5 @@
 					if (chf == null)
 					{
-						NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+						final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 						html.setFile("data/html/clanHallManager/chamberlain-nac.htm");
 						html.replace("%objectId%", getObjectId());
@@ -190,5 +188,5 @@
 				else if (val.equalsIgnoreCase("support"))
 				{
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					
 					final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_SUPPORT);
@@ -207,5 +205,5 @@
 				else
 				{
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					html.setFile("data/html/clanHallManager/functions.htm");
 					
@@ -248,5 +246,5 @@
 							if (val.equalsIgnoreCase("hp_cancel"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-cancel.htm");
 								html.replace("%apply%", "recovery hp 0");
@@ -256,5 +254,5 @@
 							else if (val.equalsIgnoreCase("mp_cancel"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-cancel.htm");
 								html.replace("%apply%", "recovery mp 0");
@@ -264,5 +262,5 @@
 							else if (val.equalsIgnoreCase("exp_cancel"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-cancel.htm");
 								html.replace("%apply%", "recovery exp 0");
@@ -272,5 +270,5 @@
 							else if (val.equalsIgnoreCase("edit_hp"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-apply.htm");
 								html.replace("%name%", "Fireplace (HP Recovery Device)");
@@ -342,5 +340,5 @@
 							else if (val.equalsIgnoreCase("edit_mp"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-apply.htm");
 								html.replace("%name%", "Carpet (MP Recovery)");
@@ -380,5 +378,5 @@
 							else if (val.equalsIgnoreCase("edit_exp"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-apply.htm");
 								html.replace("%name%", "Chandelier (EXP Recovery Device)");
@@ -429,5 +427,5 @@
 								final int percent = Integer.parseInt(val);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								
 								final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_RESTORE_HP);
@@ -517,5 +515,5 @@
 								final int percent = Integer.parseInt(val);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								
 								final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_RESTORE_MP);
@@ -573,5 +571,5 @@
 								final int percent = Integer.parseInt(val);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								
 								final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_RESTORE_EXP);
@@ -635,5 +633,5 @@
 						else
 						{
-							NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+							final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 							html.setFile("data/html/clanHallManager/edit_recovery.htm");
 							
@@ -645,5 +643,5 @@
 							{
 								html.replace("%hp_recovery%", chfHp.getLvl() + "%</font> (<font color=\"FFAABB\">" + chfHp.getLease() + "</font> adenas / " + (Config.CH_HPREG_FEE_RATIO / 86400000) + " day)");
-								html.replace("%hp_period%", "Next fee at " + format.format(chfHp.getEndTime()));
+								html.replace("%hp_period%", "Next fee at " + StringUtil.DATE_MM.format(chfHp.getEndTime()));
 								
 								switch (grade)
@@ -696,5 +694,5 @@
 							{
 								html.replace("%exp_recovery%", chfExp.getLvl() + "%</font> (<font color=\"FFAABB\">" + chfExp.getLease() + "</font> adenas / " + (Config.CH_EXPREG_FEE_RATIO / 86400000) + " day)");
-								html.replace("%exp_period%", "Next fee at " + format.format(chfExp.getEndTime()));
+								html.replace("%exp_period%", "Next fee at " + StringUtil.DATE_MM.format(chfExp.getEndTime()));
 								
 								switch (grade)
@@ -747,5 +745,5 @@
 							{
 								html.replace("%mp_recovery%", chfMp.getLvl() + "%</font> (<font color=\"FFAABB\">" + chfMp.getLease() + "</font> adenas / " + (Config.CH_MPREG_FEE_RATIO / 86400000) + " day)");
-								html.replace("%mp_period%", "Next fee at " + format.format(chfMp.getEndTime()));
+								html.replace("%mp_period%", "Next fee at " + StringUtil.DATE_MM.format(chfMp.getEndTime()));
 								
 								switch (grade)
@@ -807,5 +805,5 @@
 							if (val.equalsIgnoreCase("item_cancel"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-cancel.htm");
 								html.replace("%apply%", "other item 0");
@@ -815,5 +813,5 @@
 							else if (val.equalsIgnoreCase("tele_cancel"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-cancel.htm");
 								html.replace("%apply%", "other tele 0");
@@ -823,5 +821,5 @@
 							else if (val.equalsIgnoreCase("support_cancel"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-cancel.htm");
 								html.replace("%apply%", "other support 0");
@@ -831,5 +829,5 @@
 							else if (val.equalsIgnoreCase("edit_item"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-apply.htm");
 								html.replace("%name%", "Magic Equipment (Item Production Facilities)");
@@ -861,5 +859,5 @@
 							else if (val.equalsIgnoreCase("edit_support"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-apply.htm");
 								html.replace("%name%", "Insignia (Supplementary Magic)");
@@ -911,5 +909,5 @@
 							else if (val.equalsIgnoreCase("edit_tele"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-apply.htm");
 								html.replace("%name%", "Mirror (Teleportation Device)");
@@ -943,5 +941,5 @@
 								final int lvl = Integer.parseInt(val);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								
 								final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_ITEM_CREATE);
@@ -991,5 +989,5 @@
 								final int lvl = Integer.parseInt(val);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								
 								final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_TELEPORT);
@@ -1035,5 +1033,5 @@
 								final int lvl = Integer.parseInt(val);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								
 								final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_SUPPORT);
@@ -1101,5 +1099,5 @@
 						else
 						{
-							NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+							final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 							html.setFile("data/html/clanHallManager/edit_other.htm");
 							
@@ -1108,5 +1106,5 @@
 							{
 								html.replace("%tele%", "- Stage " + chfTel.getLvl() + "</font> (<font color=\"FFAABB\">" + chfTel.getLease() + "</font> adenas / " + (Config.CH_TELE_FEE_RATIO / 86400000) + " day)");
-								html.replace("%tele_period%", "Next fee at " + format.format(chfTel.getEndTime()));
+								html.replace("%tele_period%", "Next fee at " + StringUtil.DATE_MM.format(chfTel.getEndTime()));
 								html.replace("%change_tele%", "[<a action=\"bypass -h npc_%objectId%_manage other tele_cancel\">Remove</a>]" + tele);
 							}
@@ -1124,5 +1122,5 @@
 							{
 								html.replace("%support%", "- Stage " + chfSup.getLvl() + "</font> (<font color=\"FFAABB\">" + chfSup.getLease() + "</font> adenas / " + (Config.CH_SUPPORT_FEE_RATIO / 86400000) + " day)");
-								html.replace("%support_period%", "Next fee at " + format.format(chfSup.getEndTime()));
+								html.replace("%support_period%", "Next fee at " + StringUtil.DATE_MM.format(chfSup.getEndTime()));
 								
 								switch (grade)
@@ -1174,5 +1172,5 @@
 							{
 								html.replace("%item%", "- Stage " + chfCreate.getLvl() + "</font> (<font color=\"FFAABB\">" + chfCreate.getLease() + "</font> adenas / " + (Config.CH_ITEM_FEE_RATIO / 86400000) + " day)");
-								html.replace("%item_period%", "Next fee at " + format.format(chfCreate.getEndTime()));
+								html.replace("%item_period%", "Next fee at " + StringUtil.DATE_MM.format(chfCreate.getEndTime()));
 								html.replace("%change_item%", "[<a action=\"bypass -h npc_%objectId%_manage other item_cancel\">Remove</a>]" + item);
 							}
@@ -1197,5 +1195,5 @@
 							if (val.equalsIgnoreCase("curtains_cancel"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-cancel.htm");
 								html.replace("%apply%", "deco curtains 0");
@@ -1205,5 +1203,5 @@
 							else if (val.equalsIgnoreCase("fixtures_cancel"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-cancel.htm");
 								html.replace("%apply%", "deco fixtures 0");
@@ -1213,5 +1211,5 @@
 							else if (val.equalsIgnoreCase("edit_curtains"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-apply.htm");
 								html.replace("%name%", "Curtains (Decoration)");
@@ -1239,5 +1237,5 @@
 							else if (val.equalsIgnoreCase("edit_fixtures"))
 							{
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								html.setFile("data/html/clanHallManager/functions-apply.htm");
 								html.replace("%name%", "Front Platform (Decoration)");
@@ -1268,5 +1266,5 @@
 								final int lvl = Integer.parseInt(val);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								
 								final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_DECO_CURTAINS);
@@ -1312,5 +1310,5 @@
 								final int lvl = Integer.parseInt(val);
 								
-								NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+								final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 								
 								final ClanHallFunction chf = getClanHall().getFunction(ClanHall.FUNC_DECO_FRONTPLATEFORM);
@@ -1354,5 +1352,5 @@
 						else
 						{
-							NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+							final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 							html.setFile("data/html/clanHallManager/deco.htm");
 							
@@ -1361,5 +1359,5 @@
 							{
 								html.replace("%curtain%", "- Stage " + chfCurtains.getLvl() + "</font> (<font color=\"FFAABB\">" + chfCurtains.getLease() + "</font> adenas / " + (Config.CH_CURTAIN_FEE_RATIO / 86400000) + " day)");
-								html.replace("%curtain_period%", "Next fee at " + format.format(chfCurtains.getEndTime()));
+								html.replace("%curtain_period%", "Next fee at " + StringUtil.DATE_MM.format(chfCurtains.getEndTime()));
 								html.replace("%change_curtain%", "[<a action=\"bypass -h npc_%objectId%_manage deco curtains_cancel\">Remove</a>]" + curtains);
 							}
@@ -1375,5 +1373,5 @@
 							{
 								html.replace("%fixture%", "- Stage " + chfPlateform.getLvl() + "</font> (<font color=\"FFAABB\">" + chfPlateform.getLease() + "</font> adenas / " + (Config.CH_FRONT_FEE_RATIO / 86400000) + " day)");
-								html.replace("%fixture_period%", "Next fee at " + format.format(chfPlateform.getEndTime()));
+								html.replace("%fixture_period%", "Next fee at " + StringUtil.DATE_MM.format(chfPlateform.getEndTime()));
 								html.replace("%change_fixture%", "[<a action=\"bypass -h npc_%objectId%_manage deco fixtures_cancel\">Remove</a>]" + fixtures);
 							}
@@ -1392,5 +1390,5 @@
 					else
 					{
-						NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+						final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 						html.setFile("data/html/clanHallManager/manage.htm");
 						html.replace("%objectId%", getObjectId());
@@ -1400,5 +1398,5 @@
 				else
 				{
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					html.setFile("data/html/clanHallManager/not_authorized.htm");
 					html.replace("%objectId%", getObjectId());
@@ -1435,5 +1433,5 @@
 						else
 						{
-							NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+							final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 							html.setFile("data/html/clanHallManager/support-no_mana.htm");
 							html.replace("%mp%", (int) getCurrentMp());
@@ -1444,5 +1442,5 @@
 					}
 					
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					html.setFile("data/html/clanHallManager/support-done.htm");
 					html.replace("%mp%", (int) getCurrentMp());
@@ -1457,5 +1455,5 @@
 			else if (actualCommand.equalsIgnoreCase("list_back"))
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/clanHallManager/chamberlain.htm");
 				html.replace("%npcname%", getName());
@@ -1469,5 +1467,5 @@
 					return;
 				
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 				html.setFile("data/html/clanHallManager/support" + getClanHall().getFunction(ClanHall.FUNC_SUPPORT).getLvl() + ".htm");
 				html.replace("%mp%", (int) getStatus().getCurrentMp());
@@ -1535,5 +1533,5 @@
 			filename = "data/html/clanHallManager/chamberlain.htm";
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SignsPriestInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SignsPriestInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2SignsPriestInstance.java	(revision 345)
@@ -434,5 +434,5 @@
 							path = SevenSigns.SEVEN_SIGNS_HTML_PATH + "signs_6_dusk_contribute.htm";
 						
-						NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+						final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 						html.setFile(path);
 						html.replace("%contribStoneColor%", contribStoneColor);
@@ -702,10 +702,10 @@
 				
 				case 20: // Seal Status (for when joining a cabal)
-					StringBuilder contentBuffer = new StringBuilder();
+					final StringBuilder sb = new StringBuilder();
 					
 					if (this instanceof L2DawnPriestInstance)
-						contentBuffer.append("<html><body>Priest of Dawn:<br><font color=\"LEVEL\">[ Seal Status ]</font><br>");
-					else
-						contentBuffer.append("<html><body>Dusk Priestess:<br><font color=\"LEVEL\">[ Status of the Seals ]</font><br>");
+						sb.append("<html><body>Priest of Dawn:<br><font color=\"LEVEL\">[ Seal Status ]</font><br>");
+					else
+						sb.append("<html><body>Dusk Priestess:<br><font color=\"LEVEL\">[ Status of the Seals ]</font><br>");
 					
 					for (int i = 1; i < 4; i++)
@@ -714,13 +714,13 @@
 						
 						if (sealOwner != SevenSigns.CABAL_NULL)
-							contentBuffer.append("[" + SevenSigns.getSealName(i, false) + ": " + SevenSigns.getCabalName(sealOwner) + "]<br>");
-						else
-							contentBuffer.append("[" + SevenSigns.getSealName(i, false) + ": Nothingness]<br>");
-					}
-					
-					contentBuffer.append("<a action=\"bypass -h npc_" + getObjectId() + "_Chat 0\">Go back.</a></body></html>");
+							sb.append("[" + SevenSigns.getSealName(i, false) + ": " + SevenSigns.getCabalName(sealOwner) + "]<br>");
+						else
+							sb.append("[" + SevenSigns.getSealName(i, false) + ": Nothingness]<br>");
+					}
+					
+					sb.append("<a action=\"bypass -h npc_" + getObjectId() + "_Chat 0\">Go back.</a></body></html>");
 					
 					html = new NpcHtmlMessage(getObjectId());
-					html.setHtml(contentBuffer.toString());
+					html.setHtml(sb.toString());
 					player.sendPacket(html);
 					break;
@@ -810,6 +810,5 @@
 		}
 		
-		// Send a Server->Client NpcHtmlMessage containing the text of the L2Npc to the L2PcInstance
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2StaticObjectInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2StaticObjectInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2StaticObjectInstance.java	(revision 345)
@@ -92,5 +92,5 @@
 				if (getType() == 2)
 				{
-					NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+					final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 					html.setFile("data/html/signboard.htm");
 					player.sendPacket(html);
@@ -110,5 +110,5 @@
 		if (player.isGM())
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/admin/staticinfo.htm");
 			html.replace("%x%", getX());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DawnPriestInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DawnPriestInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DawnPriestInstance.java	(revision 345)
@@ -103,5 +103,5 @@
 		}
 		
-		NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+		final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 		html.setFile(filename);
 		html.replace("%objectId%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2NpcInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2NpcInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2NpcInstance.java	(revision 345)
@@ -37,5 +37,4 @@
 import net.sf.l2j.gameserver.skills.effects.EffectBuff;
 import net.sf.l2j.gameserver.skills.effects.EffectDebuff;
-import net.sf.l2j.util.StringUtil;
 
 public class L2NpcInstance extends L2Npc
@@ -82,7 +81,6 @@
 		if (((L2NpcInstance) npc).getClassesToTeach() == null)
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
-			final String sb = StringUtil.concat("<html><body>I cannot teach you. My class list is empty.<br>Your admin needs to add me teachTo informations.<br>NpcId:", String.valueOf(npc.getTemplate().getNpcId()), ", your classId:", String.valueOf(player.getClassId().getId()), "</body></html>");
-			html.setHtml(sb);
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+			html.setHtml("<html><body>I cannot teach you. My class list is empty.<br>Your admin needs to add me teachTo informations.<br>NpcId:" + npc.getTemplate().getNpcId() + ", your classId:" + player.getClassId().getId() + "</body></html>");
 			player.sendPacket(html);
 			return;
@@ -91,5 +89,5 @@
 		if (!npc.getTemplate().canTeach(classId))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 			html.setFile("data/html/trainer/" + npc.getTemplate().getNpcId() + "-noskills.htm");
 			player.sendPacket(html);
@@ -135,7 +133,6 @@
 		if (((L2NpcInstance) npc).getClassesToTeach() == null)
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
-			final String sb = StringUtil.concat("<html><body>I cannot teach you. My class list is empty.<br>Your admin needs to add me teachTo informations.<br>NpcId:", String.valueOf(npc.getTemplate().getNpcId()), ", your classId:", String.valueOf(player.getClassId().getId()), "</body></html>");
-			html.setHtml(sb);
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+			html.setHtml("<html><body>I cannot teach you. My class list is empty.<br>Your admin needs to add me teachTo informations.<br>NpcId:" + npc.getTemplate().getNpcId() + ", your classId:" + player.getClassId().getId() + "</body></html>");
 			player.sendPacket(html);
 			return;
@@ -144,5 +141,5 @@
 		if (!npc.getTemplate().canTeach(classId))
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 			html.setFile("data/html/trainer/" + npc.getTemplate().getNpcId() + "-noskills.htm");
 			player.sendPacket(html);
@@ -152,5 +149,5 @@
 		if (player.getClassId().level() < 3)
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc.getObjectId());
 			html.setHtml("<html><body> You must have 3rd class change quest completed.</body></html>");
 			player.sendPacket(html);
@@ -202,8 +199,8 @@
 		if (player.getLevel() > 39 || player.getClassId().level() >= 2)
 		{
-			NpcHtmlMessage npcReply = new NpcHtmlMessage(getObjectId());
-			npcReply.setHtml("<html><body>Newbie Guide:<br>I'm sorry, but you are not eligible to receive the protection blessing.<br1>It can only be bestowed on <font color=\"LEVEL\">characters below level 39 who have not made a seccond transfer.</font></body></html>");
-			npcReply.replace("%objectId%", getObjectId());
-			player.sendPacket(npcReply);
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			html.setHtml("<html><body>Newbie Guide:<br>I'm sorry, but you are not eligible to receive the protection blessing.<br1>It can only be bestowed on <font color=\"LEVEL\">characters below level 39 who have not made a seccond transfer.</font></body></html>");
+			html.replace("%objectId%", getObjectId());
+			player.sendPacket(html);
 			return;
 		}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DungeonGatekeeperInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DungeonGatekeeperInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/actor/instance/L2DungeonGatekeeperInstance.java	(revision 345)
@@ -40,5 +40,4 @@
 		String actualCommand = st.nextToken(); // Get actual command
 		
-		String filename = SevenSigns.SEVEN_SIGNS_HTML_PATH;
 		int sealAvariceOwner = SevenSigns.getInstance().getSealOwner(SevenSigns.SEAL_AVARICE);
 		int sealGnosisOwner = SevenSigns.getInstance().getSealOwner(SevenSigns.SEAL_GNOSIS);
@@ -75,7 +74,6 @@
 			if (!canPort)
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
-				filename += "necro_no.htm";
-				html.setFile(filename);
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				html.setFile(SevenSigns.SEVEN_SIGNS_HTML_PATH + "necro_no.htm");
 				player.sendPacket(html);
 			}
@@ -114,7 +112,6 @@
 			if (!canPort)
 			{
-				NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
-				filename += "cata_no.htm";
-				html.setFile(filename);
+				final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+				html.setFile(SevenSigns.SEVEN_SIGNS_HTML_PATH + "cata_no.htm");
 				player.sendPacket(html);
 			}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/item/instance/ItemInstance.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/item/instance/ItemInstance.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/item/instance/ItemInstance.java	(revision 345)
@@ -617,5 +617,5 @@
 		if (player.isGM())
 		{
-			NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(getObjectId());
 			html.setFile("data/html/admin/iteminfo.htm");
 			html.replace("%objid%", getObjectId());
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/item/kind/Weapon.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/item/kind/Weapon.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/item/kind/Weapon.java	(revision 345)
@@ -37,5 +37,4 @@
 import net.sf.l2j.gameserver.templates.skills.L2SkillType;
 import net.sf.l2j.util.Rnd;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -121,5 +120,5 @@
 				{
 					// Incorrect syntax, dont add new skill
-					_log.info(StringUtil.concat("> Couldnt parse ", skill, " in weapon enchant skills! item ", toString()));
+					_log.info("> Couldnt parse " + skill + " in weapon enchant skills! item " + toString());
 				}
 				if (id > 0 && level > 0)
@@ -148,5 +147,5 @@
 				{
 					// Incorrect syntax, dont add new skill
-					_log.info(StringUtil.concat("> Couldnt parse ", skill, " in weapon oncast skills! item ", toString()));
+					_log.info("> Couldnt parse " + skill + " in weapon oncast skills! item " + toString());
 				}
 				if (id > 0 && level > 0 && chance > 0)
@@ -179,5 +178,5 @@
 				{
 					// Incorrect syntax, dont add new skill
-					_log.info(StringUtil.concat("> Couldnt parse ", skill, " in weapon oncrit skills! item ", toString()));
+					_log.info("> Couldnt parse " + skill + " in weapon oncrit skills! item " + toString());
 				}
 				if (id > 0 && level > 0 && chance > 0)
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/quest/Quest.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/quest/Quest.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/model/quest/Quest.java	(revision 345)
@@ -735,25 +735,25 @@
 		if (result.endsWith(".htm") || result.endsWith(".html"))
 		{
-			NpcHtmlMessage npcReply = new NpcHtmlMessage(npc == null ? 0 : npc.getNpcId());
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc == null ? 0 : npc.getNpcId());
 			if (isRealQuest())
-				npcReply.setFile("./data/scripts/quests/" + getName() + "/" + result);
+				html.setFile("./data/scripts/quests/" + getName() + "/" + result);
 			else
-				npcReply.setFile("./data/scripts/" + getDescr() + "/" + getName() + "/" + result);
+				html.setFile("./data/scripts/" + getDescr() + "/" + getName() + "/" + result);
 			
 			if (npc != null)
-				npcReply.replace("%objectId%", npc.getObjectId());
+				html.replace("%objectId%", npc.getObjectId());
 			
-			player.sendPacket(npcReply);
+			player.sendPacket(html);
 			player.sendPacket(ActionFailed.STATIC_PACKET);
 		}
 		else if (result.startsWith("<html>"))
 		{
-			NpcHtmlMessage npcReply = new NpcHtmlMessage(npc == null ? 0 : npc.getNpcId());
-			npcReply.setHtml(result);
+			final NpcHtmlMessage html = new NpcHtmlMessage(npc == null ? 0 : npc.getNpcId());
+			html.setHtml(result);
 			
 			if (npc != null)
-				npcReply.replace("%objectId%", npc.getObjectId());
+				html.replace("%objectId%", npc.getObjectId());
 			
-			player.sendPacket(npcReply);
+			player.sendPacket(html);
 			player.sendPacket(ActionFailed.STATIC_PACKET);
 		}
@@ -779,7 +779,7 @@
 		if (player != null && player.isGM())
 		{
-			NpcHtmlMessage npcReply = new NpcHtmlMessage(0);
-			npcReply.setHtml("<html><body><title>Script error</title>" + e.getMessage() + "</body></html>");
-			player.sendPacket(npcReply);
+			final NpcHtmlMessage html = new NpcHtmlMessage(0);
+			html.setHtml("<html><body><title>Script error</title>" + e.getMessage() + "</body></html>");
+			player.sendPacket(html);
 			player.sendPacket(ActionFailed.STATIC_PACKET);
 			return true;
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/skills/Formulas.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/skills/Formulas.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/skills/Formulas.java	(revision 345)
@@ -46,5 +46,4 @@
 import net.sf.l2j.gameserver.util.Util;
 import net.sf.l2j.util.Rnd;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -1225,11 +1224,5 @@
 		
 		if (Config.DEVELOPER)
-		{
-			final StringBuilder stat = new StringBuilder(140);
-			StringUtil.append(stat, "calcEffectSuccess(): Name:", skill.getName(), " eff.type:", type.toString(), " power:", String.valueOf(baseChance), " statMod:", String.format("%1.2f", statModifier), " skillMod:", String.format("%1.2f", skillModifier), " mAtkMod:", String.format("%1.2f", mAtkModifier), " lvlMod:", String.format("%1.2f", lvlModifier), " total:", String.format("%1.2f", rate), "%");
-			
-			final String result = stat.toString();
-			_log.info(result);
-		}
+			_log.info("calcEffectSuccess(): Name:" + skill.getName() + " eff.type:" + type.toString() + " power:" + baseChance + " statMod:" + String.format("%1.2f", statModifier) + " skillMod:" + String.format("%1.2f", skillModifier) + " mAtkMod:" + String.format("%1.2f", mAtkModifier) + " lvlMod:" + String.format("%1.2f", lvlModifier) + " total:" + String.format("%1.2f", rate) + "%");
 		
 		return (Rnd.get(100) < rate);
@@ -1257,11 +1250,5 @@
 		
 		if (Config.DEVELOPER)
-		{
-			final StringBuilder stat = new StringBuilder(140);
-			StringUtil.append(stat, "calcSkillSuccess(): Name:", skill.getName(), " type:", skill.getSkillType().toString(), " power:", String.valueOf(baseChance), " statMod:", String.format("%1.2f", statModifier), " skillMod:", String.format("%1.2f", skillModifier), " mAtkMod:", String.format("%1.2f", mAtkModifier), " lvlMod:", String.format("%1.2f", lvlModifier), " total:", String.format("%1.2f", rate), "%");
-			
-			final String result = stat.toString();
-			_log.info(result);
-		}
+			_log.info("calcSkillSuccess(): Name:" + skill.getName() + " type:" + skill.getSkillType().toString() + " power:" + baseChance + " statMod:" + String.format("%1.2f", statModifier) + " skillMod:" + String.format("%1.2f", skillModifier) + " mAtkMod:" + String.format("%1.2f", mAtkModifier) + " lvlMod:" + String.format("%1.2f", lvlModifier) + " total:" + String.format("%1.2f", rate) + "%");
 		
 		return (Rnd.get(100) < rate);
@@ -1306,11 +1293,5 @@
 		
 		if (Config.DEVELOPER)
-		{
-			final StringBuilder stat = new StringBuilder(140);
-			StringUtil.append(stat, "calcCubicSkillSuccess(): Name:", skill.getName(), " type:", skill.getSkillType().toString(), " power:", String.valueOf(baseChance), " statMod:", String.format("%1.2f", statModifier), " skillMod:", String.format("%1.2f", skillModifier), " mAtkMod:", String.format("%1.2f", mAtkModifier), " lvlMod:", String.format("%1.2f", lvlModifier), " total:", String.format("%1.2f", rate), "%");
-			
-			final String result = stat.toString();
-			_log.info(result);
-		}
+			_log.info("calcCubicSkillSuccess(): Name:" + skill.getName() + " type:" + skill.getSkillType().toString() + " power:" + String.valueOf(baseChance) + " statMod:" + String.format("%1.2f", statModifier) + " skillMod:" + String.format("%1.2f", skillModifier) + " mAtkMod:" + String.format("%1.2f", mAtkModifier) + " lvlMod:" + String.format("%1.2f", lvlModifier) + " total:" + String.format("%1.2f", rate) + "%");
 		
 		return (Rnd.get(100) < rate);
@@ -1329,11 +1310,5 @@
 		
 		if (Config.DEVELOPER)
-		{
-			final StringBuilder stat = new StringBuilder(80);
-			StringUtil.append(stat, "calcMagicSuccess(): Name:", skill.getName(), " lvlDiff:", String.valueOf(lvlDifference), " fail:", String.format("%1.2f", rate / 100), "%");
-			
-			final String result = stat.toString();
-			_log.info(result);
-		}
+			_log.info("calcMagicSuccess(): Name:" + skill.getName() + " lvlDiff:" + lvlDifference + " fail:" + String.format("%1.2f", rate / 100) + "%");
 		
 		rate = Math.min(rate, 9900);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/cache/HtmCache.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/cache/HtmCache.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/cache/HtmCache.java	(revision 345)
@@ -90,5 +90,5 @@
 		try (FileInputStream fis = new FileInputStream(file); UnicodeReader ur = new UnicodeReader(fis, "UTF-8"); BufferedReader br = new BufferedReader(ur))
 		{
-			StringBuilder sb = new StringBuilder();
+			final StringBuilder sb = new StringBuilder();
 			String line;
 			
@@ -96,6 +96,5 @@
 				sb.append(line).append('\n');
 			
-			String content = sb.toString().replaceAll("\r\n", "\n");
-			sb = null;
+			final String content = sb.toString().replaceAll("\r\n", "\n");
 			
 			_htmCache.put(file.getPath().replace("\\", "/").hashCode(), content);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/PetDataTable.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/PetDataTable.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/PetDataTable.java	(revision 345)
@@ -185,61 +185,34 @@
 	}
 	
-	public static int[] getPetItemsAsNpc(int npcId)
+	private static String getPetItemsAsNpc(int npcId)
 	{
 		switch (npcId)
 		{
 			case 12077:// wolf pet a
-				return new int[]
-				{
-					2375
-				};
+				return "2375";
+				
 			case 12564:// Sin Eater
-				return new int[]
-				{
-					4425
-				};
+				return "4425";
 				
 			case 12311:// hatchling of wind
 			case 12312:// hatchling of star
 			case 12313:// hatchling of twilight
-				return new int[]
-				{
-					3500,
-					3501,
-					3502
-				};
+				return "3500, 3501, 3502";
 				
 			case 12526:// wind strider
 			case 12527:// Star strider
 			case 12528:// Twilight strider
-				return new int[]
-				{
-					4422,
-					4423,
-					4424
-				};
+				return "4422, 4423, 4424";
 				
 			case 12621:// Wyvern
-				return new int[]
-				{
-					8663
-				};
+				return "8663";
 				
 			case 12780:// Baby Buffalo
 			case 12782:// Baby Cougar
 			case 12781:// Baby Kookaburra
-				return new int[]
-				{
-					6648,
-					6649,
-					6650
-				};
-				
-				// unknown item id.. should never happen
-			default:
-				return new int[]
-				{
-					0
-				};
+				return "6648, 6649, 6650";
+				
+			default:// unknown item id.. should never happen
+				return "0";
 		}
 	}
@@ -260,13 +233,6 @@
 			PreparedStatement statement = con.prepareStatement("SELECT name FROM pets p, items i WHERE p.item_obj_id = i.object_id AND name=? AND i.item_id IN (?)");
 			statement.setString(1, name);
+			statement.setString(2, getPetItemsAsNpc(petNpcId));
 			
-			String cond = "";
-			for (int it : PetDataTable.getPetItemsAsNpc(petNpcId))
-			{
-				if (!cond.isEmpty())
-					cond += ", ";
-				cond += it;
-			}
-			statement.setString(2, cond);
 			ResultSet rset = statement.executeQuery();
 			result = rset.next();
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/AnnouncementTable.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/AnnouncementTable.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/AnnouncementTable.java	(revision 345)
@@ -21,4 +21,5 @@
 import java.util.logging.Logger;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.cache.HtmCache;
 import net.sf.l2j.gameserver.model.Announcement;
@@ -158,12 +159,7 @@
 	public void listAnnouncements(L2PcInstance activeChar)
 	{
-		String content = HtmCache.getInstance().getHtmForce("data/html/admin/announce_list.htm");
-		
-		NpcHtmlMessage adminReply = new NpcHtmlMessage(5);
-		adminReply.setHtml(content);
-		
-		StringBuilder replyMSG = new StringBuilder("<br>");
+		final StringBuilder sb = new StringBuilder("<br>");
 		if (_announcements.isEmpty())
-			replyMSG.append("<tr><td>The XML file doesn't contain any content.</td></tr>");
+			sb.append("<tr><td>The XML file doesn't contain any content.</td></tr>");
 		else
 		{
@@ -173,10 +169,12 @@
 				final Announcement announce = entry.getValue();
 				
-				replyMSG.append("<tr><td width=240>#" + index + " - " + announce.getMessage() + "</td><td></td></tr>");
-				replyMSG.append("<tr><td>Critical: " + announce.isCritical() + " | Auto: " + announce.isAuto() + "</td><td><button value=\"Delete\" action=\"bypass -h admin_announce del " + index + "\" width=65 height=19 back=\"L2UI_ch3.smallbutton2_over\" fore=\"L2UI_ch3.smallbutton2\"></td></tr>");
+				StringUtil.append(sb, "<tr><td width=240>#", index, " - ", announce.getMessage(), "</td><td></td></tr><tr><td>Critical: ", announce.isCritical(), " | Auto: ", announce.isAuto(), "</td><td><button value=\"Delete\" action=\"bypass -h admin_announce del ", index, "\" width=65 height=19 back=\"L2UI_ch3.smallbutton2_over\" fore=\"L2UI_ch3.smallbutton2\"></td></tr>");
 			}
 		}
-		adminReply.replace("%announces%", replyMSG.toString());
-		activeChar.sendPacket(adminReply);
+		
+		final NpcHtmlMessage html = new NpcHtmlMessage(0);
+		html.setHtml(HtmCache.getInstance().getHtmForce("data/html/admin/announce_list.htm"));
+		html.replace("%announces%", sb.toString());
+		activeChar.sendPacket(html);
 	}
 	
@@ -226,19 +224,11 @@
 	private void regenerateXML()
 	{
-		StringBuilder sb = new StringBuilder();
-		
-		sb.append(HEADER);
+		final StringBuilder sb = new StringBuilder(HEADER);
+		
 		sb.append("<list> \n");
+		
 		for (Announcement announce : _announcements.values())
-		{
-			sb.append("<announcement ");
-			sb.append("message=\"" + announce.getMessage() + "\" ");
-			sb.append("critical=\"" + announce.isCritical() + "\" ");
-			sb.append("auto=\"" + announce.isAuto() + "\" ");
-			sb.append("initial_delay=\"" + announce.getInitialDelay() + "\" ");
-			sb.append("delay=\"" + announce.getDelay() + "\" ");
-			sb.append("limit=\"" + announce.getLimit() + "\" ");
-			sb.append("/> \n");
-		}
+			StringUtil.append(sb, "<announcement message=\"", announce.getMessage(), "\" critical=\"", announce.isCritical(), "\" auto=\"", announce.isAuto(), "\" initial_delay=\"", announce.getInitialDelay(), "\" delay=\"", announce.getDelay(), "\" limit=\"", announce.getLimit(), "\" /> \n");
+		
 		sb.append("</list>");
 		
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/BufferTable.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/BufferTable.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/BufferTable.java	(revision 345)
@@ -32,4 +32,5 @@
 import net.sf.l2j.Config;
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.holder.BuffSkillHolder;
 
@@ -108,18 +109,15 @@
 				{
 					// Build a String composed of skill ids seperated by a ",".
-					StringBuilder skills = new StringBuilder();
+					final StringBuilder sb = new StringBuilder();
 					for (int skillId : scheme.getValue())
-					{
-						skills.append(skillId);
-						skills.append(",");
-					}
+						StringUtil.append(sb, skillId, ",");
 					
 					// Delete the last "," : must be called only if there is something to delete !
-					if (skills.length() > 0)
-						skills.setLength(skills.length() - 1);
+					if (sb.length() > 0)
+						sb.setLength(sb.length() - 1);
 					
 					st.setInt(1, player.getKey());
 					st.setString(2, scheme.getKey());
-					st.setString(3, skills.toString());
+					st.setString(3, sb.toString());
 					st.executeUpdate();
 					st.clearParameters();
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/ClanTable.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/ClanTable.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/datatables/ClanTable.java	(revision 345)
@@ -27,4 +27,5 @@
 import net.sf.l2j.Config;
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.ThreadPoolManager;
 import net.sf.l2j.gameserver.idfactory.IdFactory;
@@ -39,5 +40,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
 import net.sf.l2j.gameserver.network.serverpackets.UserInfo;
-import net.sf.l2j.gameserver.util.Util;
 
 public class ClanTable
@@ -174,5 +174,5 @@
 		}
 		
-		if (!Util.isAlphaNumeric(clanName))
+		if (!StringUtil.isAlphaNumeric(clanName))
 		{
 			player.sendPacket(SystemMessageId.CLAN_NAME_INVALID);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/ClanBBSManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/ClanBBSManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/ClanBBSManager.java	(revision 345)
@@ -17,4 +17,5 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.cache.HtmCache;
 import net.sf.l2j.gameserver.datatables.ClanTable;
@@ -23,10 +24,7 @@
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
 import net.sf.l2j.gameserver.network.SystemMessageId;
-import net.sf.l2j.util.StringUtil;
 
 public class ClanBBSManager extends BaseBBSManager
 {
-	private static final String HOME_BAR = "<table width=610 bgcolor=A7A19A><tr><td width=5></td><td width=605><a action=\"bypass _bbsclan;home;%clanid%\">[GO TO MY CLAN]</a></td></tr></table>";
-	
 	protected ClanBBSManager()
 	{
@@ -196,20 +194,19 @@
 		
 		// Player got a clan, show the associated header.
-		String homeBar = "";
+		final StringBuilder sb = new StringBuilder();
 		
 		final L2Clan playerClan = activeChar.getClan();
 		if (playerClan != null)
-		{
-			homeBar = HOME_BAR;
-			homeBar = homeBar.replace("%clanid%", Integer.toString(playerClan.getClanId()));
-		}
-		content = content.replace("%homebar%", homeBar);
+			StringUtil.append(sb, "<table width=610 bgcolor=A7A19A><tr><td width=5></td><td width=605><a action=\"bypass _bbsclan;home;", playerClan.getClanId(), "\">[GO TO MY CLAN]</a></td></tr></table>");
+		
+		content = content.replace("%homebar%", sb.toString());
 		
 		if (index < 1)
 			index = 1;
 		
+		// Cleanup sb.
+		sb.setLength(0);
+		
 		// List of clans.
-		final StringBuilder html = new StringBuilder();
-		
 		int i = 0;
 		for (L2Clan cl : ClanTable.getInstance().getClans())
@@ -219,12 +216,12 @@
 			
 			if (i++ >= (index - 1) * 7)
-				StringUtil.append(html, "<table width=610><tr><td width=5></td><td width=150 align=center><a action=\"bypass _bbsclan;home;", Integer.toString(cl.getClanId()), "\">", cl.getName(), "</a></td><td width=150 align=center>", cl.getLeaderName(), "</td><td width=100 align=center>", Integer.toString(cl.getLevel()), "</td><td width=200 align=center>", Integer.toString(cl.getMembersCount()), "</td><td width=5></td></tr></table><br1><img src=\"L2UI.Squaregray\" width=605 height=1><br1>");
-		}
-		html.append("<table><tr>");
+				StringUtil.append(sb, "<table width=610><tr><td width=5></td><td width=150 align=center><a action=\"bypass _bbsclan;home;", cl.getClanId(), "\">", cl.getName(), "</a></td><td width=150 align=center>", cl.getLeaderName(), "</td><td width=100 align=center>", cl.getLevel(), "</td><td width=200 align=center>", cl.getMembersCount(), "</td><td width=5></td></tr></table><br1><img src=\"L2UI.Squaregray\" width=605 height=1><br1>");
+		}
+		sb.append("<table><tr>");
 		
 		if (index == 1)
-			html.append("<td><button action=\"\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16></td>");
-		else
-			StringUtil.append(html, "<td><button action=\"_bbsclan;clan;", Integer.toString(index - 1), "\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16 ></td>");
+			sb.append("<td><button action=\"\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16></td>");
+		else
+			StringUtil.append(sb, "<td><button action=\"_bbsclan;clan;", index - 1, "\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16 ></td>");
 		
 		i = 0;
@@ -236,17 +233,17 @@
 		{
 			if (i == index)
-				StringUtil.append(html, "<td> ", Integer.toString(i), " </td>");
+				StringUtil.append(sb, "<td> ", i, " </td>");
 			else
-				StringUtil.append(html, "<td><a action=\"bypass _bbsclan;clan;", Integer.toString(i), "\"> ", Integer.toString(i), " </a></td>");
+				StringUtil.append(sb, "<td><a action=\"bypass _bbsclan;clan;", i, "\"> ", i, " </a></td>");
 		}
 		
 		if (index == nbp)
-			html.append("<td><button action=\"\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16></td>");
-		else
-			StringUtil.append(html, "<td><button action=\"bypass _bbsclan;clan;", Integer.toString(index + 1), "\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16 ></td>");
-		
-		html.append("</tr></table>");
-		
-		content = content.replace("%clanlist%", html.toString());
+			sb.append("<td><button action=\"\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16></td>");
+		else
+			StringUtil.append(sb, "<td><button action=\"bypass _bbsclan;clan;", index + 1, "\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16 ></td>");
+		
+		sb.append("</tr></table>");
+		
+		content = content.replace("%clanlist%", sb.toString());
 		separateAndSend(content, activeChar);
 	}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/TopicBBSManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/TopicBBSManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/TopicBBSManager.java	(revision 345)
@@ -24,4 +24,5 @@
 import java.util.concurrent.ConcurrentHashMap;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.communitybbs.BB.Forum;
 import net.sf.l2j.gameserver.communitybbs.BB.Post;
@@ -29,5 +30,4 @@
 import net.sf.l2j.gameserver.datatables.ClanTable;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
-import net.sf.l2j.util.StringUtil;
 
 public class TopicBBSManager extends BaseBBSManager
@@ -217,5 +217,5 @@
 	private static void showMemoNewTopics(Forum forum, L2PcInstance activeChar)
 	{
-		final String html = StringUtil.concat("<html>" + "<body><br><br>" + "<table border=0 width=610><tr><td width=10></td><td width=600 align=left>" + "<a action=\"bypass _bbshome\">HOME</a>&nbsp;>&nbsp;<a action=\"bypass _bbsmemo\">Memo Form</a>" + "</td></tr>" + "</table>" + "<img src=\"L2UI.squareblank\" width=\"1\" height=\"10\">" + "<center>" + "<table border=0 cellspacing=0 cellpadding=0>" + "<tr><td width=610><img src=\"sek.cbui355\" width=\"610\" height=\"1\"><br1><img src=\"sek.cbui355\" width=\"610\" height=\"1\"></td></tr>" + "</table>" + "<table fixwidth=610 border=0 cellspacing=0 cellpadding=0>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=20></td></tr>" + "<tr>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "<td align=center FIXWIDTH=60 height=29>&$413;</td>" + "<td FIXWIDTH=540><edit var = \"Title\" width=540 height=13></td>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "</tr></table>" + "<table fixwidth=610 border=0 cellspacing=0 cellpadding=0>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr>" + "<tr>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "<td align=center FIXWIDTH=60 height=29 valign=top>&$427;</td>" + "<td align=center FIXWIDTH=540><MultiEdit var =\"Content\" width=535 height=313></td>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "</tr>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr>" + "</table>" + "<table fixwidth=610 border=0 cellspacing=0 cellpadding=0>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr>" + "<tr>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "<td align=center FIXWIDTH=60 height=29>&nbsp;</td>" + "<td align=center FIXWIDTH=70><button value=\"&$140;\" action=\"Write Topic crea ", String.valueOf(forum.getID()), " Title Content Title\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td>" + "<td align=center FIXWIDTH=70><button value = \"&$141;\" action=\"bypass _bbsmemo\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\"> </td>" + "<td align=center FIXWIDTH=400>&nbsp;</td>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "</tr></table>" + "</center>" + "</body>" + "</html>");
+		final String html = "<html><body><br><br><table border=0 width=610><tr><td width=10></td><td width=600 align=left><a action=\"bypass _bbshome\">HOME</a>&nbsp;>&nbsp;<a action=\"bypass _bbsmemo\">Memo Form</a></td></tr></table><img src=\"L2UI.squareblank\" width=\"1\" height=\"10\"><center><table border=0 cellspacing=0 cellpadding=0><tr><td width=610><img src=\"sek.cbui355\" width=\"610\" height=\"1\"><br1><img src=\"sek.cbui355\" width=\"610\" height=\"1\"></td></tr></table><table fixwidth=610 border=0 cellspacing=0 cellpadding=0><tr><td><img src=\"l2ui.mini_logo\" width=5 height=20></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=1></td><td align=center FIXWIDTH=60 height=29>&$413;</td><td FIXWIDTH=540><edit var = \"Title\" width=540 height=13></td><td><img src=\"l2ui.mini_logo\" width=5 height=1></td></tr></table><table fixwidth=610 border=0 cellspacing=0 cellpadding=0><tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=1></td><td align=center FIXWIDTH=60 height=29 valign=top>&$427;</td><td align=center FIXWIDTH=540><MultiEdit var =\"Content\" width=535 height=313></td><td><img src=\"l2ui.mini_logo\" width=5 height=1></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr></table><table fixwidth=610 border=0 cellspacing=0 cellpadding=0><tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=1></td><td align=center FIXWIDTH=60 height=29>&nbsp;</td><td align=center FIXWIDTH=70><button value=\"&$140;\" action=\"Write Topic crea " + forum.getID() + " Title Content Title\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td><td align=center FIXWIDTH=70><button value = \"&$141;\" action=\"bypass _bbsmemo\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\"> </td><td align=center FIXWIDTH=400>&nbsp;</td><td><img src=\"l2ui.mini_logo\" width=5 height=1></td></tr></table></center></body></html>";
 		send1001(html, activeChar);
 		send1002(activeChar);
@@ -239,5 +239,5 @@
 	{
 		forum.vload();
-		final StringBuilder html = StringUtil.startAppend(2000, "<html><body><br><br>" + "<table border=0 width=610><tr><td width=10></td><td width=600 align=left>" + "<a action=\"bypass _bbshome\">HOME</a>&nbsp;>&nbsp;<a action=\"bypass _bbsmemo\">Memo Form</a>" + "</td></tr>" + "</table>" + "<img src=\"L2UI.squareblank\" width=\"1\" height=\"10\">" + "<center>" + "<table border=0 cellspacing=0 cellpadding=2 bgcolor=888888 width=610>" + "<tr>" + "<td FIXWIDTH=5></td>" + "<td FIXWIDTH=415 align=center>&$413;</td>" + "<td FIXWIDTH=120 align=center></td>" + "<td FIXWIDTH=70 align=center>&$418;</td>" + "</tr>" + "</table>");
+		final StringBuilder sb = new StringBuilder("<html><body><br><br><table border=0 width=610><tr><td width=10></td><td width=600 align=left><a action=\"bypass _bbshome\">HOME</a>&nbsp;>&nbsp;<a action=\"bypass _bbsmemo\">Memo Form</a></td></tr></table><img src=\"L2UI.squareblank\" width=\"1\" height=\"10\"><center><table border=0 cellspacing=0 cellpadding=2 bgcolor=888888 width=610><tr><td FIXWIDTH=5></td><td FIXWIDTH=415 align=center>&$413;</td><td FIXWIDTH=120 align=center></td><td FIXWIDTH=70 align=center>&$418;</td></tr></table>");
 		
 		final DateFormat dateFormat = DateFormat.getInstance();
@@ -251,16 +251,14 @@
 			{
 				if (i++ >= 12 * (index - 1))
-				{
-					StringUtil.append(html, "<table border=0 cellspacing=0 cellpadding=5 WIDTH=610>" + "<tr>" + "<td FIXWIDTH=5></td>" + "<td FIXWIDTH=415><a action=\"bypass _bbsposts;read;", String.valueOf(forum.getID()), ";", String.valueOf(t.getID()), "\">", t.getName(), "</a></td>" + "<td FIXWIDTH=120 align=center></td>" + "<td FIXWIDTH=70 align=center>", dateFormat.format(new Date(t.getDate())), "</td>" + "</tr>" + "</table>" + "<img src=\"L2UI.Squaregray\" width=\"610\" height=\"1\">");
-				}
-			}
-		}
-		
-		html.append("<br>" + "<table width=610 cellspace=0 cellpadding=0>" + "<tr>" + "<td width=50>" + "<button value=\"&$422;\" action=\"bypass _bbsmemo\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\">" + "</td>" + "<td width=510 align=center>" + "<table border=0><tr>");
+					StringUtil.append(sb, "<table border=0 cellspacing=0 cellpadding=5 WIDTH=610><tr><td FIXWIDTH=5></td><td FIXWIDTH=415><a action=\"bypass _bbsposts;read;", forum.getID(), ";", t.getID(), "\">", t.getName(), "</a></td><td FIXWIDTH=120 align=center></td><td FIXWIDTH=70 align=center>", dateFormat.format(new Date(t.getDate())), "</td></tr></table><img src=\"L2UI.Squaregray\" width=\"610\" height=\"1\">");
+			}
+		}
+		
+		sb.append("<br><table width=610 cellspace=0 cellpadding=0><tr><td width=50><button value=\"&$422;\" action=\"bypass _bbsmemo\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\"></td><td width=510 align=center><table border=0><tr>");
 		
 		if (index == 1)
-			html.append("<td><button action=\"\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16 ></td>");
-		else
-			StringUtil.append(html, "<td><button action=\"bypass _bbstopics;read;", String.valueOf(forum.getID()), ";", String.valueOf(index - 1), "\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16 ></td>");
+			sb.append("<td><button action=\"\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16 ></td>");
+		else
+			StringUtil.append(sb, "<td><button action=\"bypass _bbstopics;read;", forum.getID(), ";", index - 1, "\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16 ></td>");
 		
 		int nbp;
@@ -272,16 +270,16 @@
 		{
 			if (i == index)
-				StringUtil.append(html, "<td> ", String.valueOf(i), " </td>");
+				StringUtil.append(sb, "<td> ", i, " </td>");
 			else
-				StringUtil.append(html, "<td><a action=\"bypass _bbstopics;read;", String.valueOf(forum.getID()), ";", String.valueOf(i), "\"> ", String.valueOf(i), " </a></td>");
+				StringUtil.append(sb, "<td><a action=\"bypass _bbstopics;read;", forum.getID(), ";", i, "\"> ", i, " </a></td>");
 		}
 		
 		if (index == nbp)
-			html.append("<td><button action=\"\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16 ></td>");
-		else
-			StringUtil.append(html, "<td><button action=\"bypass _bbstopics;read;", String.valueOf(forum.getID()), ";", String.valueOf(index + 1), "\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16 ></td>");
-		
-		StringUtil.append(html, "</tr></table> </td> " + "<td align=right><button value = \"&$421;\" action=\"bypass _bbstopics;crea;", String.valueOf(forum.getID()), "\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td></tr>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr>" + "<tr> " + "<td></td>" + "<td align=center><table border=0><tr><td></td><td><edit var = \"Search\" width=130 height=11></td>" + "<td><button value=\"&$420;\" action=\"Write 5 -2 0 Search _ _\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\"> </td> </tr></table> </td>" + "</tr>" + "</table>" + "<br>" + "<br>" + "<br>" + "</center>" + "</body>" + "</html>");
-		separateAndSend(html.toString(), activeChar);
+			sb.append("<td><button action=\"\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16 ></td>");
+		else
+			StringUtil.append(sb, "<td><button action=\"bypass _bbstopics;read;", forum.getID(), ";", index + 1, "\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16 ></td>");
+		
+		StringUtil.append(sb, "</tr></table></td><td align=right><button value = \"&$421;\" action=\"bypass _bbstopics;crea;", forum.getID(), "\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr><tr><td></td><td align=center><table border=0><tr><td></td><td><edit var = \"Search\" width=130 height=11></td><td><button value=\"&$420;\" action=\"Write 5 -2 0 Search _ _\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\"></td></tr></table></td></tr></table><br><br><br></center></body></html>");
+		separateAndSend(sb.toString(), activeChar);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/MailBBSManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/MailBBSManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/MailBBSManager.java	(revision 345)
@@ -29,4 +29,5 @@
 
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.cache.HtmCache;
 import net.sf.l2j.gameserver.datatables.CharNameTable;
@@ -38,5 +39,4 @@
 import net.sf.l2j.gameserver.network.serverpackets.PlaySound;
 import net.sf.l2j.gameserver.network.serverpackets.SystemMessage;
-import net.sf.l2j.gameserver.util.Util;
 
 /**
@@ -45,4 +45,33 @@
 public class MailBBSManager extends BaseBBSManager
 {
+	private static enum MailType
+	{
+		INBOX("Inbox", "<a action=\"bypass _bbsmail\">Inbox</a>"),
+		SENTBOX("Sent Box", "<a action=\"bypass _bbsmail;sentbox\">Sent Box</a>"),
+		ARCHIVE("Mail Archive", "<a action=\"bypass _bbsmail;archive\">Mail Archive</a>"),
+		TEMPARCHIVE("Temporary Mail Archive", "<a action=\"bypass _bbsmail;temp_archive\">Temporary Mail Archive</a>");
+		
+		private final String _description;
+		private final String _bypass;
+		
+		private MailType(String description, String bypass)
+		{
+			_description = description;
+			_bypass = bypass;
+		}
+		
+		public String getDescription()
+		{
+			return _description;
+		}
+		
+		public String getBypass()
+		{
+			return _bypass;
+		}
+		
+		public static final MailType VALUES[] = values();
+	}
+	
 	private final Map<Integer, List<Mail>> _mails = new HashMap<>();
 	
@@ -61,5 +90,5 @@
 		int letterId;
 		int senderId;
-		String location;
+		MailType location;
 		String recipientNames;
 		String subject;
@@ -84,5 +113,5 @@
 	{
 		if (command.equals("_bbsmail") || command.equals("_maillist_0_1_0_"))
-			showMailList(activeChar, 1, "inbox");
+			showMailList(activeChar, 1, MailType.INBOX);
 		else if (command.startsWith("_bbsmail"))
 		{
@@ -97,5 +126,5 @@
 				final String search = (st.hasMoreTokens()) ? st.nextToken() : "";
 				
-				showMailList(activeChar, page, action, sType, search);
+				showMailList(activeChar, page, Enum.valueOf(MailType.class, action.toUpperCase()), sType, search);
 			}
 			else if (action.equals("crea"))
@@ -141,7 +170,7 @@
 				Mail letter = getLetter(activeChar, letterId);
 				if (letter != null)
-					setLetterLocation(activeChar, letter.letterId, "archive");
-				
-				showMailList(activeChar, 1, "archive");
+					setLetterLocation(activeChar, letter.letterId, MailType.ARCHIVE);
+				
+				showMailList(activeChar, 1, MailType.ARCHIVE);
 			}
 		}
@@ -156,5 +185,5 @@
 		{
 			sendLetter(ar3, ar4, ar5, activeChar);
-			showMailList(activeChar, 1, "sentbox");
+			showMailList(activeChar, 1, MailType.SENTBOX);
 		}
 		else if (ar1.startsWith("Search"))
@@ -163,5 +192,5 @@
 			st.nextToken();
 			
-			showMailList(activeChar, 1, st.nextToken(), ar4, ar5);
+			showMailList(activeChar, 1, Enum.valueOf(MailType.class, st.nextToken().toUpperCase()), ar4, ar5);
 		}
 		else
@@ -212,10 +241,10 @@
 					letter.letterId = result.getInt("letterId");
 					letter.senderId = result.getInt("senderId");
-					letter.location = result.getString("location").toLowerCase();
+					letter.location = Enum.valueOf(MailType.class, result.getString("location").toUpperCase());
 					letter.recipientNames = result.getString("recipientNames");
 					letter.subject = result.getString("subject");
 					letter.message = result.getString("message");
 					letter.sentDate = result.getTimestamp("sentDate");
-					letter.sentDateString = Util.formatDate(letter.sentDate, "yyyy-MM-dd HH:mm");
+					letter.sentDateString = StringUtil.REVERSED_DATE_MM.format(letter.sentDate);
 					letter.unread = result.getInt("unread") != 0;
 					_letters.add(0, letter);
@@ -259,10 +288,10 @@
 	}
 	
-	private void showMailList(L2PcInstance activeChar, int page, String type)
+	private void showMailList(L2PcInstance activeChar, int page, MailType type)
 	{
 		showMailList(activeChar, page, type, "", "");
 	}
 	
-	private void showMailList(L2PcInstance activeChar, int page, String type, String sType, String search)
+	private void showMailList(L2PcInstance activeChar, int page, MailType type, String sType, String search)
 	{
 		List<Mail> letters;
@@ -302,22 +331,12 @@
 		
 		String content = HtmCache.getInstance().getHtm(CB_PATH + "mail/mail.htm");
-		content = content.replace("%inbox%", getCountLetters(activeChar.getObjectId(), "inbox", "", "") + "");
-		content = content.replace("%sentbox%", getCountLetters(activeChar.getObjectId(), "sentbox", "", "") + "");
-		content = content.replace("%archive%", getCountLetters(activeChar.getObjectId(), "archive", "", "") + "");
-		content = content.replace("%temparchive%", getCountLetters(activeChar.getObjectId(), "temparchive", "", "") + "");
-		
-		String htmlType = "";
-		if (type.equalsIgnoreCase("inbox"))
-			htmlType = "Inbox";
-		else if (type.equalsIgnoreCase("sentbox"))
-			htmlType = "Sent Box";
-		else if (type.equalsIgnoreCase("archive"))
-			htmlType = "Mail Archive";
-		else if (type.equalsIgnoreCase("temparchive"))
-			htmlType = "Temporary Mail Archive";
-		content = content.replace("%type%", htmlType);
-		
-		content = content.replace("%htype%", type);
-		String mailList = "";
+		content = content.replace("%inbox%", Integer.toString(getCountLetters(activeChar.getObjectId(), MailType.INBOX, "", "")));
+		content = content.replace("%sentbox%", Integer.toString(getCountLetters(activeChar.getObjectId(), MailType.SENTBOX, "", "")));
+		content = content.replace("%archive%", Integer.toString(getCountLetters(activeChar.getObjectId(), MailType.ARCHIVE, "", "")));
+		content = content.replace("%temparchive%", Integer.toString(getCountLetters(activeChar.getObjectId(), MailType.TEMPARCHIVE, "", "")));
+		content = content.replace("%type%", type.getDescription());
+		content = content.replace("%htype%", type.toString().toLowerCase());
+		
+		final StringBuilder sb = new StringBuilder();
 		for (Mail letter : letters)
 		{
@@ -333,27 +352,27 @@
 					break;
 				
-				String tempName = getCharName(letter.senderId);
-				mailList += "<table width=610><tr>";
-				mailList += "<td width=5></td>";
-				mailList += "<td width=150>" + tempName + "</td>";
-				mailList += "<td width=300><a action=\"bypass _bbsmail;view;" + letter.letterId + "\">";
+				StringUtil.append(sb, "<table width=610><tr><td width=5></td><td width=150>", getCharName(letter.senderId), "</td><td width=300><a action=\"bypass _bbsmail;view;", letter.letterId, "\">");
+				
 				if (letter.unread)
-					mailList += "<font color=\"LEVEL\">";
-				mailList += abbreviate(letter.subject, 51);
+					sb.append("<font color=\"LEVEL\">");
+				
+				sb.append(abbreviate(letter.subject, 51));
+				
 				if (letter.unread)
-					mailList += "</font>";
-				mailList += "</a>";
-				mailList += "</td><td width=150>" + letter.sentDateString + "</td>";
-				mailList += "<td width=5></td></tr></table>";
-				mailList += "<img src=\"L2UI.Squaregray\" width=610 height=1>";
+					sb.append("</font>");
+				
+				StringUtil.append(sb, "</a></td><td width=150>", letter.sentDateString, "</td><td width=5></td></tr></table><img src=\"L2UI.Squaregray\" width=610 height=1>");
 				index++;
 			}
 		}
-		content = content.replace("%maillist%", mailList);
-		String fullSearch = (!sType.equals("") && !search.equals("")) ? ";" + sType + ";" + search : "";
-		String mailListLength = "";
-		mailListLength += "<td><table><tr><td></td></tr><tr><td>";
-		mailListLength += "<button action=\"bypass _bbsmail;" + type + ";" + (page == 1 ? page : page - 1) + fullSearch + "\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16>";
-		mailListLength += "</td></tr></table></td>";
+		content = content.replace("%maillist%", sb.toString());
+		
+		// CLeanup sb.
+		sb.setLength(0);
+		
+		final String fullSearch = (!sType.equals("") && !search.equals("")) ? ";" + sType + ";" + search : "";
+		
+		StringUtil.append(sb, "<td><table><tr><td></td></tr><tr><td><button action=\"bypass _bbsmail;", type, ";", (page == 1 ? page : page - 1), fullSearch, "\" back=\"l2ui_ch3.prev1_down\" fore=\"l2ui_ch3.prev1\" width=16 height=16></td></tr></table></td>");
+		
 		int i = 0;
 		if (maxpage > 21)
@@ -364,7 +383,7 @@
 				{
 					if (i == page)
-						mailListLength += "<td> " + i + " </td>";
+						StringUtil.append(sb, "<td> ", i, " </td>");
 					else
-						mailListLength += "<td><a action=\"bypass _bbsmail;" + type + ";" + i + fullSearch + "\"> " + i + " </a></td>";
+						StringUtil.append(sb, "<td><a action=\"bypass _bbsmail;", type, ";", i, fullSearch, "\"> ", i, " </a></td>");
 				}
 			}
@@ -376,12 +395,12 @@
 						continue;
 					
-					mailListLength += "<td><a action=\"bypass _bbsmail;" + type + ";" + i + fullSearch + "\"> " + i + " </a></td>";
+					StringUtil.append(sb, "<td><a action=\"bypass _bbsmail;", type, ";", i, fullSearch, "\"> ", i, " </a></td>");
 				}
 				for (i = page; i <= (page + 10); i++)
 				{
 					if (i == page)
-						mailListLength += "<td> " + i + " </td>";
+						StringUtil.append(sb, "<td> ", i, " </td>");
 					else
-						mailListLength += "<td><a action=\"bypass _bbsmail;" + type + ";" + i + fullSearch + "\"> " + i + " </a></td>";
+						StringUtil.append(sb, "<td><a action=\"bypass _bbsmail;", type, ";", i, fullSearch, "\"> ", i, " </a></td>");
 				}
 			}
@@ -391,7 +410,7 @@
 				{
 					if (i == page)
-						mailListLength += "<td> " + i + " </td>";
+						StringUtil.append(sb, "<td> ", i, " </td>");
 					else
-						mailListLength += "<td><a action=\"bypass _bbsmail;" + type + ";" + i + fullSearch + "\"> " + i + " </a></td>";
+						StringUtil.append(sb, "<td><a action=\"bypass _bbsmail;", type, ";", i, fullSearch, "\"> ", i, " </a></td>");
 				}
 			}
@@ -402,13 +421,12 @@
 			{
 				if (i == page)
-					mailListLength += "<td> " + i + " </td>";
+					StringUtil.append(sb, "<td> ", i, " </td>");
 				else
-					mailListLength += "<td><a action=\"bypass _bbsmail;" + type + ";" + i + fullSearch + "\"> " + i + " </a></td>";
-			}
-		}
-		mailListLength += "<td><table><tr><td></td></tr><tr><td>";
-		mailListLength += "<button action=\"bypass _bbsmail;" + type + ";" + (page == maxpage ? page : page + 1) + fullSearch + "\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16 >";
-		mailListLength += "</td></tr></table></td>";
-		content = content.replace("%maillistlength%", mailListLength);
+					StringUtil.append(sb, "<td><a action=\"bypass _bbsmail;", type, ";", i, fullSearch, "\"> ", i, " </a></td>");
+			}
+		}
+		StringUtil.append(sb, "<td><table><tr><td></td></tr><tr><td><button action=\"bypass _bbsmail;", type, ";", (page == maxpage ? page : page + 1), fullSearch, "\" back=\"l2ui_ch3.next1_down\" fore=\"l2ui_ch3.next1\" width=16 height=16 ></td></tr></table></td>");
+		
+		content = content.replace("%maillistlength%", sb.toString());
 		
 		separateAndSend(content, activeChar);
@@ -419,5 +437,5 @@
 		if (letter == null)
 		{
-			showMailList(activeChar, 1, "inbox");
+			showMailList(activeChar, 1, MailType.INBOX);
 			return;
 		}
@@ -425,12 +443,5 @@
 		String content = HtmCache.getInstance().getHtm(CB_PATH + "mail/mail-show.htm");
 		
-		String link = "<a action=\"bypass _bbsmail\">Inbox</a>";
-		if (letter.location.equalsIgnoreCase("sentbox"))
-			link = "<a action=\"bypass _bbsmail;sentbox\">Sent Box</a>";
-		else if (letter.location.equalsIgnoreCase("archive"))
-			link = "<a action=\"bypass _bbsmail;archive\">Mail Archive</a>";
-		else if (letter.location.equalsIgnoreCase("temparchive"))
-			link = "<a action=\"bypass _bbsmail;temp_archive\">Temporary Mail Archive</a>";
-		link += "&nbsp;&gt;&nbsp;" + letter.subject;
+		String link = letter.location.getBypass() + "&nbsp;&gt;&nbsp;" + letter.subject;
 		content = content.replace("%maillink%", link);
 		
@@ -455,12 +466,5 @@
 		String content = HtmCache.getInstance().getHtm(CB_PATH + "mail/mail-reply.htm");
 		
-		String link = "<a action=\"bypass _bbsmail\">Inbox</a>";
-		if (letter.location.equalsIgnoreCase("sentbox"))
-			link = "<a action=\"bypass _bbsmail;sentbox\">Sent Box</a>";
-		else if (letter.location.equalsIgnoreCase("archive"))
-			link = "<a action=\"bypass _bbsmail;archive\">Mail Archive</a>";
-		else if (letter.location.equalsIgnoreCase("temparchive"))
-			link = "<a action=\"bypass _bbsmail;temp_archive\">Temporary Mail Archive</a>";
-		link += "&nbsp;&gt;&nbsp;<a action=\"bypass _bbsmail;view;" + letter.letterId + "\">" + letter.subject + "</a>&nbsp;&gt;&nbsp;";
+		String link = letter.location.getBypass() + "&nbsp;&gt;&nbsp;<a action=\"bypass _bbsmail;view;" + letter.letterId + "\">" + letter.subject + "</a>&nbsp;&gt;&nbsp;";
 		content = content.replace("%maillink%", link);
 		
@@ -548,10 +552,10 @@
 					letter.letterId = id;
 					letter.senderId = activeChar.getObjectId();
-					letter.location = "inbox";
+					letter.location = MailType.INBOX;
 					letter.recipientNames = recipients;
 					letter.subject = abbreviate(subject, 128);
 					letter.message = message;
 					letter.sentDate = time;
-					letter.sentDateString = Util.formatDate(letter.sentDate, "yyyy-MM-dd HH:mm");
+					letter.sentDateString = StringUtil.REVERSED_DATE_MM.format(letter.sentDate);
 					letter.unread = true;
 					getPlayerMails(recipId).add(0, letter);
@@ -585,10 +589,10 @@
 				letter.letterId = id;
 				letter.senderId = activeChar.getObjectId();
-				letter.location = "sentbox";
+				letter.location = MailType.SENTBOX;
 				letter.recipientNames = recipients;
 				letter.subject = abbreviate(subject, 128);
 				letter.message = message;
 				letter.sentDate = time;
-				letter.sentDateString = Util.formatDate(letter.sentDate, "yyyy-MM-dd HH:mm");
+				letter.sentDateString = StringUtil.REVERSED_DATE_MM.format(letter.sentDate);
 				letter.unread = false;
 				getPlayerMails(activeChar.getObjectId()).add(0, letter);
@@ -607,5 +611,5 @@
 	}
 	
-	private int getCountLetters(int objId, String location, String sType, String search)
+	private int getCountLetters(int objId, MailType location, String sType, String search)
 	{
 		int count = 0;
@@ -696,5 +700,5 @@
 	}
 	
-	private void setLetterLocation(L2PcInstance activeChar, int letterId, String location)
+	private void setLetterLocation(L2PcInstance activeChar, int letterId, MailType location)
 	{
 		getLetter(activeChar, letterId).location = location;
@@ -703,5 +707,5 @@
 		{
 			PreparedStatement statement = con.prepareStatement(SET_LETTER_LOC);
-			statement.setString(1, location);
+			statement.setString(1, location.toString().toLowerCase());
 			statement.setInt(2, letterId);
 			statement.execute();
@@ -742,30 +746,13 @@
 	private boolean isRecipInboxFull(int charId)
 	{
-		return getCountLetters(charId, "inbox", "", "") >= 100;
+		return getCountLetters(charId, MailType.INBOX, "", "") >= 100;
 	}
 	
 	private void showLastForum(L2PcInstance activeChar)
 	{
-		int page = activeChar.getMailPosition() % 1000;
-		int type = activeChar.getMailPosition() / 1000;
-		
-		switch (type)
-		{
-			case 0:
-				showMailList(activeChar, page, "inbox");
-				break;
-			
-			case 1:
-				showMailList(activeChar, page, "sentbox");
-				break;
-			
-			case 2:
-				showMailList(activeChar, page, "archive");
-				break;
-			
-			case 3:
-				showMailList(activeChar, page, "temparchive");
-				break;
-		}
+		final int page = activeChar.getMailPosition() % 1000;
+		final int type = activeChar.getMailPosition() / 1000;
+		
+		showMailList(activeChar, page, MailType.VALUES[type]);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/RegionBBSManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/RegionBBSManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/RegionBBSManager.java	(revision 345)
@@ -18,4 +18,5 @@
 import java.util.StringTokenizer;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.cache.HtmCache;
 import net.sf.l2j.gameserver.datatables.ClanTable;
@@ -26,12 +27,7 @@
 import net.sf.l2j.gameserver.model.entity.Castle;
 import net.sf.l2j.gameserver.model.entity.ClanHall;
-import net.sf.l2j.gameserver.util.Util;
 
 public class RegionBBSManager extends BaseBBSManager
 {
-	private static final String REGION_LIST = "<table><tr><td width=5></td><td width=160><a action=\"bypass _bbsloc;%castleId%\">%castleName%</a></td><td width=160>%ownerName%</td><td width=160>%allyName%</td><td width=120>%actualTax%</td><td width=5></td></tr></table><br1><img src=\"L2UI.Squaregray\" width=605 height=1><br1>";
-	private static final String CLAN_HALL_BAR = "<br><br><table width=610 bgcolor=A7A19A><tr><td width=5></td><td width=200>Clan Hall Name</td><td width=200>Owning Clan</td><td width=200>Clan Leader Name</td><td width=5></td></tr></table><br1>";
-	private static final String CLAN_HALL_LIST = "<table><tr><td width=5></td><td width=200>%chName%</td><td width=200>%clanName%</td><td width=200>%leaderName%</td><td width=5></td></tr></table><br1><img src=\"L2UI.Squaregray\" width=605 height=1><br1>";
-	
 	protected RegionBBSManager()
 	{
@@ -67,20 +63,14 @@
 	private static void showRegionsList(L2PcInstance activeChar)
 	{
-		String content = HtmCache.getInstance().getHtm(CB_PATH + "region/castlelist.htm");
-		String list = "";
+		final String content = HtmCache.getInstance().getHtm(CB_PATH + "region/castlelist.htm");
 		
+		final StringBuilder sb = new StringBuilder(500);
 		for (Castle castle : CastleManager.getInstance().getCastles())
 		{
 			final L2Clan owner = ClanTable.getInstance().getClan(castle.getOwnerId());
 			
-			list += REGION_LIST;
-			list = list.replace("%castleId%", Integer.toString(castle.getCastleId()));
-			list = list.replace("%castleName%", castle.getName());
-			list = list.replace("%ownerName%", ((owner != null) ? "<a action=\"bypass _bbsclan;home;" + owner.getClanId() + "\">" + owner.getName() + "</a>" : "None"));
-			list = list.replace("%allyName%", ((owner != null && owner.getAllyId() > 0) ? owner.getAllyName() : "None"));
-			list = list.replace("%actualTax%", ((owner != null) ? Integer.toString(castle.getTaxPercent()) : "0"));
+			StringUtil.append(sb, "<table><tr><td width=5></td><td width=160><a action=\"bypass _bbsloc;", castle.getCastleId(), "\">", castle.getName(), "</a></td><td width=160>", ((owner != null) ? "<a action=\"bypass _bbsclan;home;" + owner.getClanId() + "\">" + owner.getName() + "</a>" : "None"), "</td><td width=160>", ((owner != null && owner.getAllyId() > 0) ? owner.getAllyName() : "None"), "</td><td width=120>", ((owner != null) ? castle.getTaxPercent() : "0"), "</td><td width=5></td></tr></table><br1><img src=\"L2UI.Squaregray\" width=605 height=1><br1>");
 		}
-		content = content.replace("%castleList%", list);
-		separateAndSend(content, activeChar);
+		separateAndSend(content.replace("%castleList%", sb.toString()), activeChar);
 	}
 	
@@ -97,12 +87,12 @@
 		content = content.replace("%clanName%", ((owner != null) ? "<a action=\"bypass _bbsclan;home;" + owner.getClanId() + "\">" + owner.getName() + "</a>" : "None"));
 		content = content.replace("%allyName%", ((owner != null && owner.getAllyId() > 0) ? owner.getAllyName() : "None"));
-		content = content.replace("%siegeDate%", Util.formatDate(castle.getSiegeDate().getTimeInMillis(), "yyyy/MM/dd HH:mm"));
+		content = content.replace("%siegeDate%", StringUtil.REVERSED_DATE_MM.format(castle.getSiegeDate().getTimeInMillis()));
 		
-		String list = "";
+		final StringBuilder sb = new StringBuilder(200);
 		
 		final List<ClanHall> clanHalls = ClanHallManager.getInstance().getClanHallsByLocation(castle.getName());
 		if (clanHalls != null && !clanHalls.isEmpty())
 		{
-			list = CLAN_HALL_BAR;
+			sb.append("<br><br><table width=610 bgcolor=A7A19A><tr><td width=5></td><td width=200>Clan Hall Name</td><td width=200>Owning Clan</td><td width=200>Clan Leader Name</td><td width=5></td></tr></table><br1>");
 			
 			for (ClanHall ch : clanHalls)
@@ -110,12 +100,8 @@
 				final L2Clan chOwner = ClanTable.getInstance().getClan(ch.getOwnerId());
 				
-				list += CLAN_HALL_LIST;
-				list = list.replace("%chName%", ch.getName());
-				list = list.replace("%clanName%", ((chOwner != null) ? "<a action=\"bypass _bbsclan;home;" + chOwner.getClanId() + "\">" + chOwner.getName() + "</a>" : "None"));
-				list = list.replace("%leaderName%", ((chOwner != null) ? chOwner.getLeaderName() : "None"));
+				StringUtil.append(sb, "<table><tr><td width=5></td><td width=200>", ch.getName(), "</td><td width=200>", ((chOwner != null) ? "<a action=\"bypass _bbsclan;home;" + chOwner.getClanId() + "\">" + chOwner.getName() + "</a>" : "None"), "</td><td width=200>", ((chOwner != null) ? chOwner.getLeaderName() : "None"), "</td><td width=5></td></tr></table><br1><img src=\"L2UI.Squaregray\" width=605 height=1><br1>");
 			}
 		}
-		content = content.replaceAll("%hallsList%", list);
-		separateAndSend(content, activeChar);
+		separateAndSend(content.replace("%hallsList%", sb.toString()), activeChar);
 	}
 	
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/PostBBSManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/PostBBSManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/PostBBSManager.java	(revision 345)
@@ -26,5 +26,4 @@
 import net.sf.l2j.gameserver.communitybbs.BB.Topic;
 import net.sf.l2j.gameserver.model.actor.instance.L2PcInstance;
-import net.sf.l2j.util.StringUtil;
 
 public class PostBBSManager extends BaseBBSManager
@@ -173,5 +172,5 @@
 	private static void showHtmlEditPost(Topic topic, L2PcInstance activeChar, Forum forum, Post p)
 	{
-		final String html = StringUtil.concat("<html>" + "<body><br><br>" + "<table border=0 width=610><tr><td width=10></td><td width=600 align=left>" + "<a action=\"bypass _bbshome\">HOME</a>&nbsp;>&nbsp;<a action=\"bypass _bbsmemo\">", forum.getName(), " Form</a>" + "</td></tr>" + "</table>" + "<img src=\"L2UI.squareblank\" width=\"1\" height=\"10\">" + "<center>" + "<table border=0 cellspacing=0 cellpadding=0>" + "<tr><td width=610><img src=\"sek.cbui355\" width=\"610\" height=\"1\"><br1><img src=\"sek.cbui355\" width=\"610\" height=\"1\"></td></tr>" + "</table>" + "<table fixwidth=610 border=0 cellspacing=0 cellpadding=0>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=20></td></tr>" + "<tr>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "<td align=center FIXWIDTH=60 height=29>&$413;</td>" + "<td FIXWIDTH=540>", topic.getName(), "</td>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "</tr></table>" + "<table fixwidth=610 border=0 cellspacing=0 cellpadding=0>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr>" + "<tr>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "<td align=center FIXWIDTH=60 height=29 valign=top>&$427;</td>" + "<td align=center FIXWIDTH=540><MultiEdit var =\"Content\" width=535 height=313></td>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "</tr>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr>" + "</table>" + "<table fixwidth=610 border=0 cellspacing=0 cellpadding=0>" + "<tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr>" + "<tr>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "<td align=center FIXWIDTH=60 height=29>&nbsp;</td>" + "<td align=center FIXWIDTH=70><button value=\"&$140;\" action=\"Write Post ", String.valueOf(forum.getID()), ";", String.valueOf(topic.getID()), ";0 _ Content Content Content\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td>" + "<td align=center FIXWIDTH=70><button value = \"&$141;\" action=\"bypass _bbsmemo\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\"> </td>" + "<td align=center FIXWIDTH=400>&nbsp;</td>" + "<td><img src=\"l2ui.mini_logo\" width=5 height=1></td>" + "</tr></table>" + "</center>" + "</body>" + "</html>");
+		final String html = "<html><body><br><br><table border=0 width=610><tr><td width=10></td><td width=600 align=left><a action=\"bypass _bbshome\">HOME</a>&nbsp;>&nbsp;<a action=\"bypass _bbsmemo\">" + forum.getName() + " Form</a></td></tr></table><img src=\"L2UI.squareblank\" width=\"1\" height=\"10\"><center><table border=0 cellspacing=0 cellpadding=0><tr><td width=610><img src=\"sek.cbui355\" width=\"610\" height=\"1\"><br1><img src=\"sek.cbui355\" width=\"610\" height=\"1\"></td></tr></table><table fixwidth=610 border=0 cellspacing=0 cellpadding=0><tr><td><img src=\"l2ui.mini_logo\" width=5 height=20></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=1></td><td align=center FIXWIDTH=60 height=29>&$413;</td><td FIXWIDTH=540>" + topic.getName() + "</td><td><img src=\"l2ui.mini_logo\" width=5 height=1></td></tr></table><table fixwidth=610 border=0 cellspacing=0 cellpadding=0><tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=1></td><td align=center FIXWIDTH=60 height=29 valign=top>&$427;</td><td align=center FIXWIDTH=540><MultiEdit var =\"Content\" width=535 height=313></td><td><img src=\"l2ui.mini_logo\" width=5 height=1></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr></table><table fixwidth=610 border=0 cellspacing=0 cellpadding=0><tr><td><img src=\"l2ui.mini_logo\" width=5 height=10></td></tr><tr><td><img src=\"l2ui.mini_logo\" width=5 height=1></td><td align=center FIXWIDTH=60 height=29>&nbsp;</td><td align=center FIXWIDTH=70><button value=\"&$140;\" action=\"Write Post " + forum.getID() + ";" + topic.getID() + ";0 _ Content Content Content\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td><td align=center FIXWIDTH=70><button value = \"&$141;\" action=\"bypass _bbsmemo\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\"> </td><td align=center FIXWIDTH=400>&nbsp;</td><td><img src=\"l2ui.mini_logo\" width=5 height=1></td></tr></table></center></body></html>";
 		send1001(html, activeChar);
 		send1002(activeChar, p.getCPost(0).postTxt, topic.getName(), DateFormat.getInstance().format(new Date(topic.getDate())));
@@ -188,5 +187,5 @@
 		mes = mes.replace("\n", "<br1>");
 		
-		final String html = StringUtil.concat("<html><body><br><br>" + "<table border=0 width=610><tr><td width=10></td><td width=600 align=left>" + "<a action=\"bypass _bbshome\">HOME</a>&nbsp;>&nbsp;<a action=\"bypass _bbsmemo\">Memo Form</a>" + "</td></tr>" + "</table>" + "<img src=\"L2UI.squareblank\" width=\"1\" height=\"10\">" + "<center>" + "<table border=0 cellspacing=0 cellpadding=0 bgcolor=333333>" + "<tr><td height=10></td></tr>" + "<tr>" + "<td fixWIDTH=55 align=right valign=top>&$413; : &nbsp;</td>" + "<td fixWIDTH=380 valign=top>", topic.getName(), "</td>" + "<td fixwidth=5></td>" + "<td fixwidth=50></td>" + "<td fixWIDTH=120></td>" + "</tr>" + "<tr><td height=10></td></tr>" + "<tr>" + "<td align=right><font color=\"AAAAAA\" >&$417; : &nbsp;</font></td>" + "<td><font color=\"AAAAAA\">", topic.getOwnerName() + "</font></td>" + "<td></td>" + "<td><font color=\"AAAAAA\">&$418; :</font></td>" + "<td><font color=\"AAAAAA\">", dateFormat.format(p.getCPost(0).postDate), "</font></td>" + "</tr>" + "<tr><td height=10></td></tr>" + "</table>" + "<br>" + "<table border=0 cellspacing=0 cellpadding=0>" + "<tr>" + "<td fixwidth=5></td>" + "<td FIXWIDTH=600 align=left>", mes, "</td>" + "<td fixqqwidth=5></td>" + "</tr>" + "</table>" + "<br>" + "<img src=\"L2UI.squareblank\" width=\"1\" height=\"5\">" + "<img src=\"L2UI.squaregray\" width=\"610\" height=\"1\">" + "<img src=\"L2UI.squareblank\" width=\"1\" height=\"5\">" + "<table border=0 cellspacing=0 cellpadding=0 FIXWIDTH=610>" + "<tr>" + "<td width=50>" + "<button value=\"&$422;\" action=\"bypass _bbsmemo\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\">" + "</td>" + "<td width=560 align=right><table border=0 cellspacing=0><tr>" + "<td FIXWIDTH=300></td><td><button value = \"&$424;\" action=\"bypass _bbsposts;edit;", String.valueOf(forum.getID()), ";", String.valueOf(topic.getID()), ";0\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td>&nbsp;" + "<td><button value = \"&$425;\" action=\"bypass _bbstopics;del;", String.valueOf(forum.getID()), ";", String.valueOf(topic.getID()), "\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td>&nbsp;" + "<td><button value = \"&$421;\" action=\"bypass _bbstopics;crea;", String.valueOf(forum.getID()), "\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td>&nbsp;" + "</tr></table>" + "</td>" + "</tr>" + "</table>" + "<br>" + "<br>" + "<br></center>" + "</body>" + "</html>");
+		final String html = "<html><body><br><br><table border=0 width=610><tr><td width=10></td><td width=600 align=left><a action=\"bypass _bbshome\">HOME</a>&nbsp;>&nbsp;<a action=\"bypass _bbsmemo\">Memo Form</a></td></tr></table><img src=\"L2UI.squareblank\" width=\"1\" height=\"10\"><center><table border=0 cellspacing=0 cellpadding=0 bgcolor=333333><tr><td height=10></td></tr><tr><td fixWIDTH=55 align=right valign=top>&$413; : &nbsp;</td><td fixWIDTH=380 valign=top>" + topic.getName() + "</td><td fixwidth=5></td><td fixwidth=50></td><td fixWIDTH=120></td></tr><tr><td height=10></td></tr><tr><td align=right><font color=\"AAAAAA\" >&$417; : &nbsp;</font></td><td><font color=\"AAAAAA\">" + topic.getOwnerName() + "</font></td><td></td><td><font color=\"AAAAAA\">&$418; :</font></td><td><font color=\"AAAAAA\">" + dateFormat.format(p.getCPost(0).postDate) + "</font></td></tr><tr><td height=10></td></tr></table><br><table border=0 cellspacing=0 cellpadding=0><tr><td fixwidth=5></td><td FIXWIDTH=600 align=left>" + mes + "</td><td fixqqwidth=5></td></tr></table><br><img src=\"L2UI.squareblank\" width=\"1\" height=\"5\"><img src=\"L2UI.squaregray\" width=\"610\" height=\"1\"><img src=\"L2UI.squareblank\" width=\"1\" height=\"5\"><table border=0 cellspacing=0 cellpadding=0 FIXWIDTH=610><tr><td width=50><button value=\"&$422;\" action=\"bypass _bbsmemo\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\"></td><td width=560 align=right><table border=0 cellspacing=0><tr><td FIXWIDTH=300></td><td><button value = \"&$424;\" action=\"bypass _bbsposts;edit;" + forum.getID() + ";" + topic.getID() + ";0\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td>&nbsp;<td><button value = \"&$425;\" action=\"bypass _bbstopics;del;" + forum.getID() + ";" + topic.getID() + "\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td>&nbsp;<td><button value = \"&$421;\" action=\"bypass _bbstopics;crea;" + forum.getID() + "\" back=\"l2ui_ch3.smallbutton2_down\" width=65 height=20 fore=\"l2ui_ch3.smallbutton2\" ></td>&nbsp;</tr></table></td></tr></table><br><br><br></center></body></html>";
 		separateAndSend(html, activeChar);
 	}
Index: /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/FriendsBBSManager.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/FriendsBBSManager.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/gameserver/communitybbs/Manager/FriendsBBSManager.java	(revision 345)
@@ -23,4 +23,5 @@
 
 import net.sf.l2j.L2DatabaseFactory;
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.cache.HtmCache;
 import net.sf.l2j.gameserver.datatables.CharNameTable;
@@ -214,46 +215,35 @@
 		final List<Integer> slist = activeChar.getSelectedFriendList();
 		
+		final StringBuilder sb = new StringBuilder();
+		
 		// Friendlist
-		if (list.isEmpty())
-			content = content.replaceAll("%friendslist%", "");
-		else
-		{
-			String friends = "";
-			
-			for (Integer id : list)
-			{
-				if (slist.contains(id))
-					continue;
-				
-				String friendName = CharNameTable.getInstance().getNameById(id);
-				if (friendName == null)
-					continue;
-				
-				L2PcInstance friend = L2World.getInstance().getPlayer(friendName);
-				friends += "<a action=\"bypass _friend;select;" + id + "\">[Select]</a>&nbsp;" + friendName + " " + ((friend != null && friend.isOnline()) ? "(on)" : "(off)") + "<br1>";
-			}
-			
-			content = content.replaceAll("%friendslist%", friends);
-		}
+		for (Integer id : list)
+		{
+			if (slist.contains(id))
+				continue;
+			
+			String friendName = CharNameTable.getInstance().getNameById(id);
+			if (friendName == null)
+				continue;
+			
+			L2PcInstance friend = L2World.getInstance().getPlayer(friendName);
+			StringUtil.append(sb, "<a action=\"bypass _friend;select;", id, "\">[Select]</a>&nbsp;", friendName, " ", ((friend != null && friend.isOnline()) ? "(on)" : "(off)"), "<br1>");
+		}
+		content = content.replaceAll("%friendslist%", sb.toString());
+		
+		// Cleanup sb.
+		sb.setLength(0);
 		
 		// Selected friendlist
-		if (slist.isEmpty())
-			content = content.replaceAll("%selectedFriendsList%", "");
-		else
-		{
-			String selectedFriends = "";
-			
-			for (Integer id : slist)
-			{
-				String friendName = CharNameTable.getInstance().getNameById(id);
-				if (friendName == null)
-					continue;
-				
-				L2PcInstance friend = L2World.getInstance().getPlayer(friendName);
-				selectedFriends += "<a action=\"bypass _friend;deselect;" + id + "\">[Deselect]</a>&nbsp;" + friendName + " " + ((friend != null && friend.isOnline()) ? "(on)" : "(off)") + "<br1>";
-			}
-			
-			content = content.replaceAll("%selectedFriendsList%", selectedFriends);
-		}
+		for (Integer id : slist)
+		{
+			String friendName = CharNameTable.getInstance().getNameById(id);
+			if (friendName == null)
+				continue;
+			
+			L2PcInstance friend = L2World.getInstance().getPlayer(friendName);
+			StringUtil.append(sb, "<a action=\"bypass _friend;deselect;", id, "\">[Deselect]</a>&nbsp;", friendName, " ", ((friend != null && friend.isOnline()) ? "(on)" : "(off)"), "<br1>");
+		}
+		content = content.replaceAll("%selectedFriendsList%", sb.toString());
 		
 		// Delete button.
@@ -273,46 +263,35 @@
 		final List<Integer> slist = activeChar.getSelectedBlocksList();
 		
+		final StringBuilder sb = new StringBuilder();
+		
 		// Blocklist
-		if (list.isEmpty())
-			content = content.replaceAll("%blocklist%", "");
-		else
-		{
-			String selectedBlocks = "";
-			
-			for (Integer id : list)
-			{
-				if (slist.contains(id))
-					continue;
-				
-				String blockName = CharNameTable.getInstance().getNameById(id);
-				if (blockName == null)
-					continue;
-				
-				L2PcInstance block = L2World.getInstance().getPlayer(blockName);
-				selectedBlocks += "<a action=\"bypass _block;select;" + id + "\">[Select]</a>&nbsp;" + blockName + " " + ((block != null && block.isOnline()) ? "(on)" : "(off)") + "<br1>";
-			}
-			
-			content = content.replaceAll("%blocklist%", selectedBlocks);
-		}
+		for (Integer id : list)
+		{
+			if (slist.contains(id))
+				continue;
+			
+			String blockName = CharNameTable.getInstance().getNameById(id);
+			if (blockName == null)
+				continue;
+			
+			L2PcInstance block = L2World.getInstance().getPlayer(blockName);
+			StringUtil.append(sb, "<a action=\"bypass _block;select;", id, "\">[Select]</a>&nbsp;", blockName, " ", ((block != null && block.isOnline()) ? "(on)" : "(off)"), "<br1>");
+		}
+		content = content.replaceAll("%blocklist%", sb.toString());
+		
+		// Cleanup sb.
+		sb.setLength(0);
 		
 		// Selected Blocklist
-		if (slist.isEmpty())
-			content = content.replaceAll("%selectedBlocksList%", "");
-		else
-		{
-			String selectedBlocks = "";
-			
-			for (Integer id : slist)
-			{
-				String blockName = CharNameTable.getInstance().getNameById(id);
-				if (blockName == null)
-					continue;
-				
-				L2PcInstance block = L2World.getInstance().getPlayer(blockName);
-				selectedBlocks += "<a action=\"bypass _block;deselect;" + id + "\">[Deselect]</a>&nbsp;" + blockName + " " + ((block != null && block.isOnline()) ? "(on)" : "(off)") + "<br1>";
-			}
-			
-			content = content.replaceAll("%selectedBlocksList%", selectedBlocks);
-		}
+		for (Integer id : slist)
+		{
+			String blockName = CharNameTable.getInstance().getNameById(id);
+			if (blockName == null)
+				continue;
+			
+			L2PcInstance block = L2World.getInstance().getPlayer(blockName);
+			StringUtil.append(sb, "<a action=\"bypass _block;deselect;", id, "\">[Deselect]</a>&nbsp;", blockName, " ", ((block != null && block.isOnline()) ? "(on)" : "(off)"), "<br1>");
+		}
+		content = content.replaceAll("%selectedBlocksList%", sb.toString());
 		
 		// Delete button.
@@ -328,5 +307,5 @@
 			return;
 		
-		StringBuilder toList = new StringBuilder();
+		final StringBuilder sb = new StringBuilder();
 		for (int id : activeChar.getSelectedFriendList())
 		{
@@ -335,11 +314,11 @@
 				continue;
 			
-			if (toList.length() > 0)
-				toList.append(";");
-			
-			toList.append(friendName);
-		}
-		
-		content = content.replaceAll("%list%", toList.toString());
+			if (sb.length() > 0)
+				sb.append(";");
+			
+			sb.append(friendName);
+		}
+		
+		content = content.replaceAll("%list%", sb.toString());
 		
 		separateAndSend(content, activeChar);
Index: /trunk/aCis_gameserver/java/net/sf/l2j/log/ChatLogFormatter.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/log/ChatLogFormatter.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/log/ChatLogFormatter.java	(revision 345)
@@ -15,10 +15,8 @@
 package net.sf.l2j.log;
 
-import java.text.SimpleDateFormat;
-import java.util.Date;
 import java.util.logging.Formatter;
 import java.util.logging.LogRecord;
 
-import net.sf.l2j.util.StringUtil;
+import net.sf.l2j.commons.lang.StringUtil;
 
 public class ChatLogFormatter extends Formatter
@@ -26,21 +24,22 @@
 	private static final String CRLF = "\r\n";
 	
-	private final SimpleDateFormat dateFmt = new SimpleDateFormat("dd MMM H:mm:ss");
-	
 	@Override
 	public String format(LogRecord record)
 	{
-		Object[] params = record.getParameters();
-		final StringBuilder output = StringUtil.startAppend(30 + record.getMessage().length() + (params != null ? 10 * params.length : 0), "[", dateFmt.format(new Date(record.getMillis())), "] ");
+		final StringBuilder sb = new StringBuilder();
 		
-		if (params != null)
+		StringUtil.append(sb, "[", StringUtil.DATE_SS.format(record.getMillis()), "] ");
+		
+		for (Object p : record.getParameters())
 		{
-			for (Object p : params)
-				StringUtil.append(output, String.valueOf(p), " ");
+			if (p == null)
+				continue;
+			
+			StringUtil.append(sb, p, " ");
 		}
 		
-		StringUtil.append(output, record.getMessage(), CRLF);
+		StringUtil.append(sb, record.getMessage(), CRLF);
 		
-		return output.toString();
+		return sb.toString();
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/log/FileLogFormatter.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/log/FileLogFormatter.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/log/FileLogFormatter.java	(revision 345)
@@ -15,10 +15,8 @@
 package net.sf.l2j.log;
 
-import java.text.SimpleDateFormat;
-import java.util.Date;
 import java.util.logging.Formatter;
 import java.util.logging.LogRecord;
 
-import net.sf.l2j.util.StringUtil;
+import net.sf.l2j.commons.lang.StringUtil;
 
 public class FileLogFormatter extends Formatter
@@ -26,10 +24,9 @@
 	private static final String CRLF = "\r\n";
 	private static final String SPACE = "\t";
-	private final SimpleDateFormat dateFmt = new SimpleDateFormat("yyyy.MM.dd HH:mm:ss,SSS");
 	
 	@Override
 	public String format(LogRecord record)
 	{
-		return StringUtil.concat(dateFmt.format(new Date(record.getMillis())), SPACE, record.getLevel().getName(), SPACE, String.valueOf(record.getThreadID()), SPACE, record.getLoggerName(), SPACE, record.getMessage(), CRLF);
+		return StringUtil.DATE_SS.format(record.getMillis()) + SPACE + record.getLevel().getName() + SPACE + record.getThreadID() + SPACE + record.getLoggerName() + SPACE + record.getMessage() + CRLF;
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/log/ItemLogFormatter.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/log/ItemLogFormatter.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/log/ItemLogFormatter.java	(revision 345)
@@ -15,11 +15,9 @@
 package net.sf.l2j.log;
 
-import java.text.SimpleDateFormat;
-import java.util.Date;
 import java.util.logging.Formatter;
 import java.util.logging.LogRecord;
 
+import net.sf.l2j.commons.lang.StringUtil;
 import net.sf.l2j.gameserver.model.item.instance.ItemInstance;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -29,11 +27,11 @@
 {
 	private static final String CRLF = "\r\n";
-	private final SimpleDateFormat dateFmt = new SimpleDateFormat("dd MMM H:mm:ss");
 	
 	@Override
 	public String format(LogRecord record)
 	{
-		final Object[] params = record.getParameters();
-		final StringBuilder output = StringUtil.startAppend(30 + record.getMessage().length() + params.length * 50, "[", dateFmt.format(new Date(record.getMillis())), "] ", record.getMessage());
+		final StringBuilder sb = new StringBuilder();
+		
+		StringUtil.append(sb, "[", StringUtil.DATE_SS.format(record.getMillis()), "] ", record.getMessage());
 		
 		for (Object p : record.getParameters())
@@ -41,24 +39,22 @@
 			if (p == null)
 				continue;
-			output.append(", ");
+			
+			sb.append(", ");
 			if (p instanceof ItemInstance)
 			{
-				ItemInstance item = (ItemInstance) p;
-				StringUtil.append(output, "item ", String.valueOf(item.getObjectId()), ":");
+				final ItemInstance item = (ItemInstance) p;
+				
+				StringUtil.append(sb, "item ", item.getObjectId(), ":");
 				if (item.getEnchantLevel() > 0)
-				{
-					StringUtil.append(output, "+", String.valueOf(item.getEnchantLevel()), " ");
-				}
+					StringUtil.append(sb, "+", item.getEnchantLevel(), " ");
 				
-				StringUtil.append(output, item.getItem().getName(), "(", String.valueOf(item.getCount()), ")");
+				StringUtil.append(sb, item.getItem().getName(), "(", item.getCount(), ")");
 			}
-			// else if (p instanceof L2PcInstance)
-			// output.append(((L2PcInstance)p).getName());
 			else
-				output.append(p.toString()/* + ":" + ((L2Object)p).getObjectId() */);
+				sb.append(p.toString());
 		}
-		output.append(CRLF);
+		sb.append(CRLF);
 		
-		return output.toString();
+		return sb.toString();
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/log/ConsoleLogFormatter.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/log/ConsoleLogFormatter.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/log/ConsoleLogFormatter.java	(revision 345)
@@ -18,5 +18,5 @@
 import java.util.logging.LogRecord;
 
-import net.sf.l2j.util.StringUtil;
+import net.sf.l2j.commons.lang.StringUtil;
 
 public class ConsoleLogFormatter extends Formatter
@@ -27,6 +27,7 @@
 	public String format(LogRecord record)
 	{
-		final StringBuilder output = new StringBuilder(500);
-		StringUtil.append(output, record.getMessage(), CRLF);
+		final StringBuilder sb = new StringBuilder(500);
+		
+		StringUtil.append(sb, record.getMessage(), CRLF);
 		
 		if (record.getThrown() != null)
@@ -34,5 +35,5 @@
 			try
 			{
-				StringUtil.append(output, record.getThrown().getMessage(), CRLF);
+				StringUtil.append(sb, record.getThrown().getMessage(), CRLF);
 			}
 			catch (Exception ex)
@@ -40,5 +41,5 @@
 			}
 		}
-		return output.toString();
+		return sb.toString();
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/log/AuditFormatter.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/log/AuditFormatter.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/log/AuditFormatter.java	(revision 345)
@@ -15,10 +15,8 @@
 package net.sf.l2j.log;
 
-import java.text.SimpleDateFormat;
-import java.util.Date;
 import java.util.logging.Formatter;
 import java.util.logging.LogRecord;
 
-import net.sf.l2j.util.StringUtil;
+import net.sf.l2j.commons.lang.StringUtil;
 
 /**
@@ -28,23 +26,22 @@
 {
 	private static final String CRLF = "\r\n";
-	private final SimpleDateFormat dateFmt = new SimpleDateFormat("dd MMM H:mm:ss");
 	
 	@Override
 	public String format(LogRecord record)
 	{
-		final Object[] params = record.getParameters();
-		final StringBuilder output = StringUtil.startAppend(30 + record.getMessage().length() + (params == null ? 0 : params.length * 10), "[", dateFmt.format(new Date(record.getMillis())), "] ", record.getMessage());
-		if (params != null)
+		final StringBuilder sb = new StringBuilder();
+		
+		StringUtil.append(sb, "[", StringUtil.DATE_SS.format(record.getMillis()), "] ", record.getMessage());
+		
+		for (Object p : record.getParameters())
 		{
-			for (Object p : params)
-			{
-				if (p == null)
-					continue;
-				
-				StringUtil.append(output, ", ", p.toString());
-			}
+			if (p == null)
+				continue;
+			
+			StringUtil.append(sb, ", ", p.toString());
 		}
-		output.append(CRLF);
-		return output.toString();
+		
+		sb.append(CRLF);
+		return sb.toString();
 	}
 }
Index: /trunk/aCis_gameserver/java/net/sf/l2j/Config.java
===================================================================
--- /trunk/aCis_gameserver/java/net/sf/l2j/Config.java	(revision 344)
+++ /trunk/aCis_gameserver/java/net/sf/l2j/Config.java	(revision 345)
@@ -33,5 +33,4 @@
 import net.sf.l2j.gameserver.model.holder.BuffSkillHolder;
 import net.sf.l2j.gameserver.model.holder.ItemHolder;
-import net.sf.l2j.util.StringUtil;
 
 /**
@@ -1054,6 +1053,6 @@
 			EVERYBODY_HAS_ADMIN_RIGHTS = players.getProperty("EverybodyHasAdminRights", false);
 			MASTERACCESS_LEVEL = players.getProperty("MasterAccessLevel", 127);
-			MASTERACCESS_NAME_COLOR = Integer.decode(StringUtil.concat("0x", players.getProperty("MasterNameColor", "00FF00")));
-			MASTERACCESS_TITLE_COLOR = Integer.decode(StringUtil.concat("0x", players.getProperty("MasterTitleColor", "00FF00")));
+			MASTERACCESS_NAME_COLOR = Integer.decode("0x" + players.getProperty("MasterNameColor", "00FF00"));
+			MASTERACCESS_TITLE_COLOR = Integer.decode("0x" + players.getProperty("MasterTitleColor", "00FF00"));
 			GM_HERO_AURA = players.getProperty("GMHeroAura", false);
 			GM_STARTUP_INVULNERABLE = players.getProperty("GMStartupInvulnerable", true);
@@ -1405,5 +1404,5 @@
 			if (valueSplit.length != 2)
 			{
-				_log.warning(StringUtil.concat("parseItemsList[Config.load()]: invalid entry -> \"", valueSplit[0], "\", should be itemId,itemNumber"));
+				_log.warning("parseItemsList[Config.load()]: invalid entry -> \"" + valueSplit[0] + "\", should be itemId,itemNumber");
 				return null;
 			}
@@ -1416,5 +1415,5 @@
 			catch (NumberFormatException e)
 			{
-				_log.warning(StringUtil.concat("parseItemsList[Config.load()]: invalid itemId -> \"", valueSplit[0], "\""));
+				_log.warning("parseItemsList[Config.load()]: invalid itemId -> \"" + valueSplit[0] + "\"");
 				return null;
 			}
@@ -1426,5 +1425,5 @@
 			catch (NumberFormatException e)
 			{
-				_log.warning(StringUtil.concat("parseItemsList[Config.load()]: invalid item number -> \"", valueSplit[1], "\""));
+				_log.warning("parseItemsList[Config.load()]: invalid item number -> \"" + valueSplit[1] + "\"");
 				return null;
 			}
